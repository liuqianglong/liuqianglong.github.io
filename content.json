{"meta":{"title":"LiuQianglong's Blog","subtitle":"我的学习笔记","description":"关于网络、AWS、Python的学习笔记","author":"LiuQianglong","url":"https://liuqianglong.com"},"pages":[],"posts":[{"title":"Cisco ISE Posture 结合 SSLVPN","slug":"Cisco-ISE-Posture-结合-SSLVPN","date":"2021-02-03T10:44:42.000Z","updated":"2021-02-04T02:25:12.845Z","comments":true,"path":"Cisco-ISE-Posture-结合-SSLVPN.html","link":"","permalink":"https://liuqianglong.com/Cisco-ISE-Posture-%E7%BB%93%E5%90%88-SSLVPN.html","excerpt":"","text":"详细描述了思科ISE Posture结合ASA SSLVPN的场景。员工使用AnyConnect拨号到公司内网时，需要通过思科ISE Posture检测，检测通过才能访问内网，否则访问权限受到控制。 一、Cisco ISE Posure介绍1.1、Posture简介思科的ISE Posture提供了网络准入的功能，也就是当员工的电脑只有满足合规条件时才能接入到公司网络。这里可以针对Windows和MacOS自定义各种类型的条件，以Windows为例，条件可以是：系统必须开启防火墙；系统必须开启BitLocker；系统必须拥有最新的补丁等。满足这些条件才能接入到公司网络，这里网络可以是有线、无线、VPN。这次实验场景就是当员工使用AnyConnect接入到公司网络时，Posture模块只会允许满足条件的电脑接入网络。 另外思科针对VPN的准入，也可以利用HostScan进行扫描，HostScan可以集成在AnyConnect模块中，不需要安装单独的模块，但是检测的能力不如安装了Posture模块的客户端。针对HostSan的准入检测，我会在其他实验演示。 1.2、Posture部署模式介绍Posture的关键是需要收集到客户端的系统信息，那么客户端上必须要有某种采集信息的代理，ISE2.4提供了3种类型的部署方式： 1.2.1 AnyConnect这种是最常用的安装方式，会在电脑上安装Posure模块，安装之后AnyConnect软件会多出一个模块。这种部署方式拥有Posture全功能的监测，本次实验也是这种部署方式。注意，这种部署方式需要ISE 拥有Apex授权，AnyConnect拥有Apex授权。 1.2.2 Stealth AnyConnect（隐形模式）Stealth AnyConnect和AnyConnect模式几乎一样，也会永久安装在客户端上，如果你单独安装Stealth AnyConnect，那么它是没有UI界面的，所以叫隐形模式。但是如果你安装了AMP或者VPN模块，那么将会看到UI界面。所以如果你要用在VPN准入上，这种模式不太适合，因为必然会出现UI界面。这种模式更加适合企业内网无线或者有线的准入，但是不想让用户看见UI界面的场景。 1.2.3 Temporal Agent（临时客户端）Temporal Agent是一个比较新的特性，它不会在客户端电脑上永久安装软件，但是显然检测能力是不如上面两种模式的。比较适合给访客和供应商作为临时的监测方式。 1.2.4 Windows Posture 支持检测特性 Temporal Agent Stealth AnyConnect AnyConnect Posture Conditions Supported Conditions: • AM Installation• Firewall Installation• Application Inventory• Hardware Inventory• USB Check• AV Installation• AV version / date• AS Installation• AS version / date• Application / File Check• Service packs / Hotfixes• Process / Registry Check Supported Conditions:• AM Installation• Firewall Installation• Application Inventory• Hardware Inventory• USB Check• AV Installation• AV version / date• AS Installation• AS version / date• Application / File Check• Service packs / Hotfixes• Process / Registry Check• Patch Management• Disk Encryption• Service Condition• Registry Condition• Dictionary Condition Supported Conditions: • AM Installation• Firewall Installation• Application Inventory• Hardware Inventory• USB Check• AV Installation• AV version / date• AS Installation• AS version / date• Application / File Check• Service packs / Hotfixes• Process / Registry Check• Patch Management• Disk Encryption• Service Condition• Registry Condition• Dictionary Condition Remediation Actions Manual Remediations Partial Automatic Remediation:File, Link, WSUS Show UI, PM activate UI, Message Text. Manual remediation not supported. Both Automatic and Manual Remediation supported Passive Reassessment None Supported Supported 1.2.5 macOS Posture 支持检测特性 Temporal Agent Stealth AnyConnect AnyConnect Posture Conditions Unsupported Conditions:• Service Condition-macOS—System Daemon check• Service Condition-macOS—Daemon or User Agent check• PM—Up to Date check• PM—Enabled check• DE—Encryption Location based check Supported Conditions:• AM Installation• Firewall Enabled• Application Inventory• Hardware Inventory• AV Installation• AV version / date• AS Installation• AS version / date• Application Check• Plist Check• File Check• Patch Management• Service packs / Hotfixes• Disk Encryption• Service Condition• Dictionary Condition Supported Conditions:• AM Installation• Firewall Enabled• Application Inventory• Hardware Inventory• AV Installation• AV version / date• AS Installation• AS version / date• Application Check• Plist Check• File Check• Patch Management• Service packs / Hotfixes• Disk Encryption• Service Condition• Dictionary Condition Remediation Actions Not Supported Unsupported: Manual, Launch program, File condition, Patch management, USB Unsupported: Manual, Launch program, File condition, Patch management, USB Passive Reassessment Not Supported Not Supported Not Supported 二、实验介绍2.1、实验注意事项 ISE Posture功能需要Apex授权，这里实验环境使用ISE的默认90天测试授权。 ASA AnyConnect也需要有Apex授权，这里实验环境依然用的自带测试授权。 客户端需要信任ISE Posture的证书，如果ISE是自签名证书，客户端需要导入ISE证书。 建议管理员离线为用户安装好ISE Posure模块，可以避免很多问题。重定向到安装页面，让用户自行下载会遇到各种用户无法处理的问题。 2.2、实验需求用户使用AnyConnect拨号时，需要满足下面条件才能接入，如果不满足合规条件，用户只能访问到隔离网络内的补丁服务器。如果用户电脑未安装Posture模块，当用户首次拨号成功后，页面会重定向到Posture安装页面，用户可以自行下载模块进行安装。 Windows必须开启防火墙功能。 Windows必须开启了BitLocker功能。 Windows在C盘根目录下必须要有test.txt文件。 Windows必须安装最新的补丁文件。 2.3、实验环境介绍本次实验在vSphere环境下进行，ASAv和ISE均是默认的测试授权，ASAv测试授权有限速100k的问题，所以客户端打开Posture重定向网页比较困难，这里我为客户度手动安装Posture客户端。当客户端为通过合规检查时，只能访问ISE、AD、Update Server，不能访问其他服务器。通过合规检测之后允许访问所有网络。 2.4、实验步骤配置整体分为2个部分，ISE Posture的配置和ASA SSLVPN的配置，这里聚焦的核心是ISE Posture配置。 2.4.1 ISE 配置步骤 配置Posture推送策略：当用户未安装Posture客户端拨入VPN时，需要为不同的系统推送不同的Posure Agent。 定义合规检测策略：也就是定义客户端具体需要满足的策略，只有满足这些对应的策略才能接入网络。如果用户账号具有管理员权限也可以定义修复策略，例如Posture自动为客户端打开防火墙。 配置授权策略：ISE为3种状态的客户端给与不同的授权。Unknown状态，重定向到客户端下载页面。Compliant状态，正常授权。Noncompliant状态，授权ACL限制网络访问。 2.4.2 ASA配置步骤ASA上需要注意必须启用CoA（Change of Authorization）功能。CoA提供了在身份验证通过之后更改授权信息的机制，这个场景中，当客户端从不合规状态变为合规状态后，ISE会下发新的授权信息到ASA上。思科使用UDP 1700端口，RFC 5176使用UDP 3799端口。 ASA基础配置，本次实验并不涉及具体的ASA基础配置操作。 ASA SSLVPN配置，这里会主要介绍关于与Posture结合的特殊配置。 三、ISE Posture 配置3.1、配置ISE Posture推送策略 为客户端推送Posture模块默认是禁用的，会依据授权来判断是否推送 从Cisco网站下载最新的文件 下载最新的Windows合规检测模块 AnyConnect现在是单独产品线，不能通过在线直接下载。AnyConnect官网下载地址，文件名称为anyconnect-win-4.9.05042-webdeploy-k9.pkg现在下载AnyConnect需要有CCO权限才能下载，最新版AnyConnect可能不太，但是说是一下旧版本还是比较容易找到的，这里只需要4.x版本即可，并不需要最新版本。 这里通过本地文件上传到ISE。 创建AnyConnect Posture Profile 这里开启Enable Rescan Button允许客户端重新扫描。 允许访问所有网站。##？？ 添加AnyConnect Configure 选择AnyConnect客户端文件、合规性检测文件、ISE Posture配置文件。 创建Client Provisioning Policy 3.2、定义合规检测策略 定义Window Patch检测策略，Posture模块可以通过Windows Update Agent或者System Center Configuration Manager Client（SCCM Client）方式检测Patch是否合规。如果选择Windows Update Agent方式检测，那么需要确保客户端VPN拨号之后能访问Window更新服务器，如果企业内部署了WSUS等服务器，需要让客户端能访问到WSUS服务器。如果选择SCCM Client方式检测，同样需要确保客户端能和SCCM的DP分发点通信。 这里可以有3种类型的监测方式，Installation表示客户端是否安装了对应的程序，Enabled表示客户端是否激活了程序，Up to Date表示客户端是否拥有最新的文件。这3种监测方式时间递增，监测是否安装速度非常快，监测是否拥有最新的补丁文件速度会慢很多。如果你选择Up to Date，那么你还可以选择监测具体哪类安全级别的补丁需要安装。一般选择Important &amp; critical即可。 检测C盘必须开启BitLocker。这里检测Windows系统，使用4.x以后的合规性检测模块，加密厂商选择微软。BitLocker检测可以检测指定的盘符，也可以指定全盘开启。 配置文件检测策略，这里检测指定目录下文件是否存在。还可以检测文件的创建时间、SHA-256值等信息。 可以利用自带的防火墙检测条件。 这里定义防火墙的Remediation策略，即当用户电脑不合规之后Posture采取的动作，例如可以给用户发送文本消息告诉用户具体哪个地方未合规。也可以配置响应的动作，自动帮助客户端修复。这里Posture可以自动帮助客户端打开防火墙策略，但是需要用户使用管理员账号登录，也就是用户账号要有权限能开启防火墙。 这里定义Window Patch不合规时自动修复。 配置合规条件，调用上面定义的各种条件。当BitLocker和文件检测未通过时，给客户端文本提示信息；当防火墙和Patch检测未通过时，Posture模块进行自动修复。 3.3、配置授权策略需要为3种不同状态的客户端下发不同的授权，未安装Posture模块的客户端下发重定向授权；合规性检测未通过的客户端下发DACL限制网络访问；合规性检测通过的客户端下发正常访问授权。 为没有安装Posture的客户端创建授权策略。 选择网页重定向模板为Client Provisioning(Posture)，这里使用默认的模板，你也可以去修改模板或者创建新的模板。下发重定向ACLPosture_Redirect_ACL，这里只是推送了重定向ACL的名字，所以需要在ASA上创建同名的重定向ACL内容。 创建DACL，限制未合规的客户端访问网络。 一般只允许访问DNS服务、补丁服务器，不允许访问其他内网服务器。这个ACL内容会推送到ASA上，并不需要在ASA上创建同名的ACL列表。 创建授权策略，调用DACL。 ISE可以推送指定group-policy到ASA上，这里演示一下。注意推送的只是group-policy名字，对应的group-policy内容需要在ASA上创建。 创建网络设备，指定与ASA的Radius共享密钥。 ISE创建本地用户用于AnyConnect拨号认证。 ISE创建Policy Set，这里条件可以自己定义。 创建授权策略，这里条件内一定要包含PostureStatus信息，依据3种不同的PostureStatus状态给客户端对应的授权。 四、ASA 配置4.1、ASA 基础配置 这里ASA是空配状态进行的，进行了地址初始化，配置了SSH登录，配置了ASDM登录。 12345678910111213141516interface GigabitEthernet0&#x2F;0 nameif inside security-level 100 ip address 172.20.29.145 255.255.255.0!interface GigabitEthernet0&#x2F;1 nameif outside security-level 0 ip address 52.94.8.18 255.255.255.0ssh 0.0.0.0 0.0.0.0 insidehttp server enable 8443http 0 0 insideaaa authentication http console LOCALusername admin password cisco privilege 15 通过ASDM上传AnyConnect文件到磁盘下。 1234asa# dirDirectory of disk0:&#x2F;83 -rwx 76380273 13:33:46 Feb 02 2021 anyconnect-win-4.9.05042-webdeploy-k9.pkg 4.1、SSLVPN 配置 配置webvpn，激活AnyConnect拨号。 1234webvpn enable outside anyconnect enable anyconnect image disk0:&#x2F;anyconnect-win-4.9.05042-webdeploy-k9.pkg 当客户端访问内网时，地址转换为ASA的inside接口地址。（这并不是必须的操作，这里只是为了省略解决内网路由的问题） 123object network anyconnect_pool_object subnet 192.168.100.0 255.255.255.0nat (outside,inside) source dynamic anyconnect_pool_object interface ASA CoA和重定向列表，这应该是最不同与传统SSLVPN的配置。 COA：当ISE感知到客户端从非合规状态变为合规状态时会下发新的授权，ASA只有启用的CoA功能才能使用新的授权信息。 重定向列表：初看上去很难理解具体的含义，这里你需要重新理解permit和deny的含义。这里的deny表示抓取的流量不会被重定向，permit表示抓取的流量会被重定向。这里的含义是去往DNS、ISE、DC的流量不要被重定向，客户端可以正常去往这里流量。但是其他所有流量都会被重定向。这里重定向列表一定要明白具体含义，否则很容易出现无限循环重定向。 1234567891011121314aaa-server ISE protocol radius authorize-only interim-accounting-update periodic 1 merge-dacl before-avpair dynamic-authorization aaa-server ISE (inside) host 172.20.29.140 key cisco authentication-port 1812 access-list Posture_Redirect_ACL extended deny udp any any eq domainaccess-list Posture_Redirect_ACL extended deny ip any host 172.20.29.140access-list Posture_Redirect_ACL extended deny ip any host 172.20.29.150access-list Posture_Redirect_ACL extended permit ip any any 下面就是SSLVPN的常规配置了，这里使用了SSLVPN的默认tunnel-group。 12345678910111213ip local pool sslvpn_client_pool 192.168.100.100-192.168.100.200 mask 255.255.255.255group-policy employee-group-policy internalgroup-policy employee-group-policy attributes dns-server value 172.20.29.150 vpn-tunnel-protocol ssl-client default-domain value liuqianglong.com address-pools value sslvpn_client_pooltunnel-group DefaultWEBVPNGroup general-attributes authentication-server-group ISE authorization-server-group ISE 五、AnyConnect 拨号测试5.1、客户端安装Posture模块 这里ASA没有配置隧道分隔，所以客户端所有流量都会经过AnyConnect，AnyConnect会主动触发一个HTTP流量去访问http://www.msftconnecttest.com/redirect，让页面重定向到ISE Posture下载页面。如果配置了隧道分隔，需要用户主动访问一个内网服务器触发重定向，才会显示下面的页面。这里跟随向导前进即可。 检测是否安装AnyConnect Posture模块 下载这个临时代理软件，这个并不是最终的ISE Posture模块，下载之后记得备份这个软件，因为如果安装不成功这个临时代理会自动删除，你又需要重新下载一次。 这里客户端和ISE在进行证书认证，所以如果你的ISE是自签名证书，那么需要导出ISE的自签名证书，导入到客户端才能顺利通过认证。我这里的ISE实验环境显然是自签名证书，所以需要进行导入证书操作。 客户端一定要信任ISE证书之后再进行后面的操作，否则你可能会看到各种报错界面。这是其中一种报错界面。如果客户端已经信任ISE Posture证书了，那么可以忽略后面导入证书的操作。 如果出现这个报错也是客户端不信任ISE Posture证书导致的。The requirement cannot be evaluated since you are connected to an untrusted server. Please contact your system adminitrator. 5.2、客户端导入ISE证书 在ISE上导出自签名证书，导出的是.pem文件，你可以用各种方式将文件传输到客户端上，客户端上修改文件后缀为.cer即可安装证书。 客户端需要将证书同时导入到当前用户和本地计算机。 导入到「受信任的根证书颁发机构」。 导入之后客户端会信任ISE Posure证书，即可正常通信。 代理软件继续下载ISE Posture模块。 因为ASAv测试license限速100k，所以这里我离线手动安装ISE Posture模块，在线下载Posture模块速度太慢。这个下载链接依然需要CCO账号，与上面AnyConnect下载是同一个链接。 安装成功后AnyConnect UI多出一个System Scan模块。 拨号成功后，Posure会下载ISE提供的Windows合规扫描模块。 5.3、客户端合规性检测5.3.1 合规性监测失败页面展示 客户端未开启防火墙。 客户端C盘根目录下没有test.txt这个文件。 客户端C盘未开启BitLocker。 当Window Update未通过时，因为配置了Remediation，所以系统会尝试下载最新的Patch文件。这里一定要确认客户端能访问Window Update服务器，在前面配置检测策略时已经详细说过了。 5.3.2 客户端进行合规检查时授权信息 此时客户端正在检查BitLocker是否开启，一共有5分钟的监测时间，在此期间内客户端状态为Unknow，所以流量受到重定向列表管控。 查看用户获取的具体授权信息，最下面可以看到用户获取的重定向列表。 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778asa# show vpn-sessiondb detail anyconnect filter Filter criteria sort Sort Criteria | Output modifiers &lt;cr&gt;asa# show vpn-sessiondb detail anyconnectSession Type: AnyConnect DetailedUsername : ssluser Index : 36Assigned IP : 192.168.100.101 Public IP : 52.94.8.10Protocol : AnyConnect-Parent SSL-Tunnel DTLS-TunnelLicense : AnyConnect PremiumEncryption : AnyConnect-Parent: (1)none SSL-Tunnel: (1)AES-GCM-256 DTLS-Tunnel: (1)AES256Hashing : AnyConnect-Parent: (1)none SSL-Tunnel: (1)SHA384 DTLS-Tunnel: (1)SHA1Bytes Tx : 63439 Bytes Rx : 21404Pkts Tx : 128 Pkts Rx : 174Pkts Tx Drop : 0 Pkts Rx Drop : 0Group Policy : employee-group-policy Tunnel Group : DefaultWEBVPNGroupLogin Time : 10:13:17 UTC Wed Feb 3 2021Duration : 0h:00m:46sInactivity : 0h:00m:00sVLAN Mapping : N&#x2F;A VLAN : noneAudt Sess ID : ac141d9100024000601a773dSecurity Grp : noneAnyConnect-Parent Tunnels: 1SSL-Tunnel Tunnels: 1DTLS-Tunnel Tunnels: 1AnyConnect-Parent: Tunnel ID : 36.1 Public IP : 52.94.8.10 Encryption : none Hashing : none TCP Src Port : 49367 TCP Dst Port : 443 Auth Mode : userPassword Idle Time Out: 30 Minutes Idle TO Left : 29 Minutes Client OS : win Client OS Ver: 10.0.19041 Client Type : AnyConnect Client Ver : Cisco AnyConnect VPN Agent for Windows 4.9.05042 Bytes Tx : 7699 Bytes Rx : 0 Pkts Tx : 5 Pkts Rx : 0 Pkts Tx Drop : 0 Pkts Rx Drop : 0SSL-Tunnel: Tunnel ID : 36.2 Assigned IP : 192.168.100.101 Public IP : 52.94.8.10 Encryption : AES-GCM-256 Hashing : SHA384 Ciphersuite : ECDHE-ECDSA-AES256-GCM-SHA384 Encapsulation: TLSv1.2 TCP Src Port : 49379 TCP Dst Port : 443 Auth Mode : userPassword Idle Time Out: 30 Minutes Idle TO Left : 29 Minutes Client OS : Windows Client Type : SSL VPN Client Client Ver : Cisco AnyConnect VPN Agent for Windows 4.9.05042 Bytes Tx : 16382 Bytes Rx : 7801 Pkts Tx : 39 Pkts Rx : 67 Pkts Tx Drop : 0 Pkts Rx Drop : 0DTLS-Tunnel: Tunnel ID : 36.3 Assigned IP : 192.168.100.101 Public IP : 52.94.8.10 Encryption : AES256 Hashing : SHA1 Ciphersuite : AES256-SHA Encapsulation: DTLSv1.0 UDP Src Port : 58772 UDP Dst Port : 443 Auth Mode : userPassword Idle Time Out: 30 Minutes Idle TO Left : 29 Minutes Client OS : Windows Client Type : DTLS VPN Client Client Ver : Cisco AnyConnect VPN Agent for Windows 4.9.05042 Bytes Tx : 39358 Bytes Rx : 13603 Pkts Tx : 84 Pkts Rx : 107 Pkts Tx Drop : 0 Pkts Rx Drop : 0ISE Posture: Redirect URL : https:&#x2F;&#x2F;ise26.liuqianglong.com:8443&#x2F;portal&#x2F;gateway?sessionId&#x3D;ac141d9100024000601a773d&amp;portal&#x3D;27b1bc30-... Redirect ACL : Posture_Redirect_ACL 可以查看重定向列表的流量匹配情况。 12345678asa# show access-listaccess-list cached ACL log flows: total 0, denied 0 (deny-flow-max 4096) alert-interval 300access-list Posture_Redirect_ACL; 4 elements; name hash: 0xcadb04eaaccess-list Posture_Redirect_ACL line 1 extended deny udp any any eq domain (hitcnt&#x3D;4294) 0x99c9a32caccess-list Posture_Redirect_ACL line 2 extended deny ip any host 172.20.29.140 (hitcnt&#x3D;2184) 0x2bb72c86access-list Posture_Redirect_ACL line 3 extended deny ip any host 172.20.29.150 (hitcnt&#x3D;0) 0xaf71d144access-list Posture_Redirect_ACL line 4 extended permit ip any any (hitcnt&#x3D;5) 0xd1910f22 在客户端上测试网络连通性，此时客户端只能访问DNS、172.20.29.140、172.20.29.150的流量，除此之外的HTTP流量都会被重定向到ISE上。 5.3.3 客户端未通过合规性检测时的授权信息 例如此时合规性检测确认失败。 ASA上查看用户授权信息，最后一行可以看到DACL信息，此时客户端访问网络受到DACL的限制。 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970asa# show vpn-sessiondb detail anyconnectSession Type: AnyConnect DetailedUsername : ssluser Index : 36Assigned IP : 192.168.100.101 Public IP : 52.94.8.10Protocol : AnyConnect-Parent SSL-Tunnel DTLS-TunnelLicense : AnyConnect PremiumEncryption : AnyConnect-Parent: (1)none SSL-Tunnel: (1)AES-GCM-256 DTLS-Tunnel: (1)AES256Hashing : AnyConnect-Parent: (1)none SSL-Tunnel: (1)SHA384 DTLS-Tunnel: (1)SHA1Bytes Tx : 69643 Bytes Rx : 34502Pkts Tx : 172 Pkts Rx : 240Pkts Tx Drop : 0 Pkts Rx Drop : 0Group Policy : employee-group-policy Tunnel Group : DefaultWEBVPNGroupLogin Time : 10:13:17 UTC Wed Feb 3 2021Duration : 0h:02m:44sInactivity : 0h:00m:00sVLAN Mapping : N&#x2F;A VLAN : noneAudt Sess ID : ac141d9100024000601a773dSecurity Grp : noneAnyConnect-Parent Tunnels: 1SSL-Tunnel Tunnels: 1DTLS-Tunnel Tunnels: 1AnyConnect-Parent: Tunnel ID : 36.1 Public IP : 52.94.8.10 Encryption : none Hashing : none TCP Src Port : 49367 TCP Dst Port : 443 Auth Mode : userPassword Idle Time Out: 30 Minutes Idle TO Left : 27 Minutes Client OS : win Client OS Ver: 10.0.19041 Client Type : AnyConnect Client Ver : Cisco AnyConnect VPN Agent for Windows 4.9.05042 Bytes Tx : 7699 Bytes Rx : 0 Pkts Tx : 5 Pkts Rx : 0 Pkts Tx Drop : 0 Pkts Rx Drop : 0SSL-Tunnel: Tunnel ID : 36.2 Assigned IP : 192.168.100.101 Public IP : 52.94.8.10 Encryption : AES-GCM-256 Hashing : SHA384 Ciphersuite : ECDHE-ECDSA-AES256-GCM-SHA384 Encapsulation: TLSv1.2 TCP Src Port : 49379 TCP Dst Port : 443 Auth Mode : userPassword Idle Time Out: 30 Minutes Idle TO Left : 27 Minutes Client OS : Windows Client Type : SSL VPN Client Client Ver : Cisco AnyConnect VPN Agent for Windows 4.9.05042 Bytes Tx : 16382 Bytes Rx : 7801 Pkts Tx : 39 Pkts Rx : 67 Pkts Tx Drop : 0 Pkts Rx Drop : 0 Filter Name : #ACSACL#-IP-Posture_NonCompliant_ACL-601a74ebDTLS-Tunnel: Tunnel ID : 36.3 Assigned IP : 192.168.100.101 Public IP : 52.94.8.10 Encryption : AES256 Hashing : SHA1 Ciphersuite : AES256-SHA Encapsulation: DTLSv1.0 UDP Src Port : 58772 UDP Dst Port : 443 Auth Mode : userPassword Idle Time Out: 30 Minutes Idle TO Left : 29 Minutes Client OS : Windows Client Type : DTLS VPN Client Client Ver : Cisco AnyConnect VPN Agent for Windows 4.9.05042 Bytes Tx : 45562 Bytes Rx : 26701 Pkts Tx : 128 Pkts Rx : 173 Pkts Tx Drop : 0 Pkts Rx Drop : 0 Filter Name : #ACSACL#-IP-Posture_NonCompliant_ACL-601a74eb 在ISE上可以看到通过CoA机制下发的DACL信息。 此时DACL未放行的流量，客户端无法通信。 5.3.4 客户端通过合规性检测后的授权 这里我测试时，关闭了检测Patch，因为流量通过ASA100k的速度下载更新速度太慢。同时也关闭了BitLocker检测，Window开启BitLocker是一个漫长的过程。但是这2项我都在生产环境中成功部署了，检测和修复是没有问题的。在生产环境中因为部署的SCCM，所以我使用了SCCM Client的监测方式。 这里ISE只授权了group-policy，所以客户端会受到group-policy的权限控制。 5.3.5 ISE查看客户端合规日志 这里可以看到客户端Posture检测是否通过。 Posture检测通过。 未通过Posture检测。 六、参考资料 ISE Posture部署指南：https://community.cisco.com/t5/security-documents/ise-posture-prescriptive-deployment-guide/ta-p/3680273 ISE Posture结合AnyConnect配置：https://community.cisco.com/t5/security-documents/how-to-configure-posture-with-anyconnect-compliance-module-and/ta-p/3647768 ISE Posture配置实例：https://www.youtube.com/watch?v=xrAdpdfBZgg","categories":[{"name":"Network","slug":"Network","permalink":"https://liuqianglong.com/categories/Network/"}],"tags":[{"name":"SSLVPN","slug":"SSLVPN","permalink":"https://liuqianglong.com/tags/SSLVPN/"},{"name":"ISE","slug":"ISE","permalink":"https://liuqianglong.com/tags/ISE/"},{"name":"Posture","slug":"Posture","permalink":"https://liuqianglong.com/tags/Posture/"}],"keywords":[{"name":"Network","slug":"Network","permalink":"https://liuqianglong.com/categories/Network/"}]},{"title":"Markdown语法测试","slug":"Markdown语法测试","date":"2021-01-29T16:15:21.000Z","updated":"2021-01-29T16:27:12.844Z","comments":true,"path":"Markdown语法测试.html","link":"","permalink":"https://liuqianglong.com/Markdown%E8%AF%AD%E6%B3%95%E6%B5%8B%E8%AF%95.html","excerpt":"","text":"一级标题二级标题三级标题四级标题五级标题六级标题印象笔记 近日，印象笔记宣布完成重组。作为Evernote已在中国独立运营近6年的品牌，印象笔记将成为由中方控股的中美合资独立运营实体，并获得红杉宽带跨境数字产业基金首轮数亿元人民币投资。 最外层 第一层嵌套 第二层嵌套 第一项 菜鸟教程学的不仅是技术更是梦想 第二项 印象笔记官网 使用 iOS 版本印象笔记如何快速保存内容？ 启用印象笔记 Widget ——印象笔记·剪贴板 复制粘贴任意内容 * 微信 滑动到 Widget 插件区域即可完成保存印象笔记·剪贴板有什么特点？ 快：开启自动模式，可以自动保存剪贴板的任意内容 一切：只要可以复制粘贴就可以保存 有序：全部保存在「我的剪贴板」笔记本并以时间来命名 三只青蛙 第一只青蛙 第二只青蛙 第三只青蛙 帐户类型 免费帐户 标准帐户 高级帐户 帐户流量 60M 1GB 10GB 设备数目 2台 无限制 无限制 当前价格 免费 ￥8.17/月 ￥12.33/月 &#123;.line-numbers,highlight12345678910111213141516171819202122#!/usr/bin/pythonimport reline = &quot;Cats are smarter than dogs&quot;matchObj = re.match( r&#x27;(.*) are (.*?) .*&#x27;, line, re.M|re.I)if matchObj: print &quot;matchObj.group() : &quot;, matchObj.group() print &quot;matchObj.group(1) : &quot;, matchObj.group(1) print &quot;matchObj.group(2) : &quot;, matchObj.group(2)else: print &quot;No match!!&quot;list1 = [&#x27;aaa&#x27;,111,(4,5),2.01]list2 = [&#x27;bbb&#x27;,333,111,3.14,(4,5)]for x in list1: if x in list2: print(x,&#x27;in list1 and list2&#x27;) else: print(x,&#x27;only in list1&#x27;) 使用 Ctrl+Alt+Del 重启电脑 文本加粗** 正常显示星号 ** 这会是 斜体 的文字这会是 斜体 的文字 这会是 粗体 的文字这会是 粗体 的文字 你也 组合 这些符号 这个文字将会被横线删除 Item 1 Item 2 Item 2a Item 2b Item 1 Item 2 Item 3 Item 3a Item 3b 如下，三个或者更多的 连字符 星号 下划线 &#123;highlight123``````javascript &#123;highlight=10-20&#125; &#123;highlight1 ==高亮== 这个链接用 1 作为网址变量 [RUNOOB][1].然后在文档的结尾位变量赋值（网址）[1]: http://static.runoob.com/images/runoob-logo.png 我是黑体字我是微软雅黑我是华文彩云我是红色我是绿色我是蓝色我是尺寸我是黑体，绿色，尺寸为5 文字背景颜色背景色yellow","categories":[{"name":"Tools","slug":"Tools","permalink":"https://liuqianglong.com/categories/Tools/"}],"tags":[{"name":"Markdown","slug":"Markdown","permalink":"https://liuqianglong.com/tags/Markdown/"}],"keywords":[{"name":"Tools","slug":"Tools","permalink":"https://liuqianglong.com/categories/Tools/"}]},{"title":"AWS上配置Cisco ASAv AnyConnect","slug":"AWS上配置Cisco-ASAv-AnyConnect","date":"2021-01-29T02:09:31.000Z","updated":"2021-01-30T08:23:27.191Z","comments":true,"path":"AWS上配置Cisco-ASAv-AnyConnect.html","link":"","permalink":"https://liuqianglong.com/AWS%E4%B8%8A%E9%85%8D%E7%BD%AECisco-ASAv-AnyConnect.html","excerpt":"","text":"1、实验简介最近一直在做思科防火墙的SSLVPN，用于解决员工远程办公的问题。传统上一般使用ASA55XX系列的硬件防火墙，现在开始转向Firepower上配置SSLVPN。这里主要介绍一下在AWS上使用ASAv配置SSLVPN的详细步骤。后续会继续深入SSLVPN上的高级特性。 如果你有配置ASA SSLVPN的经验，需要注意的是AWS的配置特殊性，下面是整个实验的注意事项： 在中国区如果AWS账号未经过ICP备案则无法使用TCP 443端口，需要修改默认的443端口号。 AWS上ASAv为客户端分配的IP地址需要进过NAT转换后才能访问。 AWS上的Windows2016无法安装ASDM，建议使用Windows2019安装ASDM软件。 如果ASAv未购买License会限速100k并且最大会话100个，做实验足够了但是无法用于生产环境。 2、环境介绍本次实验在VPC内需要使用2个子网，一个公共子网用于连接跳板机，用户可以先连接Windows2016之后，在Windows2016通过SSH和ASDM连接ASAv。这里不介绍AWS相关基础知识，例如如何创建VPC、如何创建公有子网、私有子网。 这是实验将会用到的公有子网，默认路由指向了IGW。 3、配置跳板机环境在公有子网启用一台window2016，用于之后通过SSH和ASDM访问ASAv，注意实例要选择windows 2016，经过测试windows 2019 无法安装ASDM。 通过AWS的快速启动一台windows 2016，可以通过输入“windows 2016”过滤查找。注意，window 2019环境无法安装Cisco ASDM。 Window2016放置在公有子网，并且开启分配公有IP功能。 4、创建ASAv实例在AWS Marketplace搜索asav，选择ami启用即可。需要注意的是，ASAv默认eth0是ciscoasa的管理接口，管理接口只能走网管流量，不能传输数据流量，所以至少需要再添加一个eth1作为outside接口。如果需要添加更多接口，例如inside和dmz接口，可以添加「网络接口」然后附加到实例。其实在AWS环境中一个outside接口就可以运行AnyConnect环境了。 实例创建成功之后，在AWS环境下需要对实例进行一下配置。因为AWS接口默认会丢弃目的IP不是本接口IP的流量，所以想要ASA转发流量，必须关闭outside接口的源/目标检查。 如果客户端想要访问私有云内的服务器，那么不能直接使用ASAv分配的地址池去访问，否则服务器没有回包路由。解决方法是在ASAv做源NAT，将客户端的源IP地址转换成outside上的一个辅助IP地址（无法转换成outside接口地址）。 防火墙outside需要公网能直接访问，所以需要一个公网地址。 公网地址关联上防火墙的outside接口。 启动之后，eth0是管理接口，首次连接时只能连接这个管理接口，如果想要连接其他接口可以连接之后配置。 5、ASAv基础配置首先通过SSH连接到ASAv的管理口进行一些基础配置，这里我使用MobaXterm作为SSH客户端，下载地址会放在最后。在AWS上启动的ASAv默认用户名是admin，使用对应的密钥登录即可。 首先需要设置enable密码 123456ciscoasa&gt; enableThe enable password is not set. Please set it now.Enter Password: ****Repeat Password: ****Note: Save your configuration so that the password persists across reboots(&quot;write memory&quot; or &quot;copy running-config startup-config&quot;). 添加的eth1接口默认是down状态 12345ciscoasa# show interface ip briefInterface IP-Address OK? Method Status ProtocolInternal-Data0&#x2F;0 169.254.1.1 YES unset up upManagement0&#x2F;0 172.30.2.176 YES DHCP up upTenGigabitEthernet0&#x2F;0 172.30.1.7 YES CONFIG administratively down up 开启eth1，配置名称为outside 123interface TenGigabitEthernet0&#x2F;0 no shutdown nameif outside 想要通过ASDM连接ASAv，需要开启http服务器，并且允许http流量从管理口进入，0 0 表示不限制IP地址段，如果要限制只允许192.168.1.0/24网段的http连接可以这么配置http 192.168.1.0 255.255.255.0。配置http的认证方式是本地认证，配置一个本地15级权限的用户名密码。 1234http server enablehttp 0 0 managementaaa authentication http console LOCALusername cisco password ciscoasa privilege 15 通过网页访问ASAv的管理接口地址 先下载并且安装Java环境，然后下载安装ASDM软件。 下载安装ASDM环境。 使用本地15级账号密码登录。 未导入License的情况下，限速100Kbps，最大会话100个连接。 这里通过ASDM的文件管理功能导入AnyConnect文件。 导入本地的AnyConnect客户端。 查看磁盘确认有客户端文件。 123ciscoasa# dirDirectory of disk0:&#x2F;86 -rwx 41077110 08:00:10 Jan 12 2021 anyconnect-win-4.6.00362-webdeploy-k9.pkg 6、ASAv配置SSLVPN（AnyConnect）下面是在AWS上配置ASAv几乎最小化配置了，这里对AnyConnect高级功能不做讨论。按照配置思路描述一下下面命令的含义：当客户端访问其他任何地址时，源地址转换为172.30.1.5。 12345object network asa_outside_address host 172.30.1.5object network anyconnect_pool_object subnet 192.168.1.0 255.255.255.0nat (outside,outside) source dynamic anyconnect_pool_object pat-pool asa_outside_address 默认情况下ASAv相同安全级别不能访问，流量不能从相同接口进出，这里需要开启这2个特性。 12same-security-traffic permit inter-interfacesame-security-traffic permit intra-interface 创建客户端的地址池 1ip local pool anyconnect_client_pool 192.168.1.1-192.168.1.254 mask 255.255.255.255 定义隧道分隔地址段，只有当用户访问172.30.1.0/24时，流量才会通过隧道到达ASAv，其他网段流量客户端依然从本地网络出去。 1access-list anyconnect_split standard permit 172.30.1.0 255.255.255.0 开启webvpn功能，修改端口为8443，激活anyconnect拨号功能。 12345webvpn port 8443 enable outside anyconnect enable anyconnect image disk0:&#x2F;anyconnect-win-4.6.00362-webdeploy-k9.pkg 配置group-policy，运行通过网页和客户端拨入，定义流量为隧道分隔模式。 123456group-policy anyconnect internalgroup-policy anyconnect attributes vpn-tunnel-protocol ssl-client ssl-clientless split-tunnel-policy tunnelspecified split-tunnel-network-list value anyconnect_split address-pools value anyconnect_client_pool 创建一个本地账号，用于拨号 123username anyuser password ciscoasausername anyuser attributes vpn-group-policy anyconnect 目前防火墙的默认路由是通过管理接口DHCP获取到的，需要将默认路由修改为outside出去。修改步骤如下： 开启outside ssh管理 将管理接口配置为静态IP，获取的默认路由会自动消失 重新通过outside接口连接ciscoasa 指定默认路由出口为outside 查看现有默认路由通过mgmt接口出去 123456ciscoasa# show routeS* 0.0.0.0 0.0.0.0 [1&#x2F;0] via 172.30.2.1, managementC 172.30.1.0 255.255.255.0 is directly connected, outsideL 172.30.1.7 255.255.255.255 is directly connected, outsideC 172.30.2.0 255.255.255.0 is directly connected, managementL 172.30.2.176 255.255.255.255 is directly connected, management 允许ssh连接outside接口 1ssh 0 0 outside 将管理接口配置为静态地址，获取的默认路由会自动消失。 12interface management 0&#x2F;0 ip address 172.30.2.176 255.255.255.0 重新通过SSH连接上outside接口之后，添加默认路由从outside接口出去。 1route outside 0 0 172.30.1.1 默认情况下AnyConnect不允许通过远程桌面拨号，需要创建一个AnyConnect Client Profile文件，编辑里面的参数。 允许通过远程桌面拨号。 如果未修改这个参数，通过远程桌面拨号后会有如下报错。 7、测试AnyConnect拨号拨号成功后，我通过SSL通道能访问到Windows2016的内网地址即可证明访问成功。Windows2016需要关闭防火墙才能ping通。 安全组也需要放行ICMP协议。 在公网上拨号成功。 去往172.30.1.0/24网段的流量会通过加密隧道访问。 测试访问内网Windows2016 1234567C:\\Users\\Administrator&gt;ping 172.30.1.131正在 Ping 172.30.1.131 具有 32 字节的数据:来自 172.30.1.131 的回复: 字节&#x3D;32 时间&#x3D;1ms TTL&#x3D;128来自 172.30.1.131 的回复: 字节&#x3D;32 时间&#x3D;1ms TTL&#x3D;128来自 172.30.1.131 的回复: 字节&#x3D;32 时间&#x3D;1ms TTL&#x3D;128来自 172.30.1.131 的回复: 字节&#x3D;32 时间&#x3D;1ms TTL&#x3D;128 这里默认是TLS，也就是TCP建立的连接，如果网络环境不太稳定，需要走语音和视频流量，建议使用DTLS通道，也就是UDP连接。 修改DTLS端口为8443 12webvpn dtls port 8443 在group-policy下开启DTLS 123group-policy anyconnect attributes webvpn anyconnect ssl dtls enable 重新拨号查看协议。 ASAv上查看客户端信息 123456789101112131415161718ciscoasa(config)# show vpn-sessiondb anyconnectSession Type: AnyConnectUsername : anyuser Index : 3Assigned IP : 192.168.1.1 Public IP : 52.83.196.213Protocol : AnyConnect-Parent SSL-TunnelLicense : AnyConnect PremiumEncryption : AnyConnect-Parent: (1)none SSL-Tunnel: (1)AES-GCM-256Hashing : AnyConnect-Parent: (1)none SSL-Tunnel: (1)SHA384Bytes Tx : 18613 Bytes Rx : 7928Group Policy : anyconnect Tunnel Group : DefaultWEBVPNGroupLogin Time : 09:46:43 UTC Tue Jan 12 2021Duration : 0h:01m:51sInactivity : 0h:00m:00sVLAN Mapping : N/A VLAN : noneAudt Sess ID : ac1e02b0000030005ffd7003Security Grp : none 1、mobaxterm下载地址2、Java环境下载地址","categories":[{"name":"Network","slug":"Network","permalink":"https://liuqianglong.com/categories/Network/"}],"tags":[{"name":"Cisco","slug":"Cisco","permalink":"https://liuqianglong.com/tags/Cisco/"},{"name":"AnyConnect","slug":"AnyConnect","permalink":"https://liuqianglong.com/tags/AnyConnect/"},{"name":"AWS","slug":"AWS","permalink":"https://liuqianglong.com/tags/AWS/"},{"name":"SSLVPN","slug":"SSLVPN","permalink":"https://liuqianglong.com/tags/SSLVPN/"}],"keywords":[{"name":"Network","slug":"Network","permalink":"https://liuqianglong.com/categories/Network/"}]}]}