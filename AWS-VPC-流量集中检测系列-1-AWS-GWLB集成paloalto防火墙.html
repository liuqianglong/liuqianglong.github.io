<!DOCTYPE HTML>
<html lang="zh-CN">

<head>
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="LiuQianglong&#39;s Blog">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.2.3">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="https://liuqianglong.com">
    <!--SEO-->

<meta name="keywords" content="AWS,CloudFormation,AWS Gateway Load Balancer,Paloalto" />


<meta name="description" content="B站视频链接：https://www.bilibili.com/video/BV13m4y1P72M/微信公众号：自刘地
一、背景1.1 参考的博客这个文档是我的笔记，最开始是对着AWS官方博客..." />


<meta name="robots" content="all" />
<meta name="google" content="all" />
<meta name="googlebot" content="all" />
<meta name="verify" content="all" />
    <!--Title-->

<title>
    
    AWS VPC 流量集中检测系列--(1)AWS GWLB集成paloalto防火墙 |
    
    LiuQianglong&#39;s Blog
</title>

<link rel="alternate" href="/atom.xml" title="LiuQianglong&#39;s Blog" type="application/atom+xml">


<link rel="icon" href="/favicon.ico">

    


<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7.css">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.7.0.css">
<link rel="stylesheet" href="/css/style.css?rev=@@hash.css">

    
<div class="hide">
    <script type="text/javascript">
    var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
    document.write(unescape("%3Cspan class='cnzz_stat_icon_1263868967 hide' %3E%3Cscript%20src%3D%22https%3A%2F%2Fs95.cnzz.com%2Fz_stat.php%3Fweb_id%3D1272564536%22%3E%3C%2Fscript%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s19.cnzz.com/z_stat.php%3Fid%3D1263868967%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
    </script>
</div>


<script>
var _hmt = _hmt || [];
(function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?5ded9cc2d3b5dca951b5a7b2ca26747d";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
})();
</script>



    

<meta name="generator" content="Hexo 5.3.0"></head>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->
<body>
    <header class="main-header"  >
    <div class="main-header-box">
        <a class="header-avatar" href="/" title='LiuQianglong'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a>
        <div class="branding">
            <!--<h2 class="text-hide">Snippet主题,从未如此简单有趣</h2>-->
            
            <img src="/img/branding.png" alt="Snippet 博客主题" class="img-responsive center-block">
            
        </div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                        <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="https://liuqianglong.com">
                        LiuQianglong&#39;s Blog</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                        <li role="presentation" class="text-center">
                            <a href="/"><i class="fa "></i>
                                首页</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/Network/"><i class="fa "></i>
                                Network</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/AWS/"><i class="fa "></i>
                                AWS</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/Python/"><i class="fa "></i>
                                Python</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/archives/"><i class="fa "></i>
                                时间轴</a>
                        </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="AWS VPC 流量集中检测系列--(1)AWS GWLB集成paloalto防火墙">
            
            AWS VPC 流量集中检测系列--(1)AWS GWLB集成paloalto防火墙
            
        </h1>
        <div class="post-meta">
    
    <span class="categories-meta fa-wrap">
        <i class="fa fa-folder-open-o"></i>
        <a class="category-link" href="/categories/AWS/">AWS</a>
    </span>
    
    
    <span class="fa-wrap">
        <i class="fa fa-tags"></i>
        <span class="tags-meta">
            
            <a class="tag-none-link" href="/tags/AWS/" rel="tag">AWS</a> <a class="tag-none-link" href="/tags/AWS-Gateway-Load-Balancer/" rel="tag">AWS Gateway Load Balancer</a> <a class="tag-none-link" href="/tags/CloudFormation/" rel="tag">CloudFormation</a> <a class="tag-none-link" href="/tags/Paloalto/" rel="tag">Paloalto</a>
            
        </span>
    </span>
    
    
    
    <span class="fa-wrap">
        <i class="fa fa-clock-o"></i>
        <span class="date-meta">
            2022/10/14</span>
    </span>
    
    <span class="fa-wrap">
        <i class="fa fa-eye"></i>
        <span id="busuanzi_value_page_pv"></span>
    </span>
    
    
</div>
        
        
    </div>
    
    <div class="post-body post-content">
        <p><strong>B站视频链接：</strong><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV13m4y1P72M/">https://www.bilibili.com/video/BV13m4y1P72M/</a><br><strong>微信公众号：</strong>自刘地<br><img src="/img/wechat.jpg" alt="自刘地"></p>
<h2 id="一、背景"><a href="#一、背景" class="headerlink" title="一、背景"></a>一、背景</h2><h3 id="1-1-参考的博客"><a href="#1-1-参考的博客" class="headerlink" title="1.1 参考的博客"></a>1.1 参考的博客</h3><p>这个文档是我的笔记，最开始是对着<u>AWS官方博客</u>[参见链接1]来做实验的，发现无论如何都无法实验成功，后来发现博客里面一个重要参数写错了导致异常。坑出现在原博客[3.2.1 创建PA防火墙实例]，里面写到plugin-op-commands=Amazon-gwlb-inspect:enable，应该将Amazon修改为aws，即plugin-op-commands=aws-gwlb-inspect:enable。</p>
<p>测试完paloalto之后，我想测试FortiGate防火墙，飞塔是对这个<u>AWS官方博客</u>[参见链接2]来做实验的，两个拓扑基本一致，只是替换了防火墙，但是发现这篇博客更坑，关键步骤有缺失，无法实现防火墙的高可用切换。后续我会在相同的拓扑下，使用FortiGate防火墙来测试，会填上博客缺失步骤的坑。</p>
<p>这次实验是在AWS Console上操作的，后续我会演示AWS CloudFormation来部署这个环境。</p>
<h3 id="1-2-流量集中检测"><a href="#1-2-流量集中检测" class="headerlink" title="1.2 流量集中检测"></a>1.2 流量集中检测</h3><p>传统网络都会在出口部署防火墙，用于检测内网进出互联网的流量。到了AWS云上，这个需求并不太容易实现，因为每个VPC都可以认为是一个独立的网络，有独立的出口。但是对AWS云上的南北向（VPC访问互联网）和东西向（VPC互访）流量做集中检测一直都是比较常见的需求。</p>
<p>流量集中检测架构的核心主要是两个点，一是如何将流量引导到防火墙上，二是防火墙如何实现高可用。</p>
<p>以前常见方法是通过AWS Lambda函数来修改路由表，从而切换流量，并且实现防火墙的高可用。这种方案扩展性不好，而且不太容易实施。</p>
<p>AWS Gateway Load Balancer（GWLB）的出现很好的解决了上面两个问题。AWS PrivateLink提供了新的VPC终端节点GWLB endpoint（GWLBe），它可以做为下一跳路由节点，解决了流量引导的问题。GWLB在防火墙的前面做负载均衡，解决了防火墙高可用的问题。另外关于流量引导，也可结合Transit Gateway来进行引流，可以实现更具扩展性的架构。</p>
<h2 id="二、实验介绍"><a href="#二、实验介绍" class="headerlink" title="二、实验介绍"></a>二、实验介绍</h2><p>这里AppVpc模拟业务的VPC，APP进出互联网的流量会被引导到SecVpc内的防火墙做安全检测，防火墙允许通过后，流量才能正常通信。</p>
<p>这次实验的核心组件：</p>
<p><strong>GWLB</strong>：Gateway Load Balancer与防火墙建立<u>GENEVE</u>[参见链接3]隧道，使用UDP 6081来转发数据，这种封装方式让防火墙不用关闭源/目的地址检查，也不用做源/目的NAT的转换。GWLB会在子网创建一个弹性接口，流量通过这个弹性接口来转发。</p>
<p><strong>GWLBe</strong>：Gateway Load Balancer endpoint 是由AWS PrivateLink提供的VPC终端节点，可以作为路由表中的下一跳存在，流量送到GWLBe后，会继续送往GWLB背后的实例。</p>
<p><strong>Ingress Route Table</strong>：这个路由表关联在IGW上，路由表一般都是关联在子网，这里是AWS 2019年发布的一个功能<u>VPC Ingress Routing</u>[参见链接4]，让路由表可以关联到IGW上，用于控制入向的流量。</p>
<p><img src="/img/AWS-GWLB-Paloalto-1/gwlb-paloalto.png" alt="GWLB paloalto"></p>
<p><strong>APP访问互联网流量路径（红色箭头）</strong></p>
<ol>
<li>AppVpc内的APP1想要访问Internet上的资源，所在子网关联的路由表将默认路由指向了GWLB Endpoint1。</li>
<li>GWLB Endpoint1 使用 AWS PrivateLink 将流量送到到GWLB，这里流量是由AWS来控制，无需用户配置。</li>
<li>GWLB会使用IP数据包的5元组或者3元组哈希来选择实例。GWLB使用GENEVE来封装原始IP流量，并通过UDP 6081发送到防火墙。GENEVE封装可以将所有的IP流量送到实例上，GWLB的侦听组上不需要为每个协议和端口配置侦听器。<ul>
<li>当 GWLB 接收到新的 TCP/UDP 流时，它会使用 5 元组流哈希（源 IP、目标 IP、传输协议、源端口、目标端口）从目标组中选择一个健康的设备。随后，GWLB 将该流的所有数据包（正向和反向）路由到同一设备（粘性）。对于非 TCP/UDP 流，GWLB 仍然使用 3 元组（源 IP、目标 IP、传输协议）进行转发决策。</li>
</ul>
</li>
<li>防火墙收到GENEVE报文，需要解封装流量，然后根据防火墙的安全策略决定是否允许流量通过。</li>
<li>防火墙重新使用GENEVE封装流量，并发送到GWLB。</li>
<li>GWLB根据 GENEVE TLV字段，选择转发到GWLB Endpoint1，并且发送时会去除GENEVE封装。<ul>
<li>为了支持具有重叠 CIDR 的多租户设备，设备需要知道流量的来源。GWLB 还需要跟踪流量并避免用户流量的混合。GWLB 可以通过将每个数据包的类型-长度-值 (TLV) 三元组发送到设备的额外信息（例如 GWLBE/VPCE ID、附件 ID、流 Cookie）来实现这一点。</li>
</ul>
</li>
<li>GWLB Endpoint1接受到流量，查看子网关联路由表，默认路由指向IGW，流量通过IGW访问Internet。</li>
</ol>
<p><strong>互联网访问APP的流量路径（蓝色箭头）</strong></p>
<ol>
<li>客户发起对App1公网地址的访问，流量到达AppVpc的IGW，IGW查看所关联的路由表，将流量送往GWLB Endpoint1。</li>
<li>GWLB Endpoint1 使用 AWS PrivateLink 将流量送到到GWLB。</li>
<li>GWLB使用GENEVE来封装原始IP流量，并通过UDP 6081转发到实例。</li>
<li>防火墙收到GENEVE报文，需要解封装流量，然后根据防火墙的安全策略决定是否允许流量通过。</li>
<li>防火墙重新使用GENEVE封装流量，并发送到GWLB。</li>
<li>GWLB根据 GENEVE TLV字段，选择转发到GWLB Endpoint1，并去除GENEVE封装。</li>
<li>GWLB Endpoint1接受到流量，查看子网关联路由表，匹配到local路由，流量送到APP1。</li>
</ol>
<h2 id="三、-配置部署"><a href="#三、-配置部署" class="headerlink" title="三、 配置部署"></a>三、 配置部署</h2><h3 id="3-1-VPC-配置"><a href="#3-1-VPC-配置" class="headerlink" title="3.1 VPC 配置"></a>3.1 VPC 配置</h3><h4 id="3-1-1-创建VPC"><a href="#3-1-1-创建VPC" class="headerlink" title="3.1.1 创建VPC"></a>3.1.1 创建VPC</h4><p>创建两个VPC</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">VPC名称		网段</span><br><span class="line">AppVpc		10.10.0.0&#x2F;16</span><br><span class="line">SecVpc		10.20.0.0&#x2F;16</span><br></pre></td></tr></table></figure>
<p><img src="/img/AWS-GWLB-Paloalto-1/image-20220921103543660.png" alt="image-20220921103543660"></p>
<h4 id="3-1-2-创建IGW关联VPC"><a href="#3-1-2-创建IGW关联VPC" class="headerlink" title="3.1.2 创建IGW关联VPC"></a>3.1.2 创建IGW关联VPC</h4><p>创建两个IGW，分别关联上VPC<img src="/img/AWS-GWLB-Paloalto-1/image-20220921113918034.png" alt="image-20220921113918034"></p>
<h4 id="3-1-3-创建子网"><a href="#3-1-3-创建子网" class="headerlink" title="3.1.3 创建子网"></a>3.1.3 创建子网</h4><p>AppVpc 创建4个子网</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">子网名称				网段					备注</span><br><span class="line">AppVpc-GWLBe1-Subnet	10.10.10.0&#x2F;24		AZ1 的Gateway Load Balancer Endpoint所在子网</span><br><span class="line">AppVpc-App1-Subnet		10.10.20.0&#x2F;24		AZ1 App1 所在子网</span><br><span class="line">AppVpc-GWLBe2-Subnet	10.10.30.0&#x2F;24		AZ2 的Gateway Load Balancer Endpoint所在子网</span><br><span class="line">AppVpc-App2-Subnet		10.10.40.0&#x2F;24		AZ2 App2 所在子网</span><br></pre></td></tr></table></figure>
<p><img src="/img/AWS-GWLB-Paloalto-1/image-20220921105143914.png" alt="image-20220921105143914"></p>
<p>SecVpc 创建4个子网</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">子网名称				网段				备注</span><br><span class="line">SecVpc-GWLB1-Subnet		10.20.10.0&#x2F;24	AZ1 paloalto 数据接口所在子网，GWLB的接口也在此子网</span><br><span class="line">SecVpc-MGT1-Subnet		10.20.20.0&#x2F;24	AZ1 paloalto 的管理接口所在子网，可以通过互联网直接访问</span><br><span class="line">SecVpc-GWLB2-Subnet		10.20.30.0&#x2F;24	AZ2 paloalto 数据接口所在子网，GWLB的接口也在此子网</span><br><span class="line">SecVpc-MGT2-Subnet		10.20.40.0&#x2F;24	AZ2 paloalto 的管理接口所在子网，可以通过互联网直接访问</span><br></pre></td></tr></table></figure>
<p><img src="/img/AWS-GWLB-Paloalto-1/image-20220921105910094.png" alt="image-20220921105910094"></p>
<h4 id="3-1-4-创建路由表"><a href="#3-1-4-创建路由表" class="headerlink" title="3.1.4 创建路由表"></a>3.1.4 创建路由表</h4><p>这里创建路由表之后，暂时先不修改路由，因为有些路由的下一跳是Endpoint，需要等Endpoint创建完成后再修改路由表。</p>
<p>AppVpc创建4个路由表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">路由表名称							备注</span><br><span class="line">AppVpc-Igw-Ingress-route-table		这个路由表关联AppVpcIGW，不关联子网，用于将入向流量引导到endpoint			</span><br><span class="line">AppVpc-Gwlbe-route-table			这个路由表关联两个GWLBe所在的子网，用于将流量从IGW出去</span><br><span class="line">AppVpc-App1-route-table				这是AZ1 App的路由表，默认路由指向AZ1的endpoint</span><br><span class="line">AppVpc-App2-route-table				这是AZ2 App的路由表，默认路由指向AZ2的endpoint</span><br></pre></td></tr></table></figure>


<p>AppVpc-Igw-Ingress-route-table关联IGW。路由表一般都是关联子网，这里是AWS 2019年发布的一个功能<a target="_blank" rel="noopener" href="https://aws.amazon.com/cn/blogs/aws/new-vpc-ingress-routing-simplifying-integration-of-third-party-appliances/">VPC Ingress Routing</a>，让路由表可以关联到IGW上，用于控制入向的流量。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921115109559.png" alt="image-20220921115109559"></p>
<p>AppVpc-Gwlbe-route-table关联两个GWLBe子网<img src="/img/AWS-GWLB-Paloalto-1/image-20220921115113783.png" alt="image-20220921115113783"></p>
<p>AppVpc-App1-route-table关联AZ1的APP<img src="/img/AWS-GWLB-Paloalto-1/image-20220921115119782.png" alt="image-20220921115119782"></p>
<p>AppVpc-App1-route-table关联AZ2的APP<img src="/img/AWS-GWLB-Paloalto-1/image-20220921115123253.png" alt="image-20220921115123253"></p>
<p>SecVpc创建1个路由表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">路由表名称					备注</span><br><span class="line">SecVpc-Mgt-route-table		默认路由指向IGW，用于互联网访问防火墙的管理接口</span><br></pre></td></tr></table></figure>


<p>SecVpc-Mgt-route-table关联两个管理子网。防火墙的数据接口不需要单独的路由表，因为数据接口主要是和GWLB通过GENVEN隧道通信，当然为数据接口网段单独创建一个路由表也可以，不用添加任何特殊路由。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921115634502.png" alt="image-20220921115634502"></p>
<p>管理网络的默认路由指向IGW，为了之后从公网连接到防火墙进行初始化。其他路由之后再设置。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921152230406.png" alt="image-20220921152230406"></p>
<h3 id="3-2-创建实例"><a href="#3-2-创建实例" class="headerlink" title="3.2 创建实例"></a>3.2 创建实例</h3><h4 id="3-2-1-创建paloalto实例"><a href="#3-2-1-创建paloalto实例" class="headerlink" title="3.2.1 创建paloalto实例"></a>3.2.1 创建paloalto实例</h4><p>在Marketplace搜索paloalto关键词，选择<code>VM-Series Next-Generation Firewall Bundle 2</code>AMI。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921133045730.png" alt="image-20220921133045730"></p>
<p>设置实例名称，保持默认建议的实例大小。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921133050696.png" alt="image-20220921133050696"></p>
<p>实例放置到SecVpc，防火墙的数据接口作为主网卡，放置在<code>SecVpc-GWLB1-Subnet</code>子网。可以使用系统创建的安全组，另外放行了TCP 80，用于侦听组的健康监测，放行GENEVE协议使用的UDP 6081。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921163042812.png" alt="image-20220921163042812"></p>
<p>再添加一块网卡，用于防火墙的带外管理，放置在<code>SecVpc-MGT1-Subnet</code>子网。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921133100458.png" alt="image-20220921133100458"></p>
<p>这里非常关键，源博客就是坑在了这里，在安装aws-gwlb插件是写错了关键词导致插件无法正常安装。这里两条命令的详细含义可以[参见链接5]。</p>
<p><code>mgmt-interface-swap=enable</code>用于切换防火墙的网卡的映射关系。</p>
<ul>
<li><p>默认情况下，AWS 上的ENI eth0映射到paloalto防火墙上的MGT接口，也就是主网卡是管理接口，而ENI eth1映射到paloalto防火墙上的ethernet1/1接口。</p>
</li>
<li><p>AWS 负载均衡器可以选择实例或者IP地址作为目标发送流量，如果选择实例作为目标（默认），流量会发送到实例的主接口。</p>
</li>
<li><p>官方文档建议数据口作为防火墙的主接口，所以需要在防火墙内部修改一下接口的映射关系，将AWS eth0映射为数据接口，AWS eth1映射为管理接口。</p>
</li>
</ul>
<p><code>plugin-op-commands=aws-gwlb-inspect:enable</code>防火墙安装插件，用于处理GWLB的流量。</p>
<p>防火墙启动后，可以使用<code>show plugins vm_series aws gwlb</code>查看插件的安装情况。如果没有安装成功，可以使用<code>request plugins vm_series aws gwlb inspect enable yes</code>命令手动再安装一次。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mgmt-interface-swap&#x3D;enable</span><br><span class="line">plugin-op-commands&#x3D;aws-gwlb-inspect:enable</span><br></pre></td></tr></table></figure>
<p><img src="/img/AWS-GWLB-Paloalto-1/image-20220921133108112.png" alt="image-20220921133108112"></p>
<p>申请两个EIP，用于关联防火墙的管理接口，这样可以通过互联网管理防火墙。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921134853989.png" alt="image-20220921134853989"></p>
<p>关联防火墙的管理接口，注意不要关联成数据接口了。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921153205925.png" alt="image-20220921153205925"></p>
<p>PA-FW2也是相同的步骤关联EIP。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921153242567.png" alt="image-20220921153242567"></p>
<h4 id="3-2-2-创建APP实例"><a href="#3-2-2-创建APP实例" class="headerlink" title="3.2.2 创建APP实例"></a>3.2.2 创建APP实例</h4><p>创建App1，主要用于后续搭建一个HTTP服务，从公网访问测试，这里使用Amazon Linux AMI，保持默认的实例大小即可。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921150935832.png" alt="image-20220921150935832"></p>
<p>实例放置在<code>AppVpc-App1-Subnet</code>子网，开启自动分配公网IP，安全组放行TCP 8843，后续的HTTP使用8443端口。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921150942179.png" alt="image-20220921150942179"></p>
<p>创建App2实例，这里使用Window AMI，为了启动速度快一些，这里使用了t3.large的实例类型。App2实例可以用于从公网RDP测试，也可以做为客户端使用浏览器测试互联网访问流量监测。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921150947193.png" alt="image-20220921150947193"></p>
<p>实例放置在<code>AppVpc-App2-Subnet</code>子网，允许自动获取公网IP地址，安全组保持默认放行3389即可。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921150951645.png" alt="image-20220921150951645"></p>
<h3 id="3-3-配置paloalto"><a href="#3-3-配置paloalto" class="headerlink" title="3.3 配置paloalto"></a>3.3 配置paloalto</h3><h4 id="3-3-1-paloalto修改默认密码"><a href="#3-3-1-paloalto修改默认密码" class="headerlink" title="3.3.1 paloalto修改默认密码"></a>3.3.1 paloalto修改默认密码</h4><p>在AWS上启用Paloalto，需要先SSH登录到防火墙，设置密码，然后才能使用HTTPS登录管理。</p>
<p>使用用户名<code>admin</code>结合密钥的方式登录防火墙，然后按照下面命令修改admin的密码，最后需要<code>commit</code>提交。两台防火墙均按照这个方法重置密码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Welcome admin.</span><br><span class="line">admin@PA-VM&gt; configure</span><br><span class="line">Entering configuration mode</span><br><span class="line">[edit]</span><br><span class="line">admin@PA-VM# set mgt-config users admin password</span><br><span class="line">Enter password   :</span><br><span class="line">Confirm password :</span><br><span class="line"></span><br><span class="line">[edit]</span><br><span class="line">admin@PA-VM# commit</span><br><span class="line"></span><br><span class="line">Commit job 2 is in progress. Use Ctrl+C to return to command prompt</span><br><span class="line">.........55%75%98%..............100%</span><br><span class="line">Configuration committed successfully</span><br><span class="line"></span><br><span class="line">[edit]</span><br><span class="line">admin@PA-VM#</span><br></pre></td></tr></table></figure>


<h4 id="3-3-2-图形化界面配置PA-FW1"><a href="#3-3-2-图形化界面配置PA-FW1" class="headerlink" title="3.3.2 图形化界面配置PA-FW1"></a>3.3.2 图形化界面配置PA-FW1</h4><p>使用HTTPS登录防火墙的管理地址。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921160100297.png" alt="image-20220921160100297"></p>
<p>设置数据接口的虚拟路由器，这里<strong>新建一个安全区域</strong>为”untrust”。新建的过程省略了。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921160104470.png" alt="image-20220921160104470"></p>
<p>接口通过DHCP获取地址。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921160110089.png" alt="image-20220921160110089"></p>
<p>设置数据接口的管理配置文件，主要是管理接口开启的服务。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921160115093.png" alt="image-20220921160115093"></p>
<p>开启HTTP、SSH、Ping服务，这个服务是用于后续侦听组探测实例是否存活用的。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921160120622.png" alt="image-20220921160120622"></p>
<p>接口关联创建的配置文件。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921160124547.png" alt="image-20220921160124547"></p>
<p>因为流量都是从相同的接口进出，这里为了方便，直接修改默认的<code>intrazone-default</code>安全策略。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921160130883.png" alt="image-20220921160130883"></p>
<p>开启日志，并按照下图配置安全防护策略。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921160136595.png" alt="image-20220921160136595"></p>
<p>提交配置后上面的操作才会生效。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921160140460.png" alt="image-20220921160140460"></p>
<h4 id="3-3-3-命令行配置PA-FW2"><a href="#3-3-3-命令行配置PA-FW2" class="headerlink" title="3.3.3 命令行配置PA-FW2"></a>3.3.3 命令行配置PA-FW2</h4><p>图形化的配置方式虽然直观，但效率实在太低，截图也比较冗长。所以第二台防火墙我通过命令行的方式来配置。通过下面命令，paloalto可以实现类似思科<code>show run</code>的操作来查看配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">admin@PA-VM&gt; set cli config-output-format set</span><br><span class="line">admin@PA-VM&gt; configure</span><br><span class="line">admin@PA-VM# show</span><br></pre></td></tr></table></figure>


<p>将下面的命令刷到PA-FW2上，和上面图形化配置相同。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">set network profiles interface-management-profile MgtProfile http yes</span><br><span class="line">set network profiles interface-management-profile MgtProfile ssh yes</span><br><span class="line">set network profiles interface-management-profile MgtProfile ping yes</span><br><span class="line"></span><br><span class="line">set network interface ethernet ethernet1&#x2F;1 layer3 ndp-proxy enabled no</span><br><span class="line">set network interface ethernet ethernet1&#x2F;1 layer3 sdwan-link-settings upstream-nat enable no</span><br><span class="line">set network interface ethernet ethernet1&#x2F;1 layer3 sdwan-link-settings upstream-nat static-ip</span><br><span class="line">set network interface ethernet ethernet1&#x2F;1 layer3 sdwan-link-settings enable no</span><br><span class="line">set network interface ethernet ethernet1&#x2F;1 layer3 interface-management-profile MgtProfile</span><br><span class="line">set network interface ethernet ethernet1&#x2F;1 layer3 lldp enable no</span><br><span class="line">set network interface ethernet ethernet1&#x2F;1 layer3 dhcp-client</span><br><span class="line"></span><br><span class="line">set network virtual-router default interface ethernet1&#x2F;1</span><br><span class="line">set zone untrust network layer3 ethernet1&#x2F;1</span><br><span class="line"></span><br><span class="line">set rulebase default-security-rules rules intrazone-default action allow</span><br><span class="line">set rulebase default-security-rules rules intrazone-default log-start yes</span><br><span class="line">set rulebase default-security-rules rules intrazone-default log-end yes</span><br><span class="line">set rulebase default-security-rules rules intrazone-default profile-setting profiles url-filtering default</span><br><span class="line">set rulebase default-security-rules rules intrazone-default profile-setting profiles file-blocking &quot;strict file blocking&quot;</span><br><span class="line">set rulebase default-security-rules rules intrazone-default profile-setting profiles virus default</span><br><span class="line">set rulebase default-security-rules rules intrazone-default profile-setting profiles spyware strict</span><br><span class="line">set rulebase default-security-rules rules intrazone-default profile-setting profiles vulnerability strict</span><br><span class="line">set rulebase default-security-rules rules intrazone-default profile-setting profiles wildfire-analysis default</span><br><span class="line"></span><br><span class="line">commit</span><br><span class="line"></span><br><span class="line">Commit job 3 is in progress. Use Ctrl+C to return to command prompt</span><br><span class="line">.........55%70%98%.............100%</span><br><span class="line">Configuration committed successfully</span><br><span class="line">Warning: No valid Antivirus content package exists</span><br><span class="line">(Module: device)</span><br></pre></td></tr></table></figure>




<h3 id="3-4-创建GWLB并关联paloalto"><a href="#3-4-创建GWLB并关联paloalto" class="headerlink" title="3.4 创建GWLB并关联paloalto"></a>3.4 创建GWLB并关联paloalto</h3><p>创建Gateway Load Balancer<img src="/img/AWS-GWLB-Paloalto-1/image-20220921163436613.png" alt="image-20220921163436613"></p>
<p>指定两台防火墙数据接口所在的子网，GWLB会在这两个子网创建两个弹性接口，GENEVE流量实际从这个弹性接口转发。这里创建侦听组。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921163439654.png" alt="image-20220921163439654"></p>
<p>实例类型的target会侦听实例的主网卡，因为防火墙的主网卡就是数据接口，所以可以使用Instances类型的target。如果要侦听非主网卡，那只能使用IP地址了。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921163444406.png" alt="image-20220921163444406"></p>
<p>实验环境可以加快监控检测探测的频率。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921163448677.png" alt="image-20220921163448677"></p>
<p>将两台防火墙注册到侦听组上。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921163453032.png" alt="image-20220921163453032"></p>
<p>回到创建GWLB的界面，调用刚才创建的侦听组。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921163459393.png" alt="image-20220921163459393"></p>
<p>确认防火墙的健康检查正常。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921163506585.png" alt="image-20220921163506585"></p>
<p>启用GWLB的跨区域负载均衡。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921163612230.png" alt="image-20220921163612230"></p>
<h3 id="3-5-创建Endpoint-Service及Endpoint"><a href="#3-5-创建Endpoint-Service及Endpoint" class="headerlink" title="3.5 创建Endpoint Service及Endpoint"></a>3.5 创建Endpoint Service及Endpoint</h3><p>创建Endpoint Service关联GWLB，测试环境取消勾选<code>Acceptance required</code>，这样当Endpoint发起连接时，不需要再手动确认一次。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921173835848.png" alt="image-20220921173835848"></p>
<p>记录Endpoint Service name。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921173902799.png" alt="image-20220921173902799"></p>
<p>创建endpoint，填写刚才记录的Endpoint Service name，放置到<code>AppVpc-GWLBe1-Subnet</code>子网。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921173908163.png" alt="image-20220921173908163"></p>
<p>继续创建endpoint，放置到<code>AppVpc-GWLBe2-Subnet</code>子网。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921173913722.png" alt="image-20220921173913722"></p>
<p>查看创建的两个endpoint，记录endpoint ID，后续修改路由表需要用到。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921173937303.png" alt="image-20220921173937303"></p>
<h3 id="3-6-修改路由表"><a href="#3-6-修改路由表" class="headerlink" title="3.6 修改路由表"></a>3.6 修改路由表</h3><p>修改IGW关联的路由表，控制去往App网段的流量分别送到两个endpoint上去。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921174108805.png" alt="image-20220921174108805"></p>
<p>修改App1所在子网的路由，默认路由指向Endpoint1。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921174119659.png" alt="image-20220921174119659"></p>
<p>修改App2所在子网的路由，默认路由指向Endpoint2。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921174133757.png" alt="image-20220921174133757"></p>
<p>修改endpoint所在子网的路由，默认路由指向IGW。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921174221559.png" alt="image-20220921174221559"></p>
<h2 id="四、访问测试"><a href="#四、访问测试" class="headerlink" title="四、访问测试"></a>四、访问测试</h2><h3 id="4-1-App1-HTTP访问测试"><a href="#4-1-App1-HTTP访问测试" class="headerlink" title="4.1 App1 HTTP访问测试"></a>4.1 App1 HTTP访问测试</h3><p>通过SSH连接到App1上，安装HTTP服务，修改端口为8443。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install -y httpd</span><br><span class="line">sed -i.bak &#39;s&#x2F;Listen 80&#x2F;Listen 8443&#x2F;g&#39; &#x2F;etc&#x2F;httpd&#x2F;conf&#x2F;httpd.conf</span><br><span class="line">echo &quot;&lt;h2&gt;Hello World from $(hostname -f)&lt;&#x2F;h2&gt;&quot; &gt; &#x2F;var&#x2F;www&#x2F;html&#x2F;index.html</span><br><span class="line">systemctl start httpd.service</span><br><span class="line">systemctl enable httpd.service</span><br></pre></td></tr></table></figure>


<p>访问EC2的公网8443端口测试，在浏览器界面可以使用<code>CTRL+F5</code>多强制刷新几次。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921174613938.png" alt="image-20220921174613938"></p>
<p>查看PA-FW1上的日志。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921174703593.png" alt="image-20220921174703593"></p>
<p>查看PA-FW2上的日志。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921174655252.png" alt="image-20220921174655252"></p>
<h3 id="4-2-App2-RDP连接测试"><a href="#4-2-App2-RDP连接测试" class="headerlink" title="4.2 App2 RDP连接测试"></a>4.2 App2 RDP连接测试</h3><p>通过RDP连接到App2上，可以通过浏览器访问一些网页制造流量。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921174522703.png" alt="image-20220921174522703"></p>
<p>查看PA-FW1上的日志。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921174441701.png" alt="image-20220921174441701"></p>
<p>查看PA-FW2上的日志。<img src="/img/AWS-GWLB-Paloalto-1/image-20220921174600927.png" alt="image-20220921174600927"></p>
<h2 id="五、清理实验环境步骤"><a href="#五、清理实验环境步骤" class="headerlink" title="五、清理实验环境步骤"></a>五、清理实验环境步骤</h2><p>到上面其实实验已经做完了，既然是实验，肯定是需要清空实验环境的。这个实验有一些依赖调用，有时候不太好删除，另外如果漏删除了EIP和卷，还会持续产生费用。</p>
<p>按照下面步骤可以彻底清空前面所有操作创建的资源，不会有依赖报错。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1. 终止所有实例。</span><br><span class="line">2. 解除AppVpc的4个路由表关联的子网和IGW。</span><br><span class="line">3. 删除AppVpc的4个路由表。</span><br><span class="line">4. 删除2个Endpoint。</span><br><span class="line">5. 删除Endpoint Service。</span><br><span class="line">6. 删除AppVpc。</span><br><span class="line">7. 删除GWLB。</span><br><span class="line">8. 删除SecVpc。</span><br><span class="line">9. 删除Target Group。</span><br><span class="line">10. 释放申请的2个EIP。</span><br><span class="line">11. 删除未清空的EC2卷。</span><br></pre></td></tr></table></figure>


<h2 id="六、参考文档"><a href="#六、参考文档" class="headerlink" title="六、参考文档"></a>六、参考文档</h2><ul>
<li><p><strong>[1] 使用Gateway Load Balancer和Palo alto防火墙实现集中的网络流量深度检测：</strong><a target="_blank" rel="noopener" href="https://aws.amazon.com/cn/blogs/china/centralized-network-traffic-depth-detection-using-gateway-load-balancer-and-palo-alto-firewalls/">https://aws.amazon.com/cn/blogs/china/centralized-network-traffic-depth-detection-using-gateway-load-balancer-and-palo-alto-firewalls/</a></p>
</li>
<li><p><strong>[2] 亚马逊云科技(中国区)网关负载均衡服务集成FortiGate安全网关扩展安全服务性能：</strong><a target="_blank" rel="noopener" href="https://aws.amazon.com/cn/blogs/china/gateway-load-balancing-services-integrate-fortigate-security-gateways/">https://aws.amazon.com/cn/blogs/china/gateway-load-balancing-services-integrate-fortigate-security-gateways/</a></p>
</li>
<li><p><strong>[3] RFC 8926 Geneve: Generic Network Virtualization Encapsulation：</strong><a target="_blank" rel="noopener" href="https://www.rfc-editor.org/rfc/rfc8926">https://www.rfc-editor.org/rfc/rfc8926</a></p>
</li>
<li><p><strong>[4] New – VPC Ingress Routing – Simplifying Integration of Third-Party Appliances：</strong><a target="_blank" rel="noopener" href="https://aws.amazon.com/cn/blogs/aws/new-vpc-ingress-routing-simplifying-integration-of-third-party-appliances">https://aws.amazon.com/cn/blogs/aws/new-vpc-ingress-routing-simplifying-integration-of-third-party-appliances</a></p>
</li>
<li><p><strong>[5] Management Interface Mapping for Use with Amazon ELB：</strong><a target="_blank" rel="noopener" href="https://docs.paloaltonetworks.com/vm-series/10-2/vm-series-deployment/set-up-the-vm-series-firewall-on-aws/about-the-vm-series-firewall-on-aws/management-interface-mapping-for-use-with-amazon-elb#id7e1c2653-88af-4a85-8bb8-aae1847c0d9f">https://docs.paloaltonetworks.com/vm-series/10-2/vm-series-deployment/set-up-the-vm-series-firewall-on-aws/about-the-vm-series-firewall-on-aws/management-interface-mapping-for-use-with-amazon-elb#id7e1c2653-88af-4a85-8bb8-aae1847c0d9f</a></p>
</li>
<li><p><strong>paloalto Viewing the configuration in set and XML format：</strong><a target="_blank" rel="noopener" href="https://knowledgebase.paloaltonetworks.com/KCSArticleDetail?id=kA10g000000ClHoCAK">https://knowledgebase.paloaltonetworks.com/KCSArticleDetail?id=kA10g000000ClHoCAK</a></p>
</li>
<li><p><strong>Integrate your custom logic or appliance with AWS Gateway Load Balancer：</strong><a target="_blank" rel="noopener" href="https://aws.amazon.com/cn/blogs/networking-and-content-delivery/integrate-your-custom-logic-or-appliance-with-aws-gateway-load-balancer/">https://aws.amazon.com/cn/blogs/networking-and-content-delivery/integrate-your-custom-logic-or-appliance-with-aws-gateway-load-balancer/</a></p>
</li>
<li><p><strong>Introducing AWS Gateway Load Balancer – Easy Deployment, Scalability, and High Availability for Partner Appliances：</strong><a target="_blank" rel="noopener" href="https://aws.amazon.com/cn/blogs/aws/introducing-aws-gateway-load-balancer-easy-deployment-scalability-and-high-availability-for-partner-appliances/">https://aws.amazon.com/cn/blogs/aws/introducing-aws-gateway-load-balancer-easy-deployment-scalability-and-high-availability-for-partner-appliances/</a></p>
</li>
<li><p><strong>GeneveProxy - an AWS Gateway Load Balancer reference application：</strong><a target="_blank" rel="noopener" href="https://www.sentiatechblog.com/geneveproxy-an-aws-gateway-load-balancer-reference-application">https://www.sentiatechblog.com/geneveproxy-an-aws-gateway-load-balancer-reference-application</a></p>
</li>
</ul>

    </div>
    
    <div class="post-footer">
        <div>
            
            转载声明：
            非商业转载请注明出处，商业转载请联系作者获得授权。
            
            
        </div>
        <div>
            
        </div>
    </div>
</article>
<div class="article-nav prev-next-wrap clearfix">
    
    <a href="/AWS-VPC-%E6%B5%81%E9%87%8F%E9%9B%86%E4%B8%AD%E6%A3%80%E6%B5%8B%E7%B3%BB%E5%88%97-2-%E5%88%A9%E7%94%A8CloudFormation%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2AWS-GWLB%E9%9B%86%E6%88%90Palo-Alto%E9%98%B2%E7%81%AB%E5%A2%99.html" class="pre-post btn btn-default" title='AWS VPC 流量集中检测系列--(2)利用CloudFormation自动化部署AWS GWLB集成Palo Alto防火墙'>
        <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
        <span class="hidden-xs">
            AWS VPC 流量集中检测系列--(2)利用CloudFormation自动化部署AWS GWLB集成Palo Alto防火墙</span>
    </a>
    
    
    <a href="/CloudFormation%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E8%BF%9B%E9%98%B6-3-Python%E6%93%8D%E4%BD%9CCloudFormation.html" class="next-post btn btn-default" title='AWS CloudFormation 系列--(3)Python操作CloudFormation'>
        <span class="hidden-lg">下一篇</span>
        <span class="hidden-xs">
            AWS CloudFormation 系列--(3)Python操作CloudFormation</span><i class="fa fa-angle-right fa-fw"></i>
    </a>
    
</div>

<div id="comments">
    

<div id="vcomments" class="valine"></div>

<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>

<script>
new Valine({
    av: AV,
    el: '#vcomments',
    appId: 'stf5rGD17bcrWN1mvUT4pu8C-gzGzoHsz',
    appKey: 'r5qpzBWMAzt2hDAcDftecM1R',
    placeholder: '说点什么吧',
    notify: false,
    verify: false,
    avatar: 'mm',
    meta: 'nick'.split(','),
    pageSize: '10',
    path: window.location.pathname,
    lang: 'zh-CN'.toLowerCase()
})
</script>


</div>

                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">
            文章目录
        </h3>
        
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E8%83%8C%E6%99%AF"><span class="toc-text">一、背景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E5%8F%82%E8%80%83%E7%9A%84%E5%8D%9A%E5%AE%A2"><span class="toc-text">1.1 参考的博客</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E6%B5%81%E9%87%8F%E9%9B%86%E4%B8%AD%E6%A3%80%E6%B5%8B"><span class="toc-text">1.2 流量集中检测</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%AE%9E%E9%AA%8C%E4%BB%8B%E7%BB%8D"><span class="toc-text">二、实验介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81-%E9%85%8D%E7%BD%AE%E9%83%A8%E7%BD%B2"><span class="toc-text">三、 配置部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-VPC-%E9%85%8D%E7%BD%AE"><span class="toc-text">3.1 VPC 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-1-%E5%88%9B%E5%BB%BAVPC"><span class="toc-text">3.1.1 创建VPC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-2-%E5%88%9B%E5%BB%BAIGW%E5%85%B3%E8%81%94VPC"><span class="toc-text">3.1.2 创建IGW关联VPC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-3-%E5%88%9B%E5%BB%BA%E5%AD%90%E7%BD%91"><span class="toc-text">3.1.3 创建子网</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-4-%E5%88%9B%E5%BB%BA%E8%B7%AF%E7%94%B1%E8%A1%A8"><span class="toc-text">3.1.4 创建路由表</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BE%8B"><span class="toc-text">3.2 创建实例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1-%E5%88%9B%E5%BB%BApaloalto%E5%AE%9E%E4%BE%8B"><span class="toc-text">3.2.1 创建paloalto实例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2-%E5%88%9B%E5%BB%BAAPP%E5%AE%9E%E4%BE%8B"><span class="toc-text">3.2.2 创建APP实例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E9%85%8D%E7%BD%AEpaloalto"><span class="toc-text">3.3 配置paloalto</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-1-paloalto%E4%BF%AE%E6%94%B9%E9%BB%98%E8%AE%A4%E5%AF%86%E7%A0%81"><span class="toc-text">3.3.1 paloalto修改默认密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-2-%E5%9B%BE%E5%BD%A2%E5%8C%96%E7%95%8C%E9%9D%A2%E9%85%8D%E7%BD%AEPA-FW1"><span class="toc-text">3.3.2 图形化界面配置PA-FW1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-3-%E5%91%BD%E4%BB%A4%E8%A1%8C%E9%85%8D%E7%BD%AEPA-FW2"><span class="toc-text">3.3.3 命令行配置PA-FW2</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E5%88%9B%E5%BB%BAGWLB%E5%B9%B6%E5%85%B3%E8%81%94paloalto"><span class="toc-text">3.4 创建GWLB并关联paloalto</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E5%88%9B%E5%BB%BAEndpoint-Service%E5%8F%8AEndpoint"><span class="toc-text">3.5 创建Endpoint Service及Endpoint</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-%E4%BF%AE%E6%94%B9%E8%B7%AF%E7%94%B1%E8%A1%A8"><span class="toc-text">3.6 修改路由表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E8%AE%BF%E9%97%AE%E6%B5%8B%E8%AF%95"><span class="toc-text">四、访问测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-App1-HTTP%E8%AE%BF%E9%97%AE%E6%B5%8B%E8%AF%95"><span class="toc-text">4.1 App1 HTTP访问测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-App2-RDP%E8%BF%9E%E6%8E%A5%E6%B5%8B%E8%AF%95"><span class="toc-text">4.2 App2 RDP连接测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E6%B8%85%E7%90%86%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83%E6%AD%A5%E9%AA%A4"><span class="toc-text">五、清理实验环境步骤</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3"><span class="toc-text">六、参考文档</span></a></li></ol>
        
    </div>
</aside>
                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>
<a id="back-to-top" class="icon-btn hide">
    <i class="fa fa-chevron-up"></i>
</a>
    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
    访问量:
    <strong id="busuanzi_value_site_pv">
        <i class="fa fa-spinner fa-spin"></i>
    </strong>
    &nbsp; | &nbsp;
    访客数:
    <strong id="busuanzi_value_site_uv">
        <i class="fa fa-spinner fa-spin"></i>
    </strong>
    
</div>
            </div>
            <div class="col-sm-12">
                <span>Copyright &copy;
                    2022
                    
                </span> |
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> |
                <span>
                    Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a>
                </span>
            </div>
        </div>
    </div>
</div>



<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<script src="/js/app.js?rev=@@hash.js"></script>

</body>
</html>