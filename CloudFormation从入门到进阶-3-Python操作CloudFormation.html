<!DOCTYPE HTML>
<html lang="zh-CN">

<head>
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="LiuQianglong&#39;s Blog">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.2.3">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="https://liuqianglong.com">
    <!--SEO-->

<meta name="keywords" content="AWS,CloudFormation" />


<meta name="description" content="B站视频链接：https://www.bilibili.com/video/BV1FG411773k/微信公众号：自刘地
前面两篇已经对CloudFormation做了快速入门和进阶的学习，但是..." />


<meta name="robots" content="all" />
<meta name="google" content="all" />
<meta name="googlebot" content="all" />
<meta name="verify" content="all" />
    <!--Title-->

<title>
    
    AWS CloudFormation 系列--(3)Python操作CloudFormation |
    
    LiuQianglong&#39;s Blog
</title>

<link rel="alternate" href="/atom.xml" title="LiuQianglong&#39;s Blog" type="application/atom+xml">


<link rel="icon" href="/favicon.ico">

    


<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7.css">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.7.0.css">
<link rel="stylesheet" href="/css/style.css?rev=@@hash.css">

    
<div class="hide">
    <script type="text/javascript">
    var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
    document.write(unescape("%3Cspan class='cnzz_stat_icon_1263868967 hide' %3E%3Cscript%20src%3D%22https%3A%2F%2Fs95.cnzz.com%2Fz_stat.php%3Fweb_id%3D1272564536%22%3E%3C%2Fscript%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s19.cnzz.com/z_stat.php%3Fid%3D1263868967%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
    </script>
</div>


<script>
var _hmt = _hmt || [];
(function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?5ded9cc2d3b5dca951b5a7b2ca26747d";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
})();
</script>



    

<meta name="generator" content="Hexo 5.3.0"></head>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->
<body>
    <header class="main-header"  >
    <div class="main-header-box">
        <a class="header-avatar" href="/" title='LiuQianglong'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a>
        <div class="branding">
            <!--<h2 class="text-hide">Snippet主题,从未如此简单有趣</h2>-->
            
            <img src="/img/branding.png" alt="Snippet 博客主题" class="img-responsive center-block">
            
        </div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                        <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="https://liuqianglong.com">
                        LiuQianglong&#39;s Blog</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                        <li role="presentation" class="text-center">
                            <a href="/"><i class="fa "></i>
                                首页</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/Network/"><i class="fa "></i>
                                Network</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/AWS/"><i class="fa "></i>
                                AWS</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/Python/"><i class="fa "></i>
                                Python</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/archives/"><i class="fa "></i>
                                时间轴</a>
                        </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="AWS CloudFormation 系列--(3)Python操作CloudFormation">
            
            AWS CloudFormation 系列--(3)Python操作CloudFormation
            
        </h1>
        <div class="post-meta">
    
    <span class="categories-meta fa-wrap">
        <i class="fa fa-folder-open-o"></i>
        <a class="category-link" href="/categories/AWS/">AWS</a>
    </span>
    
    
    <span class="fa-wrap">
        <i class="fa fa-tags"></i>
        <span class="tags-meta">
            
            <a class="tag-none-link" href="/tags/AWS/" rel="tag">AWS</a> <a class="tag-none-link" href="/tags/CloudFormation/" rel="tag">CloudFormation</a>
            
        </span>
    </span>
    
    
    
    <span class="fa-wrap">
        <i class="fa fa-clock-o"></i>
        <span class="date-meta">
            2022/10/12</span>
    </span>
    
    <span class="fa-wrap">
        <i class="fa fa-eye"></i>
        <span id="busuanzi_value_page_pv"></span>
    </span>
    
    
</div>
        
        
    </div>
    
    <div class="post-body post-content">
        <p><strong>B站视频链接：</strong><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1FG411773k/">https://www.bilibili.com/video/BV1FG411773k/</a><br><strong>微信公众号：</strong>自刘地<br><img src="/img/wechat.jpg" alt="自刘地"></p>
<p>前面两篇已经对CloudFormation做了快速入门和进阶的学习，但是在创建堆栈的时候，还是在AWS控制台界面导入文本文件。这个文章的目的是介绍如何使用Python来操作CloudFormation，进一步的实现自动化操作。</p>
<h2 id="一、AWS-凭证-Credentials"><a href="#一、AWS-凭证-Credentials" class="headerlink" title="一、AWS 凭证(Credentials)"></a>一、AWS 凭证(Credentials)</h2><h3 id="1-1、凭证介绍"><a href="#1-1、凭证介绍" class="headerlink" title="1.1、凭证介绍"></a>1.1、凭证介绍</h3><p>客户端必须拥有<u>凭证</u>[参考链接1]才能对AWS API进行操作，可以通过多种方式来配置凭证。<strong>配置凭证的最佳实践是，如果你在EC2上运行代码，建议使用IAM角色。如果你是用AWS开发工具包（例如Python），建议使用共享凭证文件</strong>。后面代码都是使用的共享凭证文件。</p>
<p>Boto3 将在搜索凭证时查找多个位置。Boto3 查找凭据的机制是搜索可能位置的列表，并在找到凭据后立即停止。Boto3 搜索凭据的顺序参考：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1.在boto.client()方法中将凭证作为参数传递</span><br><span class="line">2.创建Session对象时将凭证作为参数传递</span><br><span class="line">3.环境变量</span><br><span class="line">4.共享凭证文件 ( ~&#x2F;.aws&#x2F;credentials )</span><br><span class="line">5.AWS 配置文件 ( ~&#x2F;.aws&#x2F;config )</span><br><span class="line">6.担任角色提供者</span><br><span class="line">7.Boto2 配置文件（&#x2F;etc&#x2F;boto.cfg和~&#x2F;.boto）</span><br><span class="line">8.配置了 IAM 角色的 Amazon EC2 实例上的实例元数据服务。</span><br></pre></td></tr></table></figure>
<h3 id="1-2、AWS-CLI配置凭证"><a href="#1-2、AWS-CLI配置凭证" class="headerlink" title="1.2、AWS CLI配置凭证"></a>1.2、AWS CLI配置凭证</h3><p><u>安装AWS CLI</u>[参考链接2]客户端之后，可以利用<code>aws configure</code>快速配置凭证。需要提前从AWS控制台创建对应账号的AK(Access Key)和SK(Secret Key)。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ aws configure</span><br><span class="line">AWS Access Key ID [None]: AKIAIOSFODNN7EXAMPLE</span><br><span class="line">AWS Secret Access Key [None]: wJalrXUtnFEMI&#x2F;K7MDENG&#x2F;bPxRfiCYEXAMPLEKEY</span><br><span class="line">Default region name [None]: cn-northwest-1</span><br><span class="line">Default output format [None]: </span><br></pre></td></tr></table></figure>
<p>直接使用<code>aws configure</code>产生的是<code>default</code>配置文件，在没有明确指定配置文件时，就会使用default配置文件。你还可以使用<code>aws configure --profile cn-prod</code>来创建名称为cn-prod的配置文件。假设default配置的是测试账号信息，cn-prod配置的是生产账号信息，在不明确指定配置文件的情况下，代码会使用default配置，也就是测试环境的凭证。</p>
<p>配置凭证时，指定名称为<code>cn-prod</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ aws configure --profile cn-prod</span><br><span class="line">AWS Access Key ID [None]: AKIAI44QH8DHBEXAMPLE</span><br><span class="line">AWS Secret Access Key [None]: je7MtGbClwBF&#x2F;2Zp9Utk&#x2F;h3yCo8nvbEXAMPLEKEY</span><br><span class="line">Default region name [None]: cn-northwest-1</span><br><span class="line">Default output format [None]: </span><br></pre></td></tr></table></figure>
<p>AWS会将配置文件放在<code>.aws</code>文件夹中，这个文件夹默认在用户主目录下，例如Windows的路径<code>C:\Users\crosswalk\.aws</code>，Linux root用户路径<code>/root/.aws</code>。文件夹中会产生一个凭证配置文件<code>credentials</code>和一个Config配置文件<code>config</code>。</p>
<p>凭证配置文件<code>credentials</code>中具体的内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[default]</span><br><span class="line">aws_access_key_id&#x3D;AKIAIOSFODNN7EXAMPLE</span><br><span class="line">aws_secret_access_key&#x3D;wJalrXUtnFEMI&#x2F;K7MDENG&#x2F;bPxRfiCYEXAMPLEKEY</span><br><span class="line"></span><br><span class="line">[cn-prod]</span><br><span class="line">aws_access_key_id&#x3D;AKIAI44QH8DHBEXAMPLE</span><br><span class="line">aws_secret_access_key&#x3D;je7MtGbClwBF&#x2F;2Zp9Utk&#x2F;h3yCo8nvbEXAMPLEKEY</span><br></pre></td></tr></table></figure>
<p>Config配置文件<code>config</code>中的具体内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[default]</span><br><span class="line">region&#x3D;cn-northwest-1</span><br><span class="line"></span><br><span class="line">[profile cn-prod]</span><br><span class="line">region&#x3D;cn-northwest-1</span><br></pre></td></tr></table></figure>
<p>使用 <code>aws configure list-profiles</code> 命令列出所有配置文件名称。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\crosswalk&gt;aws configure list-profiles</span><br><span class="line">default</span><br><span class="line">cn-prod</span><br></pre></td></tr></table></figure>


<h3 id="1-3、AWS-CLI凭证测试"><a href="#1-3、AWS-CLI凭证测试" class="headerlink" title="1.3、AWS CLI凭证测试"></a>1.3、AWS CLI凭证测试</h3><p>使用默认凭证，查看测试账号下的EC2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\crosswalk&gt;aws ec2 describe-instances</span><br><span class="line">&#123;</span><br><span class="line">    &quot;Reservations&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;Groups&quot;: [],</span><br><span class="line">            &quot;Instances&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;AmiLaunchIndex&quot;: 0,</span><br><span class="line">                    &quot;ImageId&quot;: &quot;ami-007315f06e322f1ab&quot;,</span><br><span class="line">                    &quot;InstanceId&quot;: &quot;i-08fc1f70383191bb4&quot;,</span><br><span class="line">                    &quot;InstanceType&quot;: &quot;t2.2xlarge&quot;</span><br></pre></td></tr></table></figure>
<p>指定cn-prod凭证，查看生产账号下的EC2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\crosswalk&gt;aws ec2 describe-instances --profile cn-prod</span><br><span class="line">&#123;</span><br><span class="line">    &quot;Reservations&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;Groups&quot;: [],</span><br><span class="line">            &quot;Instances&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;AmiLaunchIndex&quot;: 0,</span><br><span class="line">                    &quot;ImageId&quot;: &quot;ami-7c9f8b1e&quot;,</span><br><span class="line">                    &quot;InstanceId&quot;: &quot;i-099540680995ce588&quot;,</span><br><span class="line">                    &quot;InstanceType&quot;: &quot;t2.medium&quot;,</span><br></pre></td></tr></table></figure>


<h3 id="1-4、boto3-切换凭证测试"><a href="#1-4、boto3-切换凭证测试" class="headerlink" title="1.4、boto3 切换凭证测试"></a>1.4、boto3 切换凭证测试</h3><p>你可以在创建<u>Session</u>[参考链接3]时通过<code>profile_name</code>参数指定凭证配置文件名称。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">profile_name = <span class="string">&#x27;my-global&#x27;</span></span><br><span class="line">my_region = <span class="string">&#x27;cn-northwest-1&#x27;</span></span><br><span class="line"></span><br><span class="line">session = boto3.Session(profile_name=profile_name, region_name=my_region)</span><br><span class="line">dev_s3_client = session.client(<span class="string">&#x27;s3&#x27;</span>)</span><br></pre></td></tr></table></figure>


<p>在创建脚本时，开头定义使用的凭证名称。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">profile_name = <span class="string">&#x27;cn-prod&#x27;</span></span><br><span class="line">my_region = <span class="string">&#x27;cn-northwest-1&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cfn_create_stack</span>(<span class="params">stackname, file_path</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;创建堆栈&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">import</span> boto3</span><br><span class="line">    session = boto3.Session(profile_name=profile_name, region_name=my_region)</span><br><span class="line">    client = session.client(<span class="string">&#x27;cloudformation&#x27;</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">f&quot;<span class="subst">&#123;file_path&#125;</span>&quot;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;UTF-8&#x27;</span>) <span class="keyword">as</span> fd:    <span class="comment"># 读取CloudFormation YAML文件内容</span></span><br><span class="line">        templatebody = fd.read()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        client.create_stack(StackName=<span class="string">f&quot;<span class="subst">&#123;stackname&#125;</span>&quot;</span>, Capabilities=[<span class="string">&#x27;CAPABILITY_IAM&#x27;</span>], TemplateBody=templatebody)</span><br><span class="line">        print(<span class="string">f&#x27;[&quot;<span class="subst">&#123;stackname&#125;</span>&quot;堆栈创建成功]&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="string">f&#x27;[&quot;<span class="subst">&#123;stackname&#125;</span>&quot;堆栈创建失败]&#x27;</span>)</span><br><span class="line">        print(e)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    cft_create_stack(<span class="string">&#x27;vpc-stack-test&#x27;</span>, <span class="string">&#x27;vpc-test.yaml&#x27;</span>)</span><br></pre></td></tr></table></figure>


<h2 id="二、Python-Boto3操作CloudFormation代码参考"><a href="#二、Python-Boto3操作CloudFormation代码参考" class="headerlink" title="二、Python Boto3操作CloudFormation代码参考"></a>二、Python Boto3操作CloudFormation代码参考</h2><p>利用Python3的<code>Boto3</code>模块，就可以完成AWS上的所有API操作，具体可以参考<u>boto3 CloudFormaionl</u>[参考链接4]，查看API的详细参数。</p>
<p>写一个用于测试脚本的CloudFormation模板<code>vpc-test.yaml</code>，创建一个VPC并且输出VPC的ID信息。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Resources:</span></span><br><span class="line">  <span class="attr">MyTestVpc:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::EC2::VPC</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">CidrBlock:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line">      <span class="attr">EnableDnsSupport:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">      <span class="attr">EnableDnsHostnames:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">      <span class="attr">Tags:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">Key:</span> <span class="string">Name</span></span><br><span class="line">         <span class="attr">Value:</span> <span class="string">MyTestVpc</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Outputs:</span></span><br><span class="line">  <span class="attr">MyTestVpc:</span></span><br><span class="line">    <span class="attr">Description:</span> <span class="string">MyTestVpc</span></span><br><span class="line">    <span class="attr">Value:</span> <span class="type">!Ref</span> <span class="string">MyTestVpc</span></span><br><span class="line">    <span class="attr">Export:</span></span><br><span class="line">      <span class="attr">Name:</span> <span class="string">MyTestVpc-ID</span></span><br></pre></td></tr></table></figure>


<h3 id="2-1、创建堆栈"><a href="#2-1、创建堆栈" class="headerlink" title="2.1、创建堆栈"></a>2.1、创建堆栈</h3><p>脚本需要指定堆栈的名称和模板的路径。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">profile_name = <span class="string">&#x27;cn-prod&#x27;</span></span><br><span class="line">my_region = <span class="string">&#x27;cn-northwest-1&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cfn_create_stack</span>(<span class="params">stackname, file_path</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;创建堆栈&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">import</span> boto3</span><br><span class="line">    session = boto3.Session(profile_name=profile_name, region_name=my_region)</span><br><span class="line">    client = session.client(<span class="string">&#x27;cloudformation&#x27;</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">f&quot;<span class="subst">&#123;file_path&#125;</span>&quot;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;UTF-8&#x27;</span>) <span class="keyword">as</span> fd:    <span class="comment"># 读取CloudFormation YAML文件内容</span></span><br><span class="line">        templatebody = fd.read()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        client.create_stack(StackName=<span class="string">f&quot;<span class="subst">&#123;stackname&#125;</span>&quot;</span>, Capabilities=[<span class="string">&#x27;CAPABILITY_IAM&#x27;</span>], TemplateBody=templatebody)</span><br><span class="line">        print(<span class="string">f&#x27;[&quot;<span class="subst">&#123;stackname&#125;</span>&quot;堆栈创建成功]&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="string">f&#x27;[&quot;<span class="subst">&#123;stackname&#125;</span>&quot;堆栈创建失败]&#x27;</span>)</span><br><span class="line">        print(e)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    cft_create_stack(<span class="string">&#x27;vpc-stack-test&#x27;</span>, <span class="string">&#x27;vpc-test.yaml&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>代码输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&quot;vpc-stack-test&quot;堆栈创建成功]</span><br></pre></td></tr></table></figure>


<h3 id="2-2、获取堆栈输出"><a href="#2-2、获取堆栈输出" class="headerlink" title="2.2、获取堆栈输出"></a>2.2、获取堆栈输出</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">profile_name = <span class="string">&#x27;cn-prod&#x27;</span></span><br><span class="line">my_region = <span class="string">&#x27;cn-northwest-1&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cfn_stack_output</span>(<span class="params">stackname</span>):</span>    <span class="comment"># 当堆栈完成后获取输出</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;获取堆栈输出内容&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">import</span> time</span><br><span class="line">    <span class="keyword">import</span> boto3</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        nowtime = time.strftime(<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>, time.localtime())</span><br><span class="line">        session = boto3.Session(profile_name=profile_name, region_name=my_region)</span><br><span class="line">        client = session.client(<span class="string">&#x27;cloudformation&#x27;</span>)</span><br><span class="line">        response = client.describe_stacks(StackName=stackname)</span><br><span class="line">        <span class="keyword">if</span> response[<span class="string">&#x27;Stacks&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;StackStatus&#x27;</span>] == <span class="string">&#x27;CREATE_COMPLETE&#x27;</span>:</span><br><span class="line">            response = client.describe_stacks(StackName=stackname)</span><br><span class="line">            outputs = response[<span class="string">&quot;Stacks&quot;</span>][<span class="number">0</span>][<span class="string">&quot;Outputs&quot;</span>]</span><br><span class="line">            print(<span class="string">f&#x27;[<span class="subst">&#123;nowtime&#125;</span>] Stack Create Complete!&#x27;</span>)</span><br><span class="line">            print(outputs)</span><br><span class="line">            <span class="keyword">return</span> outputs</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br><span class="line">            print(<span class="string">f&#x27;[<span class="subst">&#123;nowtime&#125;</span>] Wait Stack Complete...&#x27;</span>)</span><br><span class="line">            </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># cft_create_stack(&#x27;vpc-stack-test&#x27;, &#x27;vpc-test.yaml&#x27;)</span></span><br><span class="line">    cfn_stack_output(<span class="string">&#x27;vpc-stack-test&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>代码输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[2022-04-02 11:51:26] Stack Create Complete!</span><br><span class="line">[&#123;&#39;OutputKey&#39;: &#39;MyTestVpc&#39;, &#39;OutputValue&#39;: &#39;vpc-0e764b67068222644&#39;, &#39;Description&#39;: &#39;MyTestVpc&#39;, &#39;ExportName&#39;: &#39;MyTestVpc-ID&#39;&#125;]</span><br></pre></td></tr></table></figure>


<h3 id="2-3、删除堆栈"><a href="#2-3、删除堆栈" class="headerlink" title="2.3、删除堆栈"></a>2.3、删除堆栈</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">profile_name = <span class="string">&#x27;cn-prod&#x27;</span></span><br><span class="line">my_region = <span class="string">&#x27;cn-northwest-1&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cfn_delete_stack</span>(<span class="params">stackname</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;删除堆栈&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">import</span> boto3</span><br><span class="line">    session = boto3.Session(profile_name=profile_name, region_name=my_region)</span><br><span class="line">    client = session.client(<span class="string">&#x27;cloudformation&#x27;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        rsp = client.delete_stack(StackName=stackname)</span><br><span class="line">        print(<span class="string">f&#x27;[&quot;<span class="subst">&#123;stackname&#125;</span>&quot;堆栈删除成功]&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="string">f&#x27;[&quot;<span class="subst">&#123;stackname&#125;</span>&quot;堆栈删除失败]&#x27;</span>)</span><br><span class="line">        print(e)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># cft_create_stack(&#x27;vpc-stack-test&#x27;, &#x27;vpc-test.yaml&#x27;)</span></span><br><span class="line">    <span class="comment"># cfn_stack_output(&#x27;vpc-stack-test&#x27;)</span></span><br><span class="line">    cfn_delete_stack(<span class="string">&#x27;vpc-stack-test&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>代码输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&quot;vpc-stack-test&quot;堆栈删除成功]</span><br></pre></td></tr></table></figure>


<h2 id="三、参考文档"><a href="#三、参考文档" class="headerlink" title="三、参考文档"></a>三、参考文档</h2><ul>
<li>[1] AWS Credentials：<a target="_blank" rel="noopener" href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/credentials.html">https://boto3.amazonaws.com/v1/documentation/api/latest/guide/credentials.html</a></li>
<li>[2] 安装或更新最新版本的 AWS CLI：<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/cli/latest/userguide/getting-started-install.html">https://docs.aws.amazon.com/zh_cn/cli/latest/userguide/getting-started-install.html</a></li>
<li>[3] AWS Session reference：<a target="_blank" rel="noopener" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/core/session.html">https://boto3.amazonaws.com/v1/documentation/api/latest/reference/core/session.html</a></li>
<li>[4] AWS Boto3 CloudFormation：<a target="_blank" rel="noopener" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/cloudformation.html">https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/cloudformation.html</a></li>
</ul>

    </div>
    
    <div class="post-footer">
        <div>
            
            转载声明：
            非商业转载请注明出处，商业转载请联系作者获得授权。
            
            
        </div>
        <div>
            
        </div>
    </div>
</article>
<div class="article-nav prev-next-wrap clearfix">
    
    <a href="/AWS-VPC-%E6%B5%81%E9%87%8F%E9%9B%86%E4%B8%AD%E6%A3%80%E6%B5%8B%E7%B3%BB%E5%88%97-1-AWS-GWLB%E9%9B%86%E6%88%90paloalto%E9%98%B2%E7%81%AB%E5%A2%99.html" class="pre-post btn btn-default" title='AWS VPC 流量集中检测系列--(1)AWS GWLB集成paloalto防火墙'>
        <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
        <span class="hidden-xs">
            AWS VPC 流量集中检测系列--(1)AWS GWLB集成paloalto防火墙</span>
    </a>
    
    
    <a href="/CloudFormation%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E8%BF%9B%E9%98%B6-2-%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0%E5%8F%8A%E5%AD%97%E6%AE%B5.html" class="next-post btn btn-default" title='AWS CloudFormation 系列--(2)常用函数及字段'>
        <span class="hidden-lg">下一篇</span>
        <span class="hidden-xs">
            AWS CloudFormation 系列--(2)常用函数及字段</span><i class="fa fa-angle-right fa-fw"></i>
    </a>
    
</div>

<div id="comments">
    

<div id="vcomments" class="valine"></div>

<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>

<script>
new Valine({
    av: AV,
    el: '#vcomments',
    appId: 'stf5rGD17bcrWN1mvUT4pu8C-gzGzoHsz',
    appKey: 'r5qpzBWMAzt2hDAcDftecM1R',
    placeholder: '说点什么吧',
    notify: false,
    verify: false,
    avatar: 'mm',
    meta: 'nick'.split(','),
    pageSize: '10',
    path: window.location.pathname,
    lang: 'zh-CN'.toLowerCase()
})
</script>


</div>

                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">
            文章目录
        </h3>
        
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81AWS-%E5%87%AD%E8%AF%81-Credentials"><span class="toc-text">一、AWS 凭证(Credentials)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1%E3%80%81%E5%87%AD%E8%AF%81%E4%BB%8B%E7%BB%8D"><span class="toc-text">1.1、凭证介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2%E3%80%81AWS-CLI%E9%85%8D%E7%BD%AE%E5%87%AD%E8%AF%81"><span class="toc-text">1.2、AWS CLI配置凭证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3%E3%80%81AWS-CLI%E5%87%AD%E8%AF%81%E6%B5%8B%E8%AF%95"><span class="toc-text">1.3、AWS CLI凭证测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4%E3%80%81boto3-%E5%88%87%E6%8D%A2%E5%87%AD%E8%AF%81%E6%B5%8B%E8%AF%95"><span class="toc-text">1.4、boto3 切换凭证测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81Python-Boto3%E6%93%8D%E4%BD%9CCloudFormation%E4%BB%A3%E7%A0%81%E5%8F%82%E8%80%83"><span class="toc-text">二、Python Boto3操作CloudFormation代码参考</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%E3%80%81%E5%88%9B%E5%BB%BA%E5%A0%86%E6%A0%88"><span class="toc-text">2.1、创建堆栈</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2%E3%80%81%E8%8E%B7%E5%8F%96%E5%A0%86%E6%A0%88%E8%BE%93%E5%87%BA"><span class="toc-text">2.2、获取堆栈输出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3%E3%80%81%E5%88%A0%E9%99%A4%E5%A0%86%E6%A0%88"><span class="toc-text">2.3、删除堆栈</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3"><span class="toc-text">三、参考文档</span></a></li></ol>
        
    </div>
</aside>
                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>
<a id="back-to-top" class="icon-btn hide">
    <i class="fa fa-chevron-up"></i>
</a>
    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
    访问量:
    <strong id="busuanzi_value_site_pv">
        <i class="fa fa-spinner fa-spin"></i>
    </strong>
    &nbsp; | &nbsp;
    访客数:
    <strong id="busuanzi_value_site_uv">
        <i class="fa fa-spinner fa-spin"></i>
    </strong>
    
</div>
            </div>
            <div class="col-sm-12">
                <span>Copyright &copy;
                    2022
                    
                </span> |
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> |
                <span>
                    Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a>
                </span>
            </div>
        </div>
    </div>
</div>



<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<script src="/js/app.js?rev=@@hash.js"></script>

</body>
</html>