<!DOCTYPE HTML>
<html lang="zh-CN">

<head>
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="LiuQianglong&#39;s Blog">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.2.3">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="https://liuqianglong.com">
    <!--SEO-->

<meta name="keywords" content="AWS,CloudFormation" />


<meta name="description" content="这篇文章给大家介绍AWS CloudFormation这个服务，帮助大家系统性的从入门到进阶的学习。要使用AWS CloudFormation这个服务，需要对AWS的EC2、子网、路由、VPC等..." />


<meta name="robots" content="all" />
<meta name="google" content="all" />
<meta name="googlebot" content="all" />
<meta name="verify" content="all" />
    <!--Title-->

<title>
    
    AWS CloudFormation从入门到进阶 |
    
    LiuQianglong&#39;s Blog
</title>

<link rel="alternate" href="/atom.xml" title="LiuQianglong&#39;s Blog" type="application/atom+xml">


<link rel="icon" href="/favicon.ico">

    


<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7.css">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.7.0.css">
<link rel="stylesheet" href="/css/style.css?rev=@@hash.css">

    
<div class="hide">
    <script type="text/javascript">
    var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
    document.write(unescape("%3Cspan class='cnzz_stat_icon_1263868967 hide' %3E%3Cscript%20src%3D%22https%3A%2F%2Fs95.cnzz.com%2Fz_stat.php%3Fweb_id%3D1272564536%22%3E%3C%2Fscript%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s19.cnzz.com/z_stat.php%3Fid%3D1263868967%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
    </script>
</div>


<script>
var _hmt = _hmt || [];
(function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?5ded9cc2d3b5dca951b5a7b2ca26747d";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
})();
</script>



    

<meta name="generator" content="Hexo 5.3.0"></head>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->
<body>
    <header class="main-header"  >
    <div class="main-header-box">
        <a class="header-avatar" href="/" title='LiuQianglong'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a>
        <div class="branding">
            <!--<h2 class="text-hide">Snippet主题,从未如此简单有趣</h2>-->
            
            <img src="/img/branding.png" alt="Snippet 博客主题" class="img-responsive center-block">
            
        </div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                        <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="https://liuqianglong.com">
                        LiuQianglong&#39;s Blog</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                        <li role="presentation" class="text-center">
                            <a href="/"><i class="fa "></i>
                                首页</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/Network/"><i class="fa "></i>
                                Network</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/AWS/"><i class="fa "></i>
                                AWS</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/Python/"><i class="fa "></i>
                                Python</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/archives/"><i class="fa "></i>
                                时间轴</a>
                        </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="AWS CloudFormation从入门到进阶">
            
            AWS CloudFormation从入门到进阶
            
        </h1>
        <div class="post-meta">
    
    <span class="categories-meta fa-wrap">
        <i class="fa fa-folder-open-o"></i>
        <a class="category-link" href="/categories/AWS/">AWS</a>
    </span>
    
    
    <span class="fa-wrap">
        <i class="fa fa-tags"></i>
        <span class="tags-meta">
            
            <a class="tag-none-link" href="/tags/AWS/" rel="tag">AWS</a> <a class="tag-none-link" href="/tags/CloudFormation/" rel="tag">CloudFormation</a>
            
        </span>
    </span>
    
    
    
    <span class="fa-wrap">
        <i class="fa fa-clock-o"></i>
        <span class="date-meta">
            2022/08/11</span>
    </span>
    
    <span class="fa-wrap">
        <i class="fa fa-eye"></i>
        <span id="busuanzi_value_page_pv"></span>
    </span>
    
    
</div>
        
        
    </div>
    
    <div class="post-body post-content">
        <p>这篇文章给大家介绍AWS CloudFormation这个服务，帮助大家系统性的从入门到进阶的学习。要使用AWS CloudFormation这个服务，需要对AWS的EC2、子网、路由、VPC等这些基本服务有过了解。</p>
<p>Bilibili有视频讲解演示<a target="_blank" rel="noopener" href="https://space.bilibili.com/408773931">https://space.bilibili.com/408773931</a></p>
<h2 id="1、CloudFormation-简介"><a href="#1、CloudFormation-简介" class="headerlink" title="1、CloudFormation 简介"></a>1、CloudFormation 简介</h2><h3 id="1-1、AWS-Console-操作遇到的问题"><a href="#1-1、AWS-Console-操作遇到的问题" class="headerlink" title="1.1、AWS Console 操作遇到的问题"></a>1.1、AWS Console 操作遇到的问题</h3><p>首先，回顾一下在AWS Console上的操作会遇到的几个问题：</p>
<p>1、无法快速做重复性配置。例如你给测试环境创建了VPC、子网、路由，到了生产环境还需要进行重复性的操作。</p>
<p>2、无法批量操作。例如经常会遇到创建VPC来做实验，做完以后没法批量的把对应的资源都删掉，如果遗留下一个EIP没有删除，那都是费用啊。</p>
<p>3、没有版本控制。在AWS Console上的操作，是没法记录当前的配置状态的，也没法回到指定的一个配置状态。</p>
<p>AWS CloudFormation 可以很好的解决上面的几个问题。</p>
<h3 id="1-2、什么是-CloudFormation"><a href="#1-2、什么是-CloudFormation" class="headerlink" title="1.2、什么是 CloudFormation"></a>1.2、什么是 CloudFormation</h3><p>首先快速的对AWS CloudFormation做一个简介，利用AWS CloudFormation服务，可以让你通过配置文件来创建AWS的基础架构。那么什么是基础架构？VPC、子网、路由表，EC2实例等等这些都算作基础架构，你在EC2实例里面部署的应用就不是基础架构。那么为什么不在AWS Console界面直接创建资源，而是通过基础架构即代码(IaC)来创建，主要有三个优势：</p>
<p>1、代码文件是可以复用的。例如当业务要上线时，在测试环境下创建的CloudFormation代码，很容易就迁移到生产环境，省去了很多重复性的操作。</p>
<p>2、CloudFormation可以批量操作。通过使用 CloudFormation，你可以轻松地将一组资源作为一个堆栈进行管理。删除堆栈，里面的资源都会被删除。</p>
<p>3、代码文件可以做版本控制。因为CloudFormation是文本文件，所以可以像代码管理一样，利用git来管理CloudFormation的模板文件，了解所做的更改。并且进行回滚操作。</p>
<h3 id="1-3、CloudFormation-模板介绍"><a href="#1-3、CloudFormation-模板介绍" class="headerlink" title="1.3、CloudFormation 模板介绍"></a>1.3、CloudFormation 模板介绍</h3><p>CloudFormation 模板就是你需要写的代码文件，模板是 JSON 或 YAML 格式的文本文件，你可以指定任何的扩展名称，例如.txt，后缀名并不会影响内容的读取。</p>
<p>下面是在模板里面定义创建一个VPC，分别用JSON和YAML格式来展现。JSON和YAML格式是可以相互转换的，因为<strong>YAML支持注释功能</strong>，所以我更习惯使用YAML格式来写模板，之后的CloudFormation模板的代码我都会使用YAML格式来写。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&quot;MyTestVpc&quot; : &#123;</span><br><span class="line">   &quot;Type&quot; : &quot;AWS::EC2::VPC&quot;,</span><br><span class="line">   &quot;Properties&quot; : &#123;</span><br><span class="line">      &quot;CidrBlock&quot; : &quot;10.0.0.0/16&quot;,</span><br><span class="line">      &quot;EnableDnsSupport&quot; : &quot;true&quot;,</span><br><span class="line">      &quot;EnableDnsHostnames&quot; : &quot;true&quot;,</span><br><span class="line">      &quot;Tags&quot; : [ </span><br><span class="line">         &#123;<span class="attr">&quot;Key&quot;</span> : <span class="string">&quot;Name&quot;</span>, <span class="attr">&quot;Value&quot;</span> : <span class="string">&quot;MyTestVpc&quot;</span>&#125; </span><br><span class="line">      ]</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>YAML格式写起来更加简单，你可以写单引号、双引号、不写引号，都是一样的。我一般不写引号，除非字符较多，会通过引号来分隔字符。YAML和Python语法一样，不同的层级，通过缩进来区分，注意YAML冒号后面有一个空格。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建VPC</span></span><br><span class="line"><span class="attr">MyTestVpc:</span></span><br><span class="line">  <span class="attr">Type:</span> <span class="string">AWS::EC2::VPC</span></span><br><span class="line">  <span class="attr">Properties:</span></span><br><span class="line">    <span class="attr">CidrBlock:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line">    <span class="attr">EnableDnsSupport:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">EnableDnsHostnames:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">Tags:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">Key:</span> <span class="string">Name</span></span><br><span class="line">       <span class="attr">Value:</span> <span class="string">MyTestVpc</span></span><br></pre></td></tr></table></figure>


<h3 id="1-4、CloudFormation-模板字段"><a href="#1-4、CloudFormation-模板字段" class="headerlink" title="1.4、CloudFormation 模板字段"></a>1.4、CloudFormation 模板字段</h3><p>下面是CloudFormation模板的所有参数，这里只会介绍模板几个重要的参数，其他参考大家可以自己看文档<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/template-anatomy.html">模板剖析</a>。</p>
<p>前面提到过模板支持JSON和YAML两种格式，YAML格式可以添加注释，所以这里模板的格式都是YAML，YAML文件用<code>---</code>表示开头，一般省略不写。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">AWSTemplateFormatVersion:</span> <span class="string">&quot;version date&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Description:</span></span><br><span class="line">  <span class="string">String</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Metadata:</span></span><br><span class="line">  <span class="string">template</span> <span class="string">metadata</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Parameters:</span></span><br><span class="line">  <span class="string">set</span> <span class="string">of</span> <span class="string">parameters</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Rules:</span></span><br><span class="line">  <span class="string">set</span> <span class="string">of</span> <span class="string">rules</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Mappings:</span></span><br><span class="line">  <span class="string">set</span> <span class="string">of</span> <span class="string">mappings</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Conditions:</span></span><br><span class="line">  <span class="string">set</span> <span class="string">of</span> <span class="string">conditions</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Transform:</span></span><br><span class="line">  <span class="string">set</span> <span class="string">of</span> <span class="string">transforms</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Resources:</span></span><br><span class="line">  <span class="string">set</span> <span class="string">of</span> <span class="string">resources</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Outputs:</span></span><br><span class="line">  <span class="string">set</span> <span class="string">of</span> <span class="string">outputs</span></span><br></pre></td></tr></table></figure>
<p><code>Resources</code>：这是<strong>唯一的必选字段</strong>，定义模板要创建哪些资源，例如创建VPC、EC2等，这是模板的主要作用，模板里面其他字段都可以不填写，但是必须定义资源字段。</p>
<p><code>Outputs</code>：这是比较常用的字段，用来输出你感兴趣的堆栈输出信息，例如输出EC2的公有IP地址、输出服务器的URL。当想要实现的功能比较复杂时，一般将需求拆分为多个堆栈，这个输出结果也可以被其他堆栈调用。</p>
<p><code>Mappings</code>：可用来指定一些键值对，后续利用Fn::FindInMap内部函数调用这些键值对，例如不同区域的AMI ID不一样，可以通过映射提前定义好每一个区域的AMI ID，这样模板里面的实例就可以部署在任何区域了。</p>
<p><code>Parameters</code>：模板往往会有一些变量，例如不同账号的SSH Key并不相同，可以设置参数，让用户自己指定SSH Key，后续EC2的SSH Key调用这个变量即可。</p>
<h3 id="1-5、CloudFormation-资源字段属性"><a href="#1-5、CloudFormation-资源字段属性" class="headerlink" title="1.5、CloudFormation 资源字段属性"></a>1.5、CloudFormation 资源字段属性</h3><p>首先来看最重要的<code>Resources</code>字段，这个字段下面会有很多属性，而且不同的服务类型，属性参数并不一样。这些属性不需要你刻意去记忆， 主要还是明确需求之后，去查看文档<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/aws-template-resource-type-ref.html">资源和属性类型参考</a>。</p>
<p>这里通过一个实际的需求来看如何写CloudFormation的模板：创建一个VPC，内部创建一个EC2实例，能通过IGW访问互联网。</p>
<p>例如创建一个VPC，就去查询VPC这个服务有哪些属性字段，<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-vpc.html">AWS::EC2::VPC</a></p>
<p><code>MyTestVpc</code>是我起的一个名字，称为逻辑ID，注意命名不能有中横线和下划线。</p>
<p><code>AWS::EC2::VPC</code>表示创建的资源类型。资源类型标识符总是采用这个格式：<code>service-provider::service-name::data-type-name</code>。</p>
<p><code>10.0.0.0/16</code>是为VPC分配的CIDR地址段，这是一个必选属性。创建一个资源时，脑海里面可以回顾AWS Console的操作，一般控制台界面必选的参数，在CloudFormation模板里面也会是必选。如果你需要修改某些特殊属性，但是不知道属性名称，那就需要查看文档<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-vpc.html">AWS::EC2::VPC</a>了。</p>
<p><code>Tags</code>标签参数应该不会陌生，因为可以添加多个标签，<code>-</code>表示列表，可以添加多个标签。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个VPC</span></span><br><span class="line">  <span class="attr">MyTestVpc:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::EC2::VPC</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">CidrBlock:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line">      <span class="attr">EnableDnsSupport:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">      <span class="attr">EnableDnsHostnames:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">      <span class="attr">Tags:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">Key:</span> <span class="string">Name</span></span><br><span class="line">         <span class="attr">Value:</span> <span class="string">MyTestVpc</span></span><br></pre></td></tr></table></figure>


<p>继续看，创建IGW并且关联到VPC：<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-internetgateway.html">AWS::EC2::InternetGateway</a></p>
<p>这里创建了一个IGW并且关联到了上面创建的VPC。这里将IGW关联到VPC时，用到了<code>Ref</code>这个函数。Ref函数可以返回指定的<em>参数</em>或<em>资源</em>的值。例如你需要查看<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-vpc.html">AWS::EC2::VPC</a>就可以知道，它返回的是<code>VpcId</code>信息。</p>
<p>这里使用了Ref函数的短格式写法，可以写在一行<code>!Ref logicalName</code>，第二部分会专门介绍各种函数的用法。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建IGW并且关联到VPC</span></span><br><span class="line">  <span class="attr">MyTestIgw:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">&quot;AWS::EC2::InternetGateway&quot;</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">Tags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">Key:</span> <span class="string">Name</span></span><br><span class="line">          <span class="attr">Value:</span> <span class="string">my-test-igw</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">MyTestAttachIgw:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">&quot;AWS::EC2::VPCGatewayAttachment&quot;</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">VpcId:</span> <span class="type">!Ref</span> <span class="string">MyTestVpc</span></span><br><span class="line">      <span class="attr">InternetGatewayId:</span> <span class="type">!Ref</span> <span class="string">MyTestIgw</span></span><br></pre></td></tr></table></figure>


<p>在VPC里面创建子网：<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-subnet.html">AWS::EC2::Subnet</a></p>
<p>这里子网需要指定<code>VpcId</code>，可以使用<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-ref.html">Ref内部函数</a>来获取这个信息。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在VPC内创建子网</span></span><br><span class="line">  <span class="attr">MyTestVpcSubnet:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::EC2::Subnet</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">VpcId:</span> <span class="type">!Ref</span> <span class="string">MyTestVpc</span></span><br><span class="line">      <span class="attr">CidrBlock:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line">      <span class="attr">AvailabilityZone:</span> <span class="string">cn-northwest-1a</span></span><br><span class="line">      <span class="attr">Tags:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">Key:</span> <span class="string">Name</span></span><br><span class="line">        <span class="attr">Value:</span> <span class="string">my-test-vpc-public-subnet</span></span><br></pre></td></tr></table></figure>


<p>在VPC内创建路由表并关联到子网，路由表设置默认路由指向IGW：<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-routetable.html">AWS::EC2::RouteTable</a>、<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-route.html">AWS::EC2::Route</a>、<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-subnetroutetableassociation.html">AWS::EC2::SubnetRouteTableAssociation</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># VPC内创建路由表并关联到子网，路由表设置默认路由指向IGW</span></span><br><span class="line">  <span class="attr">MyTestPublicRouteTable:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">&quot;AWS::EC2::RouteTable&quot;</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">VpcId:</span> <span class="type">!Ref</span> <span class="string">IpsecTsVpc</span></span><br><span class="line">      <span class="attr">Tags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">Key:</span> <span class="string">Name</span></span><br><span class="line">          <span class="attr">Value:</span> <span class="string">my-test-public-route-table</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">MyTestRouteTableAssociation:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">&quot;AWS::EC2::SubnetRouteTableAssociation&quot;</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">RouteTableId:</span> <span class="type">!Ref</span> <span class="string">MyTestPublicRouteTable</span></span><br><span class="line">      <span class="attr">SubnetId:</span> <span class="type">!Ref</span> <span class="string">MyTestVpcSubnet</span></span><br><span class="line">      </span><br><span class="line">  <span class="attr">MyTestInternetRoute:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">&quot;AWS::EC2::Route&quot;</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">     <span class="attr">RouteTableId:</span> <span class="type">!Ref</span> <span class="string">MyTestPublicRouteTable</span></span><br><span class="line">     <span class="attr">DestinationCidrBlock:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span></span><br><span class="line">     <span class="attr">GatewayId:</span> <span class="type">!Ref</span> <span class="string">MyTestIgw</span></span><br></pre></td></tr></table></figure>


<p>在VPC内创建一个安全组：<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-security-group.html">AWS::EC2::SecurityGroup</a></p>
<p>安全组里面数字<code>-1</code>表示允许所有。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在VPC内创建一个安全组</span></span><br><span class="line">  <span class="attr">MyTestVpcSg:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::EC2::SecurityGroup</span></span><br><span class="line">    <span class="attr">DependsOn:</span> <span class="string">MyTestVpc</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">GroupDescription:</span> <span class="string">SG</span> <span class="string">to</span> <span class="string">test</span> <span class="string">ping</span></span><br><span class="line">      <span class="attr">VpcId:</span> <span class="type">!Ref</span> <span class="string">MyTestVpc</span></span><br><span class="line">      <span class="attr">SecurityGroupIngress:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">IpProtocol:</span> <span class="string">tcp</span></span><br><span class="line">        <span class="attr">FromPort:</span> <span class="number">22</span></span><br><span class="line">        <span class="attr">ToPort:</span> <span class="number">22</span></span><br><span class="line">        <span class="attr">CidrIp:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">IpProtocol:</span> <span class="string">icmp</span></span><br><span class="line">        <span class="attr">FromPort:</span> <span class="number">-1</span></span><br><span class="line">        <span class="attr">ToPort:</span> <span class="number">-1</span></span><br><span class="line">        <span class="attr">CidrIp:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">IpProtocol:</span> <span class="string">tcp</span></span><br><span class="line">        <span class="attr">FromPort:</span> <span class="number">8443</span></span><br><span class="line">        <span class="attr">ToPort:</span> <span class="number">8443</span></span><br><span class="line">        <span class="attr">CidrIp:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span></span><br></pre></td></tr></table></figure>


<p>创建一个EC2实例：<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-instance.html">AWS::EC2::Instance</a></p>
<p>指定了EC2的AMI ID，可以通过控制台查询AMI ID。需要确认账号下存在<code>MyCN-CloudFormation-Test-Key</code>这个密钥对信息。设置实例类型为<code>t3.small</code>。另外接口设置自动获取公网IP地址、因为是第一个主接口，所以编号为<code>0</code>、接口关联之前创建的安全组、接口放置之前创建的子网内。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个EC2实例</span></span><br><span class="line">  <span class="attr">MyTestEc2Instance:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::EC2::Instance</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">ImageId:</span> <span class="string">ami-003a3de8892ecbc45</span></span><br><span class="line">      <span class="attr">KeyName:</span> <span class="string">MyCN-CloudFormation-Test-Key</span></span><br><span class="line">      <span class="attr">InstanceType:</span> <span class="string">t3.small</span></span><br><span class="line">      <span class="attr">NetworkInterfaces:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">AssociatePublicIpAddress:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">DeviceIndex:</span> <span class="number">0</span></span><br><span class="line">          <span class="attr">GroupSet:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">Ref:</span> <span class="string">MyTestVpcSg</span></span><br><span class="line">          <span class="attr">SubnetId:</span>  <span class="type">!Ref</span> <span class="string">MyTestVpcSubnet</span></span><br></pre></td></tr></table></figure>


<h3 id="1-6、AWS-控制台创建堆栈-stack"><a href="#1-6、AWS-控制台创建堆栈-stack" class="headerlink" title="1.6、AWS 控制台创建堆栈(stack)"></a>1.6、AWS 控制台创建堆栈(stack)</h3><p>要将模板的代码实例化，就需要创建堆栈，可以通过AWS控制台、AWS CLI、API，来创建创建、更新、删除堆栈。模板里面所有的资源可以作为一个“<strong>堆栈</strong>”进行管理。</p>
<p>堆栈里面的资源可以进行更新，在更改资源之前，你可以生成一个<strong>更改集</strong>，里面包含可能会对运行资源造成的影响，例如是否造成EC2重启启动，你可以在评估这个更改集里面的内容之后，在决定是否进行变更。</p>
<p>前面的内容单独解释每个资源如何创建，现在将这些资源都写到一个模板里面。这个模板中创建了一个VPC，VPC内部创建一个IGW，创建子网并将默认路由指向IGW。最后创建了一个EC2放置在公有子网里面，允许获取公网IP地址。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Resources:</span></span><br><span class="line"><span class="comment"># 创建一个VPC</span></span><br><span class="line">  <span class="attr">MyTestVpc:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::EC2::VPC</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">CidrBlock:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line">      <span class="attr">EnableDnsSupport:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">      <span class="attr">EnableDnsHostnames:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">      <span class="attr">Tags:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">Key:</span> <span class="string">Name</span></span><br><span class="line">         <span class="attr">Value:</span> <span class="string">MyTestVpc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建IGW并且关联到VPC</span></span><br><span class="line">  <span class="attr">MyTestIgw:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">&quot;AWS::EC2::InternetGateway&quot;</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">Tags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">Key:</span> <span class="string">Name</span></span><br><span class="line">          <span class="attr">Value:</span> <span class="string">my-test-igw</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">MyTestAttachIgw:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">&quot;AWS::EC2::VPCGatewayAttachment&quot;</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">VpcId:</span> <span class="type">!Ref</span> <span class="string">MyTestVpc</span></span><br><span class="line">      <span class="attr">InternetGatewayId:</span> <span class="type">!Ref</span> <span class="string">MyTestIgw</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在VPC内创建子网</span></span><br><span class="line">  <span class="attr">MyTestVpcSubnet:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::EC2::Subnet</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">VpcId:</span> <span class="type">!Ref</span> <span class="string">MyTestVpc</span></span><br><span class="line">      <span class="attr">CidrBlock:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line">      <span class="attr">AvailabilityZone:</span> <span class="string">cn-northwest-1a</span></span><br><span class="line">      <span class="attr">Tags:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">Key:</span> <span class="string">Name</span></span><br><span class="line">        <span class="attr">Value:</span> <span class="string">my-test-vpc-public-subnet</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># VPC内创建路由表并关联到子网，路由表设置默认路由指向IGW</span></span><br><span class="line">  <span class="attr">MyTestPublicRouteTable:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">&quot;AWS::EC2::RouteTable&quot;</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">VpcId:</span> <span class="type">!Ref</span> <span class="string">MyTestVpc</span></span><br><span class="line">      <span class="attr">Tags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">Key:</span> <span class="string">Name</span></span><br><span class="line">          <span class="attr">Value:</span> <span class="string">my-test-public-route-table</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">MyTestRouteTableAssociation:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">&quot;AWS::EC2::SubnetRouteTableAssociation&quot;</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">RouteTableId:</span> <span class="type">!Ref</span> <span class="string">MyTestPublicRouteTable</span></span><br><span class="line">      <span class="attr">SubnetId:</span> <span class="type">!Ref</span> <span class="string">MyTestVpcSubnet</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">MyTestInternetRoute:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">&quot;AWS::EC2::Route&quot;</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">     <span class="attr">RouteTableId:</span> <span class="type">!Ref</span> <span class="string">MyTestPublicRouteTable</span></span><br><span class="line">     <span class="attr">DestinationCidrBlock:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span></span><br><span class="line">     <span class="attr">GatewayId:</span> <span class="type">!Ref</span> <span class="string">MyTestIgw</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在VPC内创建一个安全组</span></span><br><span class="line">  <span class="attr">MyTestVpcSg:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::EC2::SecurityGroup</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">GroupDescription:</span> <span class="string">SG</span> <span class="string">to</span> <span class="string">test</span> <span class="string">ping</span></span><br><span class="line">      <span class="attr">VpcId:</span> <span class="type">!Ref</span> <span class="string">MyTestVpc</span></span><br><span class="line">      <span class="attr">SecurityGroupIngress:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">IpProtocol:</span> <span class="string">tcp</span></span><br><span class="line">        <span class="attr">FromPort:</span> <span class="number">22</span></span><br><span class="line">        <span class="attr">ToPort:</span> <span class="number">22</span></span><br><span class="line">        <span class="attr">CidrIp:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">IpProtocol:</span> <span class="string">icmp</span></span><br><span class="line">        <span class="attr">FromPort:</span> <span class="number">-1</span></span><br><span class="line">        <span class="attr">ToPort:</span> <span class="number">-1</span></span><br><span class="line">        <span class="attr">CidrIp:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">IpProtocol:</span> <span class="string">tcp</span></span><br><span class="line">        <span class="attr">FromPort:</span> <span class="number">8443</span></span><br><span class="line">        <span class="attr">ToPort:</span> <span class="number">8443</span></span><br><span class="line">        <span class="attr">CidrIp:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span></span><br><span class="line">        </span><br><span class="line"><span class="comment"># 创建一个EC2实例</span></span><br><span class="line">  <span class="attr">MyTestEc2Instance:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::EC2::Instance</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">ImageId:</span> <span class="string">ami-003a3de8892ecbc45</span></span><br><span class="line">      <span class="attr">KeyName:</span> <span class="string">MyCN-CloudFormation-Test-Key</span></span><br><span class="line">      <span class="attr">InstanceType:</span> <span class="string">t3.small</span></span><br><span class="line">      <span class="attr">NetworkInterfaces:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">AssociatePublicIpAddress:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">DeviceIndex:</span> <span class="number">0</span></span><br><span class="line">          <span class="attr">GroupSet:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">Ref:</span> <span class="string">MyTestVpcSg</span></span><br><span class="line">          <span class="attr">SubnetId:</span>  <span class="type">!Ref</span> <span class="string">MyTestVpcSubnet</span></span><br></pre></td></tr></table></figure>


<p>进入AWS CloudFormation控制台，点击创建堆栈，选择使用新资源创建。</p>
<p><img src="https://liuqianglong-blog.oss-cn-beijing.aliyuncs.com/img/image-20220331212913966.png"></p>
<p>选择模板已就绪，上传准备的yaml文件，文件最大支持1MB，文件的扩展名是txt并没有关系，AWS会自动创建一个S3桶来存储模板文件。你也可以将模板文件上传到上s3，然后指定s3的路径来调用模板。上传成功后你可以在利用CloudFormation Designer来图形化的查看堆栈资源信息。</p>
<p><img src="https://liuqianglong-blog.oss-cn-beijing.aliyuncs.com/img/image-20220331212926921.png"></p>
<p>通过Designer你可以以图形化的方式来创建、查看和修改模板。一般我个人更习惯使用YAML创建模板，然后使用Designer校验一下，并不会直接使用Designer来创建模板。</p>
<p><img src="https://liuqianglong-blog.oss-cn-beijing.aliyuncs.com/img/image-20220331214009552.png"></p>
<p>最后指定堆栈的名称，注意堆栈名称不能有下划线，可以有中横线。</p>
<p><img src="https://liuqianglong-blog.oss-cn-beijing.aliyuncs.com/img/image-20220331214151421.png"></p>
<p>通过【事件】可以查看堆栈创建的进度，如果堆栈创建失败，通过事件输出信息，可以非常容易的定位错误原因。</p>
<p><img src="https://liuqianglong-blog.oss-cn-beijing.aliyuncs.com/img/image-20220331214355860.png"></p>
<p>例如这里我故意将子网的AZ信息写成<code>cn-northwest-1</code>，少写了一个<code>a</code>。可以通过【事件】来查看报错信息，状态原因非常明确的说明了错误原因，你可以快速的根据“逻辑ID”来定位是哪个资源有错误，因为逻辑ID就是模板内的资源名称。</p>
<p><img src="https://liuqianglong-blog.oss-cn-beijing.aliyuncs.com/img/image-20220331215123625.png"></p>
<p>另外，当堆栈创建失败的时候，堆栈会自动回滚，将前面所有创建的资源都会删除，全都删除完成后，堆栈状态为<code>ROLLBACK_COMPLETE</code>，此时可以删除堆栈重新在创建一次。</p>
<p><img src="https://liuqianglong-blog.oss-cn-beijing.aliyuncs.com/img/image-20220331215350827.png"></p>
<h2 id="2、CloudFormation模板进阶操作"><a href="#2、CloudFormation模板进阶操作" class="headerlink" title="2、CloudFormation模板进阶操作"></a>2、CloudFormation模板进阶操作</h2><h3 id="2-1、模板资源属性"><a href="#2-1、模板资源属性" class="headerlink" title="2.1、模板资源属性"></a>2.1、模板资源属性</h3><p>资源字段内部一共有<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/aws-product-attribute-reference.html">6种属性</a>，这里只介绍<code>DependsOn</code>属性。在两个资源之间有依赖关系时，如果你希望其中一个资源先创建，然后再创建另外一个资源，就可以用<code>DependsOn</code>属性。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CreationPolicy attribute</span><br><span class="line">DeletionPolicy attribute</span><br><span class="line">DependsOn attribute</span><br><span class="line">Metadata attribute</span><br><span class="line">UpdatePolicy attribute</span><br><span class="line">UpdateReplacePolicy attribute</span><br></pre></td></tr></table></figure>
<p>例如你希望先创建数据库，然后再创建EC2实例，就可以在EC2资源下面加上<code>DependsOn</code>属性，确保创建完数据之后再创建EC2。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Resources:</span></span><br><span class="line">  <span class="attr">Ec2Instance:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::EC2::Instance</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">ImageId:</span> <span class="string">ami-003a3de8892ecbc45</span></span><br><span class="line">    <span class="attr">DependsOn:</span> <span class="string">myDB</span></span><br><span class="line">  <span class="attr">myDB:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::RDS::DBInstance</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">AllocatedStorage:</span> <span class="string">&#x27;5&#x27;</span></span><br><span class="line">      <span class="attr">DBInstanceClass:</span> <span class="string">db.t2.small</span></span><br><span class="line">      <span class="attr">Engine:</span> <span class="string">MySQL</span></span><br><span class="line">      <span class="attr">EngineVersion:</span> <span class="string">&#x27;5.5&#x27;</span></span><br><span class="line">      <span class="attr">MasterUsername:</span> <span class="string">MyName</span></span><br><span class="line">      <span class="attr">MasterUserPassword:</span> <span class="string">MyPassword</span></span><br></pre></td></tr></table></figure>
<p>这里其实隐含了一个特性，就是AWS在创建、更新、删除资源的时候默认是<strong>并行</strong>的，也就是尽可能同时进行操作。使用<code>DependsOn</code>属性可以明确的指定资源创建的先后顺序，但是<code>!Ref</code>和<code>!GetAtt</code> 这两个内部函数具有隐式的依赖关系。前面的模板中，大量使用了<code>!Ref</code>函数，也可以确保被调用的资源先创建。</p>
<h3 id="2-2、内部函数介绍"><a href="#2-2、内部函数介绍" class="headerlink" title="2.2、内部函数介绍"></a>2.2、内部函数介绍</h3><p>内部函数的用法是CloudFormation的难点和重点。</p>
<p>只能在特定的模板字段下面使用内部函数，例如在<strong>resource properties</strong>、<strong>outputs</strong>、metadata attributes、update policy attributes这几个字段下面使用内部函数。一共有下面这些内部函数，这里只介绍几个常用的<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference.html">内部函数</a>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Fn::Base64</span><br><span class="line">Fn::Cidr</span><br><span class="line">Condition functions</span><br><span class="line">Fn::FindInMap</span><br><span class="line">Fn::GetAtt</span><br><span class="line">Fn::GetAZs</span><br><span class="line">Fn::ImportValue</span><br><span class="line">Fn::Join</span><br><span class="line">Fn::Select</span><br><span class="line">Fn::Split</span><br><span class="line">Fn::Sub</span><br><span class="line">Fn::Transform</span><br><span class="line">Ref</span><br></pre></td></tr></table></figure>
<h4 id="Ref函数"><a href="#Ref函数" class="headerlink" title="Ref函数"></a>Ref函数</h4><p>前面的模板大量使用过了<code>Ref</code>函数，一般情况下<code>Ref</code>函数返回资源的名称，有些资源会返回有重要意义的标识符，例如<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-eip.html">AWS::EC2::EIP</a> 资源返回 IP 地址，<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-instance.html">AWS::EC2::Instance</a> 返回实例 ID。一般情况下我直接通过<code>Ref</code>指定想要调用的资源名称，如果出现报错了，才会去看对应资源<code>Ref</code>的输出内容。</p>
<p>完整函数名称的语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ref: logicalName</span><br></pre></td></tr></table></figure>
<p>短格式的语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!Ref logicalName</span><br></pre></td></tr></table></figure>
<p>例如前面将IGW关联到VPC，就用到<code>Ref</code>函数，VPC ID使用了完成名称，IGW ID使用了短格式写法。一般我会使用短格式写法，写在一行更加简洁。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">MyTestAttachIgw:</span></span><br><span class="line">  <span class="attr">Type:</span> <span class="string">&quot;AWS::EC2::VPCGatewayAttachment&quot;</span></span><br><span class="line">  <span class="attr">Properties:</span></span><br><span class="line">    <span class="attr">VpcId:</span> </span><br><span class="line">      <span class="attr">Ref:</span> <span class="string">MyTestVpc</span></span><br><span class="line">    <span class="attr">InternetGatewayId:</span> <span class="type">!Ref</span> <span class="string">MyTestIgw</span></span><br></pre></td></tr></table></figure>


<h4 id="Fn-GetAtt-函数"><a href="#Fn-GetAtt-函数" class="headerlink" title="Fn::GetAtt 函数"></a>Fn::GetAtt 函数</h4><p><code>Fn::GetAtt</code> 内部函数返回模板中资源的属性值。例如你希望获取EC2实例的公网IP地址，就可以使用<code>!GetAtt MyTestEc2Instance.PublicIp</code>来获取EC2的公网IP地址。具体每个资源可以获取哪些属性值，可以查阅对应资源的文档，例如查看<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-instance.html">AWS::EC2::Instance</a>有哪些属性值。</p>
<p>完整函数名称的语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Fn::GetAtt: [ logicalNameOfResource, attributeName ]</span><br></pre></td></tr></table></figure>
<p>短格式的语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!GetAtt logicalNameOfResource.attributeName</span><br></pre></td></tr></table></figure>
<p>例如输出EC2的公网IP地址，Fn::GetAtt 函数短格式写法为：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Outputs:</span></span><br><span class="line">  <span class="attr">MyTestEc2InstanceEip:</span></span><br><span class="line">    <span class="attr">Description:</span> <span class="string">MyTestEc2InstanceEip</span></span><br><span class="line">    <span class="attr">Value:</span> <span class="type">!GetAtt</span> <span class="string">MyTestEc2Instance.PublicIp</span></span><br><span class="line">    <span class="attr">Export:</span></span><br><span class="line">      <span class="attr">Name:</span> <span class="string">MyTestEc2InstanceEip</span></span><br></pre></td></tr></table></figure>
<p>下面是对应的Fn::GetAtt 函数的完整写法。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Outputs:</span></span><br><span class="line">  <span class="attr">MyTestEc2InstanceEip:</span></span><br><span class="line">    <span class="attr">Description:</span> <span class="string">MyTestEc2InstanceEip</span></span><br><span class="line">    <span class="attr">Value:</span> </span><br><span class="line">      <span class="attr">Fn::Getatt:</span> [ <span class="string">MyTestEc2Instance</span>, <span class="string">PublicIp</span> ]</span><br><span class="line">    <span class="attr">Export:</span></span><br><span class="line">      <span class="attr">Name:</span> <span class="string">MyTestEc2InstanceEip</span></span><br></pre></td></tr></table></figure>


<h4 id="Fn-Select-函数"><a href="#Fn-Select-函数" class="headerlink" title="Fn::Select 函数"></a>Fn::Select 函数</h4><p>内部函数<code>Fn::Select</code>通过索引返回对象列表中的单个对象。一般结合函数<code>Fn::GetAZs</code>使用。</p>
<p>完整函数名称的语法，index指定索引序号，listOfObjects表示对象的列表。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Fn::Select: [ index, listOfObjects ] </span><br></pre></td></tr></table></figure>
<p>短格式的语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!Select [ index, listOfObjects ]</span><br></pre></td></tr></table></figure>
<p>为了更好理解这个函数的用法，这里通过一个虚拟的例子来进行解释。例如变量<code>Ec2TypeList</code>是一个列表，想要设置EC2实例类型为<code>t2.micro</code>，通过<code>Select</code>函数，选择列表的第一个索引，即0号索引即可。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Ec2TypeList</span> <span class="string">=</span> [ <span class="string">t2.micro</span>, <span class="string">t2.small</span>, <span class="string">t2.large</span> ]</span><br><span class="line"></span><br><span class="line">  <span class="attr">MyTestEc2Instance:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::EC2::Instance</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">InstanceType:</span> <span class="type">!Select</span> [ <span class="number">0</span>, <span class="string">Ec2TypeList</span> ]</span><br></pre></td></tr></table></figure>


<h4 id="Fn-GetAZs-函数"><a href="#Fn-GetAZs-函数" class="headerlink" title="Fn::GetAZs 函数"></a>Fn::GetAZs 函数</h4><p>内部函数<code>Fn::GetAZs</code>返回一个数组，该数组按字母顺序列出指定区域的可用区。</p>
<p>前面模板创建子网时，在模板里面硬编码了可用区信息<code>AvailabilityZone: cn-northwest-1a</code>，那么这个模板如果在除了宁夏以外的其他区域使用就会报错，因为其他区域没有<code>cn-northwest-1a</code>这个可用区。</p>
<p>下面案例中，<code>AWS::Region</code>是<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/pseudo-parameter-reference.html">伪参数</a>。伪参数是 AWS CloudFormation 内建的变量，调用<code>AWS::Region</code>会返回代码运行的区域值，即<code>cn-northwest-1a</code>。</p>
<p>进一步通过<code>Fn::GetAZs</code>函数来指定获取可用区信息，因为返回的结果是一个列表，所以可以用<code>Select</code>函数来选择单个对象，例如这里选择返回结果中的第一个可用区。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">AvailabilityZone:</span> <span class="type">!Select</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="number">0</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">Fn::GetAZs:</span> <span class="type">!Ref</span> <span class="string">&#x27;AWS::Region&#x27;</span></span><br></pre></td></tr></table></figure>
<p>这样前面子网的可用区信息就不用硬编码了，换成更加灵活的方式指定可用区，这里指定为CloudFormation运行区域的第一个可用区。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在VPC内创建子网</span></span><br><span class="line">  <span class="attr">MyTestVpcSubnet:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::EC2::Subnet</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">VpcId:</span> <span class="type">!Ref</span> <span class="string">MyTestVpc</span></span><br><span class="line">      <span class="attr">CidrBlock:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line">      <span class="attr">AvailabilityZone:</span> </span><br><span class="line">        <span class="attr">Fn::Select:</span> </span><br><span class="line">          <span class="bullet">-</span> <span class="number">0</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">Fn::GetAZs:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">Tags:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">Key:</span> <span class="string">Name</span></span><br><span class="line">        <span class="attr">Value:</span> <span class="string">my-test-vpc-public-subnet</span></span><br></pre></td></tr></table></figure>


<h4 id="Fn-Base64-函数"><a href="#Fn-Base64-函数" class="headerlink" title="Fn::Base64 函数"></a>Fn::Base64 函数</h4><p>内部函数<code>Fn::Base64</code>返回输入字符串的 Base64 表示方法。该函数通常用于通过 <code>UserData</code> 属性将编码的数据传递给 Amazon EC2 实例。你可以在 <code>Fn::Base64</code> 函数内部使用返回字符串的任意函数。</p>
<p>完整函数名称的语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Fn::Base64: valueToEncode</span><br></pre></td></tr></table></figure>
<p>短格式的语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!Base64 valueToEncode</span><br></pre></td></tr></table></figure>


<h4 id="Fn-Sub-函数"><a href="#Fn-Sub-函数" class="headerlink" title="Fn::Sub 函数"></a>Fn::Sub 函数</h4><p>内部函数 <code>Fn::Sub</code> 将输入字符串中的变量替换为你指定的值。 <code>Fn::Sub</code> 函数最常见的用法就是结合<code>Fn::Base64</code>函数，将数据传递到EC2的 <code>UserData</code> 里面。</p>
<p>完整函数名称的语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Fn::Sub: String</span><br></pre></td></tr></table></figure>
<p>短格式的语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!Sub String</span><br></pre></td></tr></table></figure>
<p>例如下面这个案例，通过<code>UserData</code>来安装apache服务，修改http端口，并启动服务。</p>
<p>函数<code>Fn::Base64:</code>表示将后面的字符串编码转换为Base64格式。</p>
<p>函数<code>!Sub</code>将输入字符串中的变量替换为你指定的值。</p>
<p>字符<code>|</code>（管道符号）表示一种文本风格(Literal Style)，它可以让你输入正常的文本，而不用使用<code>\n</code>来表示换行。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个EC2实例</span></span><br><span class="line">  <span class="attr">MyTestEc2Instance:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::EC2::Instance</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">ImageId:</span> <span class="string">ami-003a3de8892ecbc45</span></span><br><span class="line">      <span class="attr">KeyName:</span> <span class="string">CloudFormation-Test-Key</span></span><br><span class="line">      <span class="attr">InstanceType:</span> <span class="string">t3.small</span></span><br><span class="line">      <span class="attr">NetworkInterfaces:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">AssociatePublicIpAddress:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">DeviceIndex:</span> <span class="number">0</span></span><br><span class="line">          <span class="attr">GroupSet:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">Ref:</span> <span class="string">MyTestVpcSg</span></span><br><span class="line">          <span class="attr">SubnetId:</span>  <span class="type">!Ref</span> <span class="string">MyTestVpcSubnet</span></span><br><span class="line">      <span class="attr">UserData:</span></span><br><span class="line">        <span class="attr">Fn::Base64:</span></span><br><span class="line">          <span class="type">!Sub</span> <span class="string">|</span></span><br><span class="line">          <span class="comment">#!/bin/bash</span></span><br><span class="line">          <span class="string">yum</span> <span class="string">update</span> <span class="string">-y</span></span><br><span class="line">          <span class="string">yum</span> <span class="string">install</span> <span class="string">-y</span> <span class="string">httpd</span></span><br><span class="line">          <span class="string">sed</span> <span class="string">-i.bak</span> <span class="string">&#x27;s/Listen 80/Listen 8443/g&#x27;</span> <span class="string">/etc/httpd/conf/httpd.conf</span></span><br><span class="line">          <span class="string">systemctl</span> <span class="string">start</span> <span class="string">httpd.service</span></span><br><span class="line">          <span class="string">systemctl</span> <span class="string">enable</span> <span class="string">httpd.service</span></span><br></pre></td></tr></table></figure>


<p>函数 <code>Fn::Sub</code> 还可以进行替换操作，有两种场景，一种是使用变量映射，另外一种是使用<code>$&#123;&#125;</code>替换变量。</p>
<p>使用<code>$&#123;&#125;</code>替换变量，其实就是直接调用变量。以下示例使用<code>AWS::Region</code>这个伪参数，以及 VPC 资源逻辑 ID 产生了一个字符串。替换的结果格式为<code>arn:aws:ec2:cn-northwest-1:vpc/vpc-0e2bd48e14bb15086</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">!Sub</span> <span class="string">&#x27;arn:aws:ec2:$&#123;AWS::Region&#125;:vpc/$&#123;MyTestVpc&#125;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>变量映射的短格式语法如下，后面的变量往前面的字符串传递参数。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">!Sub</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">String</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">Var1Name:</span> <span class="string">Var1Value</span></span><br><span class="line">    <span class="attr">Var2Name:</span> <span class="string">Var2Value</span></span><br></pre></td></tr></table></figure>
<p>例如，使用<code>GetAtt</code> 函数获取的结果，来替换变量 <code>$&#123;MyTestEc2InstanceEip&#125;</code> 的值。注意<code>$&#123;&#125;</code>内部只能填写变量，不能嵌套其他函数，例如不能写成<code>$&#123;!GetAtt MyTestEc2Instance.PublicIp&#125;</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">WebServerSubUrl:</span></span><br><span class="line">  <span class="attr">Description:</span> <span class="string">WebServerSubUrl</span></span><br><span class="line">  <span class="attr">Value:</span> <span class="type">!Sub</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;http://$&#123;MyTestEc2InstanceEip&#125;:$&#123;webServerPort&#125;&quot;</span></span><br><span class="line">    <span class="bullet">-</span> &#123;<span class="attr">MyTestEc2InstanceEip:</span> <span class="type">!GetAtt</span> <span class="string">MyTestEc2Instance.PublicIp</span>&#125;</span><br><span class="line">  <span class="attr">Export:</span></span><br><span class="line">    <span class="attr">Name:</span> <span class="string">WebServerSubUrl</span></span><br></pre></td></tr></table></figure>


<h4 id="Fn-FindInMap-函数"><a href="#Fn-FindInMap-函数" class="headerlink" title="Fn::FindInMap 函数"></a>Fn::FindInMap 函数</h4><p>内置函数<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-findinmap.html">Fn::FindInMap</a>返回与<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/mappings-section-structure.html">Mappings</a>部分声明的<strong>双层映射中的键对应的值</strong>。通过下面的例子看下什么是双层映射中的键对应的值<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=lP6mC3ZKTfE">参考文档</a>：</p>
<p><code>ToplevelKey1</code>是第一层映射的键，<code>SecondLevelKey1</code>是第二层映射的键。想要获取<code>Vaule-ABC</code>这个值，就可以利用<code>FindInMap</code>函数来获取。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Mappings:</span></span><br><span class="line"> <span class="attr">logicalResource:</span></span><br><span class="line">   <span class="attr">ToplevelKey1:</span></span><br><span class="line">     <span class="attr">SecondLevelKey1:</span> <span class="string">Vaule-ABC</span></span><br><span class="line">     <span class="attr">SecondLevelKey2:</span> <span class="string">Vaule-123</span></span><br><span class="line">   <span class="attr">ToplevelKey2:</span></span><br><span class="line">     <span class="attr">SecondLevelKey1:</span> <span class="string">Vaule-XYZ</span></span><br><span class="line">     <span class="attr">SecondLevelKey2:</span> <span class="string">Vaule-456</span></span><br><span class="line"></span><br><span class="line"><span class="type">!FindInMap</span> [<span class="string">logicalResource</span>, <span class="string">ToplevelKey1</span>, <span class="string">SecondLevelKey1</span>]</span><br><span class="line"><span class="string">Vaule-ABC</span></span><br></pre></td></tr></table></figure>
<p>上面就是一些常见的函数，还有一些函数没有介绍，后续有时间会在单独介绍。</p>
<h3 id="2-3、Parameters-参数"><a href="#2-3、Parameters-参数" class="headerlink" title="2.3、Parameters(参数)"></a>2.3、Parameters(参数)</h3><p>Parameters是模板里面的可选字段。利用参数，你能够在每次创建或更新堆栈时将自定义值输入模板。<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html">参考文档</a></p>
<p>例如可以让用户自己选择EC2的密钥对，密钥对设置了一个默认值。设置Web服务器的端口，端口值只能在<code>AllowedValues</code>中选择，后续安全组和输出都可以调用这个端口信息。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Parameters:</span></span><br><span class="line">  <span class="attr">myKeyPair:</span></span><br><span class="line">    <span class="attr">Description:</span> <span class="string">Amazon</span> <span class="string">EC2</span> <span class="string">Key</span> <span class="string">Pair</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::EC2::KeyPair::KeyName</span></span><br><span class="line">    <span class="attr">Default:</span> <span class="string">MyCN-CloudFormation-Test-Key</span></span><br><span class="line">  <span class="attr">webServerPort:</span></span><br><span class="line">    <span class="attr">Description:</span> <span class="string">Apache</span> <span class="string">Http</span> <span class="string">Server</span> <span class="string">Port</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">String</span></span><br><span class="line">    <span class="attr">Default:</span> <span class="number">8443</span></span><br><span class="line">    <span class="attr">AllowedValues:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8443</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8888</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8088</span></span><br></pre></td></tr></table></figure>
<p>在创建EC2时，调用参数定义的密钥对信息。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个EC2实例</span></span><br><span class="line">  <span class="attr">MyTestEc2Instance:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::EC2::Instance</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">KeyName:</span> <span class="type">!Ref</span> <span class="string">myKeyPair</span> </span><br></pre></td></tr></table></figure>
<p>在安全组放行端口时，可以使用<code>!Ref</code>或者<code>!Sub</code>函数调用参数里面定义的Web服务器端口。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在VPC内创建一个安全组</span></span><br><span class="line">  <span class="attr">MyTestVpcSg:</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">IpProtocol:</span> <span class="string">tcp</span></span><br><span class="line">        <span class="attr">FromPort:</span> <span class="type">!Ref</span> <span class="string">webServerPort</span>  <span class="comment"># !Sub $&#123;webServerPort&#125;</span></span><br><span class="line">        <span class="attr">ToPort:</span> <span class="type">!Ref</span> <span class="string">webServerPort</span>	<span class="comment"># !Sub $&#123;webServerPort&#125;</span></span><br><span class="line">        <span class="attr">CidrIp:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span></span><br></pre></td></tr></table></figure>


<p>在创建堆栈时，需要填写参数信息。</p>
<p><img src="https://liuqianglong-blog.oss-cn-beijing.aliyuncs.com/img/image-20220401150442255.png"></p>
<h3 id="2-4、Outputs-输出"><a href="#2-4、Outputs-输出" class="headerlink" title="2.4、Outputs(输出)"></a>2.4、Outputs(输出)</h3><p>Outputs是模板里面的可选参数，你可以输出指定的值，这些值可以导入到其他堆栈中、可以从响应中获取这些值、或者在AWS CloudFormation 控制台中查看。</p>
<p>这里输出了EC2的公网IP地址信息。还通过字符串替换或拼接的方式输出了EC2的URL信息，可以用<code>!Sub</code>和<code>!Join</code>两种方式输出Web服务器的URL，<code>!Join</code>函数这里简单演示一下使用案例，Join函数类似于字符串拼接，我个人更习惯使用<code>!Sub</code>函数。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Outputs:</span></span><br><span class="line">  <span class="attr">MyTestEc2InstanceEip:</span></span><br><span class="line">    <span class="attr">Description:</span> <span class="string">MyTestEc2InstanceEip</span></span><br><span class="line">    <span class="attr">Value:</span> <span class="type">!GetAtt</span> <span class="string">MyTestEc2Instance.PublicIp</span></span><br><span class="line">    <span class="attr">Export:</span></span><br><span class="line">      <span class="attr">Name:</span> <span class="string">MyTestEc2InstanceEip</span></span><br><span class="line">  <span class="attr">WebServerSubUrl:</span></span><br><span class="line">    <span class="attr">Description:</span> <span class="string">WebServerUrl</span></span><br><span class="line">    <span class="attr">Value:</span> <span class="type">!Sub</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;http://$&#123;MyTestEc2InstanceEip&#125;:$&#123;webServerPort&#125;&quot;</span></span><br><span class="line">      <span class="bullet">-</span> &#123;<span class="attr">MyTestEc2InstanceEip:</span> <span class="type">!GetAtt</span> <span class="string">MyTestEc2Instance.PublicIp</span>&#125;</span><br><span class="line">    <span class="attr">Export:</span></span><br><span class="line">      <span class="attr">Name:</span> <span class="string">WebServerSubUrl</span></span><br><span class="line">  <span class="attr">WebServerJoinUrl:</span></span><br><span class="line">    <span class="attr">Description:</span> <span class="string">WebServerUrlTest</span></span><br><span class="line">    <span class="attr">Value:</span> <span class="type">!Join</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="bullet">-</span> <span class="string">&#x27;http://&#x27;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="type">!GetAtt</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">MyTestEc2Instance</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">PublicIp</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#x27;:&#x27;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="type">!Sub</span> <span class="string">$&#123;webServerPort&#125;</span></span><br><span class="line">    <span class="attr">Export:</span></span><br><span class="line">      <span class="attr">Name:</span> <span class="string">WebServerJoinUrl</span></span><br></pre></td></tr></table></figure>


<h3 id="2-5、Mappings-映像"><a href="#2-5、Mappings-映像" class="headerlink" title="2.5、Mappings(映像)"></a>2.5、Mappings(映像)</h3><p>Mappings是模板里面的可选字段，包含一些键值对，通过<code>Fn::FindInMap</code>函数可以获取映射中值的信息。</p>
<p>Mappings字段在公开模板里面经常会看到。例如，因为AMI ID每个区域都是不一样的，所以想要模板内部的EC2实例能在多个区域运行，需要提前指定不同区域的AMI ID信息，然后就可以利用Mappings定义好不同区域的AMI ID信息，然后在EC2资源利用<code>Fn::FindInMap</code>调用。</p>
<p>这里定义了中国北京和中国宁夏区域的Amazon Linux AMI ID，<code>HVM64</code>表示全虚拟化x86架构64位系统，<code>HVMG2</code>表示Arm架构Graviton2处理器。<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/AWSEC2/latest/UserGuide/virtualization_types.html">参考文档</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Mappings:</span></span><br><span class="line">  <span class="attr">RegionMap:</span></span><br><span class="line">    <span class="attr">cn-north-1:</span></span><br><span class="line">      <span class="attr">HVM64:</span> <span class="string">ami-0a01c170bf8ccec5b</span></span><br><span class="line">      <span class="attr">HVMG2:</span> <span class="string">ami-0491098e85ea4b162</span></span><br><span class="line">    <span class="attr">cn-northwest-1:</span></span><br><span class="line">      <span class="attr">HVM64:</span> <span class="string">ami-003a3de8892ecbc45</span></span><br><span class="line">      <span class="attr">HVMG2:</span> <span class="string">ami-026d9fc0529d10475</span></span><br></pre></td></tr></table></figure>
<p>在指定EC2镜像时，可以使用<code>!FindInMap</code>函数进行调用。其中<code>!Ref &quot;AWS::Region&quot;</code>是伪参数，可以获取创建堆栈的AWS区域。这里就实现了在哪个区域部署时，就传递对应区域的AMI ID信息，模板将具有更好的灵活性。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个EC2实例</span></span><br><span class="line">  <span class="attr">MyTestEc2Instance:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::EC2::Instance</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">ImageId:</span> <span class="type">!FindInMap</span> [<span class="string">RegionMap</span>, <span class="type">!Ref</span> <span class="string">&quot;AWS::Region&quot;</span>, <span class="string">HVM64</span>]</span><br></pre></td></tr></table></figure>


<p>另外一个常见使用Mappings的场景，是根据测试环境或者生产环境自动选择EC2的实例类型，或者其他参数。</p>
<p>Mappings定义测试环境和生产环境的实例类型，并提供参数让用户选择环境类型。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Mappings:</span></span><br><span class="line">  <span class="attr">RegionMap:</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">  <span class="attr">EnvironmentType:</span></span><br><span class="line">    <span class="attr">dev:</span></span><br><span class="line">      <span class="attr">instanceType:</span> <span class="string">t3.micro</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">dev</span></span><br><span class="line">    <span class="attr">prod:</span></span><br><span class="line">      <span class="attr">instanceType:</span> <span class="string">t3.small</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">prod</span></span><br><span class="line"><span class="attr">Parameters:</span></span><br><span class="line">  <span class="attr">Environment:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">String</span></span><br><span class="line">    <span class="attr">AllowedValues:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">dev</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">prod</span></span><br><span class="line">    <span class="attr">Default:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure>


<p>EC2实例调用用户选择的环境类型，来决定启动的实例类型。例如如果选择的<code>dev</code>环境，那么实例类型就会通过<code>FindInMap</code>函数获取到<code>t3.micro</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个EC2实例</span></span><br><span class="line">  <span class="attr">MyTestEc2Instance:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::EC2::Instance</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">ImageId:</span> <span class="type">!FindInMap</span> [<span class="string">RegionMap</span>, <span class="type">!Ref</span> <span class="string">&quot;AWS::Region&quot;</span>, <span class="string">HVM64</span>]</span><br><span class="line">      <span class="attr">KeyName:</span> <span class="type">!Ref</span> <span class="string">myKeyPair</span></span><br><span class="line">      <span class="attr">InstanceType:</span> <span class="type">!FindInMap</span> [<span class="string">EnvironmentType</span>, <span class="type">!Ref</span> <span class="string">Environment</span>, <span class="string">instanceType</span>]</span><br></pre></td></tr></table></figure>




<h3 id="2-6、创建一个更加灵活的模板"><a href="#2-6、创建一个更加灵活的模板" class="headerlink" title="2.6、创建一个更加灵活的模板"></a>2.6、创建一个更加灵活的模板</h3><p>模板添加了Parameters字段、让用户选择EC2的Key、指定Web服务器的端口、在安全组内调用Web端口的参数、在<code>UserData</code>的配置文件调用Web端口信息、添加了Outputs字段，输出EC2的公网IP地址，输出Web服务器的URL信息。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">AWSTemplateFormatVersion:</span> <span class="string">&quot;2010-09-09&quot;</span></span><br><span class="line"><span class="attr">Description:</span> <span class="string">&quot;CloudFormation learning template from Liu Qianglong.&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Mappings:</span></span><br><span class="line">  <span class="attr">RegionMap:</span></span><br><span class="line">    <span class="attr">cn-north-1:</span></span><br><span class="line">      <span class="attr">HVM64:</span> <span class="string">ami-0a01c170bf8ccec5b</span></span><br><span class="line">      <span class="attr">HVMG2:</span> <span class="string">ami-0491098e85ea4b162</span></span><br><span class="line">    <span class="attr">cn-northwest-1:</span></span><br><span class="line">      <span class="attr">HVM64:</span> <span class="string">ami-003a3de8892ecbc45</span></span><br><span class="line">      <span class="attr">HVMG2:</span> <span class="string">ami-026d9fc0529d10475</span></span><br><span class="line">  <span class="attr">EnvironmentType:</span></span><br><span class="line">    <span class="attr">dev:</span></span><br><span class="line">      <span class="attr">instanceType:</span> <span class="string">t3.micro</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">dev</span></span><br><span class="line">    <span class="attr">prod:</span></span><br><span class="line">      <span class="attr">instanceType:</span> <span class="string">t3.small</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">prod</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Parameters:</span></span><br><span class="line">  <span class="attr">Environment:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">String</span></span><br><span class="line">    <span class="attr">AllowedValues:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">dev</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">prod</span></span><br><span class="line">    <span class="attr">Default:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">myKeyPair:</span></span><br><span class="line">    <span class="attr">Description:</span> <span class="string">Amazon</span> <span class="string">EC2</span> <span class="string">Key</span> <span class="string">Pair</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::EC2::KeyPair::KeyName</span></span><br><span class="line">    <span class="attr">Default:</span> <span class="string">CloudFormation-Test-Key</span></span><br><span class="line">  <span class="attr">webServerPort:</span></span><br><span class="line">    <span class="attr">Description:</span> <span class="string">Apache</span> <span class="string">Http</span> <span class="string">Server</span> <span class="string">Port</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">String</span></span><br><span class="line">    <span class="attr">Default:</span> <span class="number">8443</span></span><br><span class="line">    <span class="attr">AllowedValues:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8443</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8888</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8088</span></span><br><span class="line"><span class="attr">Resources:</span></span><br><span class="line"><span class="comment"># 创建一个VPC</span></span><br><span class="line">  <span class="attr">MyTestVpc:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::EC2::VPC</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">CidrBlock:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line">      <span class="attr">EnableDnsSupport:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">      <span class="attr">EnableDnsHostnames:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">      <span class="attr">Tags:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">Key:</span> <span class="string">Name</span></span><br><span class="line">         <span class="attr">Value:</span> <span class="string">MyTestVpc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建IGW并且关联到VPC</span></span><br><span class="line">  <span class="attr">MyTestIgw:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">&quot;AWS::EC2::InternetGateway&quot;</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">Tags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">Key:</span> <span class="string">Name</span></span><br><span class="line">          <span class="attr">Value:</span> <span class="string">my-test-igw</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">MyTestAttachIgw:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">&quot;AWS::EC2::VPCGatewayAttachment&quot;</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">VpcId:</span> <span class="type">!Ref</span> <span class="string">MyTestVpc</span></span><br><span class="line">      <span class="attr">InternetGatewayId:</span> <span class="type">!Ref</span> <span class="string">MyTestIgw</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在VPC内创建子网</span></span><br><span class="line">  <span class="attr">MyTestVpcSubnet:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::EC2::Subnet</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">VpcId:</span> <span class="type">!Ref</span> <span class="string">MyTestVpc</span></span><br><span class="line">      <span class="attr">CidrBlock:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line">      <span class="attr">AvailabilityZone:</span></span><br><span class="line">        <span class="attr">Fn::Select:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="number">0</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">Fn::GetAZs:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">Tags:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">Key:</span> <span class="string">Name</span></span><br><span class="line">        <span class="attr">Value:</span> <span class="string">my-test-vpc-public-subnet</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># VPC内创建路由表并关联到子网，路由表设置默认路由指向IGW</span></span><br><span class="line">  <span class="attr">MyTestPublicRouteTable:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">&quot;AWS::EC2::RouteTable&quot;</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">VpcId:</span> <span class="type">!Ref</span> <span class="string">MyTestVpc</span></span><br><span class="line">      <span class="attr">Tags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">Key:</span> <span class="string">Name</span></span><br><span class="line">          <span class="attr">Value:</span> <span class="string">my-test-public-route-table</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">MyTestRouteTableAssociation:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">&quot;AWS::EC2::SubnetRouteTableAssociation&quot;</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">RouteTableId:</span> <span class="type">!Ref</span> <span class="string">MyTestPublicRouteTable</span></span><br><span class="line">      <span class="attr">SubnetId:</span> <span class="type">!Ref</span> <span class="string">MyTestVpcSubnet</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">MyTestInternetRoute:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">&quot;AWS::EC2::Route&quot;</span></span><br><span class="line">    <span class="attr">DependsOn:</span> <span class="string">MyTestIgw</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">     <span class="attr">RouteTableId:</span> <span class="type">!Ref</span> <span class="string">MyTestPublicRouteTable</span></span><br><span class="line">     <span class="attr">DestinationCidrBlock:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span></span><br><span class="line">     <span class="attr">GatewayId:</span> <span class="type">!Ref</span> <span class="string">MyTestIgw</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在VPC内创建一个安全组</span></span><br><span class="line">  <span class="attr">MyTestVpcSg:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::EC2::SecurityGroup</span></span><br><span class="line">    <span class="attr">DependsOn:</span> <span class="string">MyTestVpc</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">GroupDescription:</span> <span class="string">SG</span> <span class="string">to</span> <span class="string">test</span> <span class="string">ping</span></span><br><span class="line">      <span class="attr">VpcId:</span></span><br><span class="line">        <span class="attr">Ref:</span> <span class="string">MyTestVpc</span></span><br><span class="line">      <span class="attr">SecurityGroupIngress:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">IpProtocol:</span> <span class="string">tcp</span></span><br><span class="line">        <span class="attr">FromPort:</span> <span class="number">22</span></span><br><span class="line">        <span class="attr">ToPort:</span> <span class="number">22</span></span><br><span class="line">        <span class="attr">CidrIp:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">IpProtocol:</span> <span class="string">icmp</span></span><br><span class="line">        <span class="attr">FromPort:</span> <span class="number">-1</span></span><br><span class="line">        <span class="attr">ToPort:</span> <span class="number">-1</span></span><br><span class="line">        <span class="attr">CidrIp:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">IpProtocol:</span> <span class="string">tcp</span></span><br><span class="line">        <span class="attr">FromPort:</span> <span class="type">!Ref</span> <span class="string">webServerPort</span>  <span class="comment"># !Sub $&#123;webServerPort&#125;</span></span><br><span class="line">        <span class="attr">ToPort:</span> <span class="type">!Ref</span> <span class="string">webServerPort</span></span><br><span class="line">        <span class="attr">CidrIp:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个EC2实例</span></span><br><span class="line">  <span class="attr">MyTestEc2Instance:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::EC2::Instance</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">ImageId:</span> <span class="type">!FindInMap</span> [<span class="string">RegionMap</span>, <span class="type">!Ref</span> <span class="string">&quot;AWS::Region&quot;</span>, <span class="string">HVM64</span>]</span><br><span class="line">      <span class="attr">KeyName:</span> <span class="type">!Ref</span> <span class="string">myKeyPair</span>     <span class="comment"># MyCN-CloudFormation-Test-Key</span></span><br><span class="line">      <span class="attr">InstanceType:</span> <span class="type">!FindInMap</span> [<span class="string">EnvironmentType</span>, <span class="type">!Ref</span> <span class="string">Environment</span>, <span class="string">instanceType</span>]</span><br><span class="line">      <span class="attr">NetworkInterfaces:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">AssociatePublicIpAddress:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">DeviceIndex:</span> <span class="number">0</span></span><br><span class="line">          <span class="attr">GroupSet:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">Ref:</span> <span class="string">MyTestVpcSg</span></span><br><span class="line">          <span class="attr">SubnetId:</span>  <span class="type">!Ref</span> <span class="string">MyTestVpcSubnet</span></span><br><span class="line">      <span class="attr">UserData:</span></span><br><span class="line">        <span class="attr">Fn::Base64:</span></span><br><span class="line">          <span class="type">!Sub</span> <span class="string">|</span></span><br><span class="line">          <span class="comment">#!/bin/bash</span></span><br><span class="line">          <span class="string">yum</span> <span class="string">update</span> <span class="string">-y</span></span><br><span class="line">          <span class="string">yum</span> <span class="string">install</span> <span class="string">-y</span> <span class="string">httpd</span></span><br><span class="line">          <span class="string">sed</span> <span class="string">-i.bak</span> <span class="string">&#x27;s/Listen 80/Listen $&#123;webServerPort&#125;/g&#x27;</span> <span class="string">/etc/httpd/conf/httpd.conf</span></span><br><span class="line">          <span class="string">echo</span> <span class="string">&quot;&lt;h2&gt;Hello World from $(hostname -f)&lt;/h2&gt;&quot;</span> <span class="string">&gt;</span> <span class="string">/var/www/html/index.html</span></span><br><span class="line">          <span class="string">systemctl</span> <span class="string">start</span> <span class="string">httpd.service</span></span><br><span class="line">          <span class="string">systemctl</span> <span class="string">enable</span> <span class="string">httpd.service</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Outputs:</span></span><br><span class="line">  <span class="attr">MyTestEc2InstanceEip:</span></span><br><span class="line">    <span class="attr">Description:</span> <span class="string">MyTestEc2InstanceEip</span></span><br><span class="line">    <span class="attr">Value:</span> <span class="type">!GetAtt</span> <span class="string">MyTestEc2Instance.PublicIp</span></span><br><span class="line">    <span class="attr">Export:</span></span><br><span class="line">      <span class="attr">Name:</span> <span class="string">MyTestEc2InstanceEip</span></span><br><span class="line">  <span class="attr">WebServerSubUrl:</span></span><br><span class="line">    <span class="attr">Description:</span> <span class="string">WebServerSubUrl</span></span><br><span class="line">    <span class="attr">Value:</span> <span class="type">!Sub</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;http://$&#123;MyTestEc2InstanceEip&#125;:$&#123;webServerPort&#125;&quot;</span></span><br><span class="line">      <span class="bullet">-</span> &#123;<span class="attr">MyTestEc2InstanceEip:</span> <span class="type">!GetAtt</span> <span class="string">MyTestEc2Instance.PublicIp</span>&#125;</span><br><span class="line">    <span class="attr">Export:</span></span><br><span class="line">      <span class="attr">Name:</span> <span class="string">WebServerSubUrl</span></span><br><span class="line">  <span class="attr">WebServerJoinUrl:</span></span><br><span class="line">    <span class="attr">Description:</span> <span class="string">WebServerJoinUrl</span></span><br><span class="line">    <span class="attr">Value:</span> <span class="type">!Join</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="bullet">-</span> <span class="string">&#x27;http://&#x27;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="type">!GetAtt</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">MyTestEc2Instance</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">PublicIp</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#x27;:&#x27;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="type">!Sub</span> <span class="string">$&#123;webServerPort&#125;</span></span><br><span class="line">    <span class="attr">Export:</span></span><br><span class="line">      <span class="attr">Name:</span> <span class="string">WebServerJoinUrl</span></span><br></pre></td></tr></table></figure>




<p>可以通过【参数】查看用户堆栈的输入</p>
<p><img src="https://liuqianglong-blog.oss-cn-beijing.aliyuncs.com/img/image-20220401192853510.png"></p>
<p>通过【输出】查看Outputs</p>
<p><img src="https://liuqianglong-blog.oss-cn-beijing.aliyuncs.com/img/image-20220401192903030.png"></p>
<p>打开Web服务器的URL</p>
<p><img src="https://liuqianglong-blog.oss-cn-beijing.aliyuncs.com/img/image-20220401153720795.png"></p>
<h2 id="3、Python操作CloudFormation"><a href="#3、Python操作CloudFormation" class="headerlink" title="3、Python操作CloudFormation"></a>3、Python操作CloudFormation</h2><h3 id="3-1、凭证-Credentials"><a href="#3-1、凭证-Credentials" class="headerlink" title="3.1、凭证(Credentials)"></a>3.1、凭证(Credentials)</h3><h4 id="3-1-1、凭证介绍"><a href="#3-1-1、凭证介绍" class="headerlink" title="3.1.1、凭证介绍"></a>3.1.1、凭证介绍</h4><p>利用Python3的Boto3模块，就可以进行AWS上的所有API操作，具体可以参考<a target="_blank" rel="noopener" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/cloudformation.html">boto3 CloudFormaion</a>，查看API的详细参数。</p>
<p>客户端必须拥有凭证才能对AWS API进行操作，你可以通过多种方式来配置凭证。<strong>配置凭证的最佳实践是，如果你在EC2上运行代码，建议使用IAM角色。如果你是用AWS开发工具包（例如Python），建议使用共享凭证文件</strong>。</p>
<p>Boto3 搜索凭据的顺序参考：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1.在boto.client()方法中将凭据作为参数传递</span><br><span class="line">2.创建Session对象时将凭据作为参数传递</span><br><span class="line">3.环境变量</span><br><span class="line">4.共享凭证文件 ( ~&#x2F;.aws&#x2F;credentials )</span><br><span class="line">5.AWS 配置文件 ( ~&#x2F;.aws&#x2F;config )</span><br><span class="line">6.担任角色提供者</span><br><span class="line">7.Boto2 配置文件（&#x2F;etc&#x2F;boto.cfg和~&#x2F;.boto）</span><br><span class="line">8.配置了 IAM 角色的 Amazon EC2 实例上的实例元数据服务。</span><br></pre></td></tr></table></figure>


<h4 id="3-1-2、AWS-CLI配置凭证"><a href="#3-1-2、AWS-CLI配置凭证" class="headerlink" title="3.1.2、AWS CLI配置凭证"></a>3.1.2、AWS CLI配置凭证</h4><p><a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/cli/latest/userguide/getting-started-install.html">安装AWS CLI</a>客户端之后，可以利用<code>aws configure</code>快速配置凭证。需要提前从AWS控制台创建对应账号的AK(Access Key)和SK(Secret Key)。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ aws configure</span><br><span class="line">AWS Access Key ID [None]: AKIAIOSFODNN7EXAMPLE</span><br><span class="line">AWS Secret Access Key [None]: wJalrXUtnFEMI&#x2F;K7MDENG&#x2F;bPxRfiCYEXAMPLEKEY</span><br><span class="line">Default region name [None]: cn-northwest-1</span><br><span class="line">Default output format [None]: </span><br></pre></td></tr></table></figure>
<p>直接使用<code>aws configure</code>产生的是<code>default</code>配置文件，在没有明确指定配置文件时，就会使用default配置文件。你还可以使用<code>aws configure --profile cn-prod</code>来创建名称为cn-prod的配置文件。假设default配置的是测试账号信息，cn-prod配置的是生产账号信息，在不明确指定配置文件的情况下，代码会使用default配置，也就是测试环境的凭证。</p>
<p>配置凭证时，指定名称为<code>cn-prod</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ aws configure --profile cn-prod</span><br><span class="line">AWS Access Key ID [None]: AKIAI44QH8DHBEXAMPLE</span><br><span class="line">AWS Secret Access Key [None]: je7MtGbClwBF&#x2F;2Zp9Utk&#x2F;h3yCo8nvbEXAMPLEKEY</span><br><span class="line">Default region name [None]: cn-northwest-1</span><br><span class="line">Default output format [None]: </span><br></pre></td></tr></table></figure>
<p>AWS会将配置文件放在<code>.aws</code>文件夹中，这个文件夹默认在用户主目录下，例如Windows的路径<code>C:\Users\crosswalk\.aws</code>，Linux root用户路径<code>/root/.aws</code>。文件夹中会产生一个凭证配置文件<code>credentials</code>和一个Config配置文件<code>config</code>。</p>
<p>凭证配置文件<code>credentials</code>中具体的内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[default]</span><br><span class="line">aws_access_key_id&#x3D;AKIAIOSFODNN7EXAMPLE</span><br><span class="line">aws_secret_access_key&#x3D;wJalrXUtnFEMI&#x2F;K7MDENG&#x2F;bPxRfiCYEXAMPLEKEY</span><br><span class="line"></span><br><span class="line">[cn-prod]</span><br><span class="line">aws_access_key_id&#x3D;AKIAI44QH8DHBEXAMPLE</span><br><span class="line">aws_secret_access_key&#x3D;je7MtGbClwBF&#x2F;2Zp9Utk&#x2F;h3yCo8nvbEXAMPLEKEY</span><br></pre></td></tr></table></figure>
<p>Config配置文件<code>config</code>中的具体内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[default]</span><br><span class="line">region&#x3D;cn-northwest-1</span><br><span class="line"></span><br><span class="line">[profile cn-prod]</span><br><span class="line">region&#x3D;cn-northwest-1</span><br></pre></td></tr></table></figure>
<p>使用 <code>aws configure list-profiles</code> 命令列出所有配置文件名称。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\crosswalk&gt;aws configure list-profiles</span><br><span class="line">default</span><br><span class="line">cn-prod</span><br></pre></td></tr></table></figure>


<h4 id="3-1-3、AWS-CLI凭证测试"><a href="#3-1-3、AWS-CLI凭证测试" class="headerlink" title="3.1.3、AWS CLI凭证测试"></a>3.1.3、AWS CLI凭证测试</h4><p>使用默认凭证，查看测试账号下的EC2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\crosswalk&gt;aws ec2 describe-instances</span><br><span class="line">&#123;</span><br><span class="line">    &quot;Reservations&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;Groups&quot;: [],</span><br><span class="line">            &quot;Instances&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;AmiLaunchIndex&quot;: 0,</span><br><span class="line">                    &quot;ImageId&quot;: &quot;ami-007315f06e322f1ab&quot;,</span><br><span class="line">                    &quot;InstanceId&quot;: &quot;i-08fc1f70383191bb4&quot;,</span><br><span class="line">                    &quot;InstanceType&quot;: &quot;t2.2xlarge&quot;</span><br></pre></td></tr></table></figure>
<p>指定cn-prod凭证，查看生产账号下的EC2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\crosswalk&gt;aws ec2 describe-instances --profile cn-prod</span><br><span class="line">&#123;</span><br><span class="line">    &quot;Reservations&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;Groups&quot;: [],</span><br><span class="line">            &quot;Instances&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;AmiLaunchIndex&quot;: 0,</span><br><span class="line">                    &quot;ImageId&quot;: &quot;ami-7c9f8b1e&quot;,</span><br><span class="line">                    &quot;InstanceId&quot;: &quot;i-099540680995ce588&quot;,</span><br><span class="line">                    &quot;InstanceType&quot;: &quot;t2.medium&quot;,</span><br></pre></td></tr></table></figure>


<h4 id="3-1-4、boto3-切换凭证测试"><a href="#3-1-4、boto3-切换凭证测试" class="headerlink" title="3.1.4、boto3 切换凭证测试"></a>3.1.4、boto3 切换凭证测试</h4><p>你可以在创建Session时通过<code>profile_name</code>参数指定凭证配置文件名称，<a target="_blank" rel="noopener" href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/credentials.html">参考文档</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line">session = boto3.Session(profile_name=<span class="string">&#x27;dev&#x27;</span>)</span><br><span class="line">dev_s3_client = session.client(<span class="string">&#x27;s3&#x27;</span>)</span><br></pre></td></tr></table></figure>


<p>在创建脚本时，开头定义使用的凭证名称。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">profile_name = <span class="string">&#x27;cn-prod&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cft_create_stack</span>(<span class="params">stackname, file_path</span>):</span></span><br><span class="line">    <span class="keyword">import</span> boto3</span><br><span class="line">    session = boto3.Session(profile_name=profile_name)</span><br><span class="line">    client = session.client(<span class="string">&#x27;cloudformation&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">f&quot;<span class="subst">&#123;file_path&#125;</span>&quot;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;UTF-8&#x27;</span>) <span class="keyword">as</span> fd:     <span class="comment"># 读取CloudFormation YAML文件内容</span></span><br><span class="line">        templatebody = fd.read()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        client.create_stack(StackName=<span class="string">f&quot;<span class="subst">&#123;stackname&#125;</span>&quot;</span>, TemplateBody=templatebody)</span><br><span class="line">        print(<span class="string">f&#x27;[&quot;<span class="subst">&#123;stackname&#125;</span>&quot;堆栈创建成功]&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="string">f&#x27;[&quot;<span class="subst">&#123;stackname&#125;</span>&quot;堆栈创建失败]&#x27;</span>)</span><br><span class="line">        print(e)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    cft_create_stack(<span class="string">&#x27;vpc-stack-test&#x27;</span>, <span class="string">&#x27;vpc-test.yaml&#x27;</span>)</span><br></pre></td></tr></table></figure>


<h3 id="3-2、Python-Boto3操作CloudFormation代码参考"><a href="#3-2、Python-Boto3操作CloudFormation代码参考" class="headerlink" title="3.2、Python Boto3操作CloudFormation代码参考"></a>3.2、Python Boto3操作CloudFormation代码参考</h3><p><a target="_blank" rel="noopener" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/cloudformation.html#CloudFormation.Client.create_stack">boto3 cloudformation 官方文档</a></p>
<p>写一个用于测试脚本的CloudFormation模板<code>vpc-test.yaml</code>，创建一个VPC并且输出VPC的ID信息。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Resources:</span></span><br><span class="line">  <span class="attr">MyTestVpc:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::EC2::VPC</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">CidrBlock:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line">      <span class="attr">EnableDnsSupport:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">      <span class="attr">EnableDnsHostnames:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">      <span class="attr">Tags:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">Key:</span> <span class="string">Name</span></span><br><span class="line">         <span class="attr">Value:</span> <span class="string">MyTestVpc</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Outputs:</span></span><br><span class="line">  <span class="attr">MyTestVpc:</span></span><br><span class="line">    <span class="attr">Description:</span> <span class="string">MyTestVpc</span></span><br><span class="line">    <span class="attr">Value:</span> <span class="type">!Ref</span> <span class="string">MyTestVpc</span></span><br><span class="line">    <span class="attr">Export:</span></span><br><span class="line">      <span class="attr">Name:</span> <span class="string">MyTestVpc-ID</span></span><br></pre></td></tr></table></figure>


<h4 id="3-2-1、创建堆栈"><a href="#3-2-1、创建堆栈" class="headerlink" title="3.2.1、创建堆栈"></a>3.2.1、创建堆栈</h4><p>脚本需要指定堆栈的名称和模板的路径。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">profile_name = <span class="string">&#x27;cn-prod&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cfn_create_stack</span>(<span class="params">stackname, file_path</span>):</span></span><br><span class="line">    <span class="keyword">import</span> boto3</span><br><span class="line">    session = boto3.Session(profile_name=profile_name)</span><br><span class="line">    client = session.client(<span class="string">&#x27;cloudformation&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">f&quot;<span class="subst">&#123;file_path&#125;</span>&quot;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;UTF-8&#x27;</span>) <span class="keyword">as</span> fd:     <span class="comment"># 读取CloudFormation YAML文件内容</span></span><br><span class="line">        templatebody = fd.read()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        client.create_stack(StackName=<span class="string">f&quot;<span class="subst">&#123;stackname&#125;</span>&quot;</span>, TemplateBody=templatebody)</span><br><span class="line">        print(<span class="string">f&#x27;[&quot;<span class="subst">&#123;stackname&#125;</span>&quot;堆栈创建成功]&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="string">f&#x27;[&quot;<span class="subst">&#123;stackname&#125;</span>&quot;堆栈创建失败]&#x27;</span>)</span><br><span class="line">        print(e)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    cfn_create_stack(<span class="string">&#x27;vpc-stack-test&#x27;</span>, <span class="string">&#x27;vpc-test.yaml&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>代码输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&quot;vpc-stack-test&quot;堆栈创建成功]</span><br></pre></td></tr></table></figure>


<h4 id="3-2-2、获取堆栈输出"><a href="#3-2-2、获取堆栈输出" class="headerlink" title="3.2.2、获取堆栈输出"></a>3.2.2、获取堆栈输出</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">profile_name = <span class="string">&#x27;cn-prod&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cfn_stack_output</span>(<span class="params">stackname</span>):</span>    <span class="comment"># 当堆栈完成后获取输出</span></span><br><span class="line">    <span class="keyword">import</span> time</span><br><span class="line">    <span class="keyword">import</span> boto3</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        nowtime = time.strftime(<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>, time.localtime())</span><br><span class="line">        session = boto3.Session(profile_name=profile_name)</span><br><span class="line">        client = session.client(<span class="string">&#x27;cloudformation&#x27;</span>)</span><br><span class="line">        response = client.describe_stacks(StackName=stackname)</span><br><span class="line">        <span class="keyword">if</span> response[<span class="string">&#x27;Stacks&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;StackStatus&#x27;</span>] == <span class="string">&#x27;CREATE_COMPLETE&#x27;</span>:</span><br><span class="line">            response = client.describe_stacks(StackName=stackname)</span><br><span class="line">            outputs = response[<span class="string">&quot;Stacks&quot;</span>][<span class="number">0</span>][<span class="string">&quot;Outputs&quot;</span>]</span><br><span class="line">            print(<span class="string">f&#x27;[<span class="subst">&#123;nowtime&#125;</span>] Stack Create Complete!&#x27;</span>)</span><br><span class="line">            <span class="comment"># print(outputs)</span></span><br><span class="line">            <span class="keyword">return</span> outputs</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br><span class="line">            print(<span class="string">f&#x27;[<span class="subst">&#123;nowtime&#125;</span>] Wait Stack Complete...&#x27;</span>)</span><br><span class="line">            </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># cft_create_stack(&#x27;vpc-stack-test&#x27;, &#x27;vpc-test.yaml&#x27;)</span></span><br><span class="line">    cfn_stack_output(<span class="string">&#x27;vpc-stack-test&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>代码输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[2022-04-02 11:51:26] Stack Create Complete!</span><br><span class="line">[&#123;&#39;OutputKey&#39;: &#39;MyTestVpc&#39;, &#39;OutputValue&#39;: &#39;vpc-0e764b67068222644&#39;, &#39;Description&#39;: &#39;MyTestVpc&#39;, &#39;ExportName&#39;: &#39;MyTestVpc-ID&#39;&#125;]</span><br></pre></td></tr></table></figure>


<h4 id="3-2-3、删除堆栈"><a href="#3-2-3、删除堆栈" class="headerlink" title="3.2.3、删除堆栈"></a>3.2.3、删除堆栈</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">profile_name = <span class="string">&#x27;cn-prod&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cfn_delete_stack</span>(<span class="params">stackname</span>):</span></span><br><span class="line">    <span class="keyword">import</span> boto3</span><br><span class="line">    session = boto3.Session(profile_name=profile_name)</span><br><span class="line">    client = session.client(<span class="string">&#x27;cloudformation&#x27;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        rsp = client.delete_stack(StackName=stackname)</span><br><span class="line">        print(<span class="string">f&#x27;[&quot;<span class="subst">&#123;stackname&#125;</span>&quot;堆栈删除成功]&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="string">f&#x27;[&quot;<span class="subst">&#123;stackname&#125;</span>&quot;堆栈删除失败]&#x27;</span>)</span><br><span class="line">        print(e)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># cft_create_stack(&#x27;vpc-stack-test&#x27;, &#x27;vpc-test.yaml&#x27;)</span></span><br><span class="line">    <span class="comment"># cfn_stack_output(&#x27;vpc-stack-test&#x27;)</span></span><br><span class="line">    cfn_delete_stack(<span class="string">&#x27;vpc-stack-test&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>代码输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&quot;vpc-stack-test&quot;堆栈删除成功]</span><br></pre></td></tr></table></figure>


<h2 id="4、参考文档"><a href="#4、参考文档" class="headerlink" title="4、参考文档"></a>4、参考文档</h2><ul>
<li>【AWS CloudFormation 用户指南】：<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/Welcome.html">https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/Welcome.html</a></li>
<li>【AWS Command Line Interface】：<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/cli/latest/userguide/getting-started-install.html">https://docs.aws.amazon.com/zh_cn/cli/latest/userguide/getting-started-install.html</a></li>
<li>【Boto3 CloudFormation】：<a target="_blank" rel="noopener" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/cloudformation.html">https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/cloudformation.html</a></li>
</ul>

    </div>
    
    <div class="post-footer">
        <div>
            
            转载声明：
            非商业转载请注明出处，商业转载请联系作者获得授权。
            
            
        </div>
        <div>
            
        </div>
    </div>
</article>
<div class="article-nav prev-next-wrap clearfix">
    
    
    <a href="/Cisco-StackWise-%E7%AE%80%E4%BB%8B.html" class="next-post btn btn-default" title='Cisco StackWise 简介'>
        <span class="hidden-lg">下一篇</span>
        <span class="hidden-xs">
            Cisco StackWise 简介</span><i class="fa fa-angle-right fa-fw"></i>
    </a>
    
</div>

<div id="comments">
    

<div id="vcomments" class="valine"></div>

<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>

<script>
new Valine({
    av: AV,
    el: '#vcomments',
    appId: 'stf5rGD17bcrWN1mvUT4pu8C-gzGzoHsz',
    appKey: 'r5qpzBWMAzt2hDAcDftecM1R',
    placeholder: '说点什么吧',
    notify: false,
    verify: false,
    avatar: 'mm',
    meta: 'nick'.split(','),
    pageSize: '10',
    path: window.location.pathname,
    lang: 'zh-CN'.toLowerCase()
})
</script>


</div>

                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">
            文章目录
        </h3>
        
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81CloudFormation-%E7%AE%80%E4%BB%8B"><span class="toc-text">1、CloudFormation 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1%E3%80%81AWS-Console-%E6%93%8D%E4%BD%9C%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-text">1.1、AWS Console 操作遇到的问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AF-CloudFormation"><span class="toc-text">1.2、什么是 CloudFormation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3%E3%80%81CloudFormation-%E6%A8%A1%E6%9D%BF%E4%BB%8B%E7%BB%8D"><span class="toc-text">1.3、CloudFormation 模板介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4%E3%80%81CloudFormation-%E6%A8%A1%E6%9D%BF%E5%AD%97%E6%AE%B5"><span class="toc-text">1.4、CloudFormation 模板字段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5%E3%80%81CloudFormation-%E8%B5%84%E6%BA%90%E5%AD%97%E6%AE%B5%E5%B1%9E%E6%80%A7"><span class="toc-text">1.5、CloudFormation 资源字段属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6%E3%80%81AWS-%E6%8E%A7%E5%88%B6%E5%8F%B0%E5%88%9B%E5%BB%BA%E5%A0%86%E6%A0%88-stack"><span class="toc-text">1.6、AWS 控制台创建堆栈(stack)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81CloudFormation%E6%A8%A1%E6%9D%BF%E8%BF%9B%E9%98%B6%E6%93%8D%E4%BD%9C"><span class="toc-text">2、CloudFormation模板进阶操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%E3%80%81%E6%A8%A1%E6%9D%BF%E8%B5%84%E6%BA%90%E5%B1%9E%E6%80%A7"><span class="toc-text">2.1、模板资源属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2%E3%80%81%E5%86%85%E9%83%A8%E5%87%BD%E6%95%B0%E4%BB%8B%E7%BB%8D"><span class="toc-text">2.2、内部函数介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Ref%E5%87%BD%E6%95%B0"><span class="toc-text">Ref函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Fn-GetAtt-%E5%87%BD%E6%95%B0"><span class="toc-text">Fn::GetAtt 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Fn-Select-%E5%87%BD%E6%95%B0"><span class="toc-text">Fn::Select 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Fn-GetAZs-%E5%87%BD%E6%95%B0"><span class="toc-text">Fn::GetAZs 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Fn-Base64-%E5%87%BD%E6%95%B0"><span class="toc-text">Fn::Base64 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Fn-Sub-%E5%87%BD%E6%95%B0"><span class="toc-text">Fn::Sub 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Fn-FindInMap-%E5%87%BD%E6%95%B0"><span class="toc-text">Fn::FindInMap 函数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3%E3%80%81Parameters-%E5%8F%82%E6%95%B0"><span class="toc-text">2.3、Parameters(参数)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4%E3%80%81Outputs-%E8%BE%93%E5%87%BA"><span class="toc-text">2.4、Outputs(输出)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5%E3%80%81Mappings-%E6%98%A0%E5%83%8F"><span class="toc-text">2.5、Mappings(映像)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6%E3%80%81%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%9B%B4%E5%8A%A0%E7%81%B5%E6%B4%BB%E7%9A%84%E6%A8%A1%E6%9D%BF"><span class="toc-text">2.6、创建一个更加灵活的模板</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81Python%E6%93%8D%E4%BD%9CCloudFormation"><span class="toc-text">3、Python操作CloudFormation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1%E3%80%81%E5%87%AD%E8%AF%81-Credentials"><span class="toc-text">3.1、凭证(Credentials)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-1%E3%80%81%E5%87%AD%E8%AF%81%E4%BB%8B%E7%BB%8D"><span class="toc-text">3.1.1、凭证介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-2%E3%80%81AWS-CLI%E9%85%8D%E7%BD%AE%E5%87%AD%E8%AF%81"><span class="toc-text">3.1.2、AWS CLI配置凭证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-3%E3%80%81AWS-CLI%E5%87%AD%E8%AF%81%E6%B5%8B%E8%AF%95"><span class="toc-text">3.1.3、AWS CLI凭证测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-4%E3%80%81boto3-%E5%88%87%E6%8D%A2%E5%87%AD%E8%AF%81%E6%B5%8B%E8%AF%95"><span class="toc-text">3.1.4、boto3 切换凭证测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2%E3%80%81Python-Boto3%E6%93%8D%E4%BD%9CCloudFormation%E4%BB%A3%E7%A0%81%E5%8F%82%E8%80%83"><span class="toc-text">3.2、Python Boto3操作CloudFormation代码参考</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1%E3%80%81%E5%88%9B%E5%BB%BA%E5%A0%86%E6%A0%88"><span class="toc-text">3.2.1、创建堆栈</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2%E3%80%81%E8%8E%B7%E5%8F%96%E5%A0%86%E6%A0%88%E8%BE%93%E5%87%BA"><span class="toc-text">3.2.2、获取堆栈输出</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-3%E3%80%81%E5%88%A0%E9%99%A4%E5%A0%86%E6%A0%88"><span class="toc-text">3.2.3、删除堆栈</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3"><span class="toc-text">4、参考文档</span></a></li></ol>
        
    </div>
</aside>
                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>
<a id="back-to-top" class="icon-btn hide">
    <i class="fa fa-chevron-up"></i>
</a>
    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
    访问量:
    <strong id="busuanzi_value_site_pv">
        <i class="fa fa-spinner fa-spin"></i>
    </strong>
    &nbsp; | &nbsp;
    访客数:
    <strong id="busuanzi_value_site_uv">
        <i class="fa fa-spinner fa-spin"></i>
    </strong>
    
</div>
            </div>
            <div class="col-sm-12">
                <span>Copyright &copy;
                    2021
                    
                </span> |
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> |
                <span>
                    Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a>
                </span>
            </div>
        </div>
    </div>
</div>



<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<script src="/js/app.js?rev=@@hash.js"></script>

</body>
</html>